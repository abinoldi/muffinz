#!/system/bin/sh

# ==========================================================
# ROBLOX MASS DOWNLOADER & INSTALLER (STAND-ALONE)
# ==========================================================

# Konfigurasi Lokasi
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
BASE_URL="http://43.134.116.2:5555/uploaded"

# Fungsi cek Root (Dibutuhkan untuk pm install silent)
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        echo "Silakan jalankan dengan: su -c 'sh $0'"
        exit 1
    fi
}

do_mass_process() {
    echo "=========================================="
    echo "    DOWNLOAD & INSTALLER OTOMATIS         "
    echo "=========================================="
    
    # Input Custom Jumlah
    echo -n "‚ùì Berapa total APK yang ingin di-download? : "
    read total_apk

    # Validasi input angka
    if ! [ "$total_apk" -eq "$total_apk" ] 2>/dev/null; then
        echo "‚ùå Error: Masukkan jumlah dalam angka!"
        return
    fi

    mkdir -p "$DOWNLOAD_DIR"
    echo "üìÇ Folder: $DOWNLOAD_DIR"
    echo "üöÄ Memulai proses untuk $total_apk APK..."

    for i in $(seq 1 "$total_apk"); do
        echo "------------------------------------------"
        APK_NAME="$i.apk"
        SAVE_PATH="$DOWNLOAD_DIR/$APK_NAME"
        URL="$BASE_URL/$APK_NAME"

        # 1. Download menggunakan CURL dengan progres bar
        if [ ! -f "$SAVE_PATH" ]; then
            echo "üì• Mengunduh $APK_NAME [$i/$total_apk]"
            curl -L --progress-bar "$URL" -o "$SAVE_PATH"
            
            if [ $? -ne 0 ]; then
                echo "‚ùå Gagal mengunduh $APK_NAME. Lewati..."
                continue
            fi
        else
            echo "‚úÖ $APK_NAME sudah ada, melewati unduhan."
        fi

        # 2. Install menggunakan Package Manager (PM)
        if [ -f "$SAVE_PATH" ]; then
            echo "‚è≥ Memasang $APK_NAME secara silent..."
            # Flag -r untuk reinstall/replace jika sudah ada
            pm install -r "$SAVE_PATH" > /dev/null 2>&1
            
            if [ $? -eq 0 ]; then
                echo "‚úÖ $APK_NAME Berhasil terpasang."
            else
                echo "‚ùå $APK_NAME Gagal dipasang (Cek kompatibilitas APK)."
            fi
        fi
        
        # Jeda singkat agar sistem tidak overload
        sleep 1
    done

    echo "------------------------------------------"
    echo "‚ú® PROSES SELESAI!"
    echo "üí° Apakah ingin menghapus file APK di folder Download? (y/n): "
    read del_confirm
    if [ "$del_confirm" = "y" ] || [ "$del_confirm" = "Y" ]; then
        rm -rf "$DOWNLOAD_DIR"/*.apk
        echo "üóëÔ∏è  File APK dibersihkan."
    fi
}

# Jalankan skrip
check_root
do_mass_process
