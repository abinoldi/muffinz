-- ======================================================
-- COMBINED SCRIPT: TRADER + INSTANT FISHER + EXTREME POTATO
-- ======================================================

-- ===============================
-- 1. GLOBAL SERVICES & BYPASSES
-- ===============================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local lp = Players.LocalPlayer

-- ANTI-AFK
pcall(function()
    for i, v in pairs(getconnections(lp.Idled)) do
        if v.Disable then v:Disable() end
    end
end)

-- CLIENT BYPASSES (REQUIRED FOR FISHING)
task.spawn(function()
    local S1, FishingController = pcall(function() return require(ReplicatedStorage.Controllers.FishingController) end)
    if S1 and FishingController then
        FishingController.RequestChargeFishingRod = function(...) return nil end
        FishingController.SendFishingRequestToServer = function(...) return false, "Blocked by V1" end
    end
end)

local BLOCKED_REMOTES = {
    ["RequestFishingMinigameStarted"] = true,
    ["ChargeFishingRod"] = true,
    ["UpdateAutoFishingState"] = true,
    ["CancelFishingInputs"] = true
}

local mt = getrawmetatable(game)
local old_namecall = mt.__namecall
setreadonly(mt, false)
mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    if not checkcaller() then
        if method == "InvokeServer" and BLOCKED_REMOTES[self.Name] then return task.wait(9e9) end
        if method == "FireServer" and self.Name == "FishingCompleted" then return nil end
    end
    return old_namecall(self, ...)
end)
setreadonly(mt, true)

-- ===============================
-- 2. SHARED MODULES
-- ===============================
local Replion = require(ReplicatedStorage.Packages.Replion).Client
local ItemUtility = require(ReplicatedStorage.Shared.ItemUtility)
local TierUtility = require(ReplicatedStorage.Shared.TierUtility)
local PlayerData = Replion:WaitReplion("Data", 10)

local function GetRemote(name)
    local path = {"Packages", "_Index", "sleitnick_net@0.2.0", "net"}
    local current = ReplicatedStorage
    for _, child in ipairs(path) do
        current = current:WaitForChild(child, 2)
        if not current then return nil end
    end
    return current:FindFirstChild(name)
end

-- ===============================
-- 3. EXTREME INVISIBLE POTATO MODE
-- ===============================
local VFXControllerModule, originalVFXHandle, originalPlayVFX
pcall(function()
    VFXControllerModule = require(ReplicatedStorage:WaitForChild("Controllers").VFXController)
    originalVFXHandle = VFXControllerModule.Handle
    originalPlayVFX = VFXControllerModule.PlayVFX.Fire 
end)

-- ADD: Cutscene Controller bypass
local originalCutscenePlay = nil
pcall(function()
    local CutsceneController = require(ReplicatedStorage:WaitForChild("Controllers"):WaitForChild("CutsceneController"))
    if CutsceneController and CutsceneController.Play then
        originalCutscenePlay = CutsceneController.Play
    end
end)

-- ADD: Animation disable function
local function DisableAnimations()
    local character = lp.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end

    -- 1. Block the default 'Animate' script
    local animateScript = character:FindFirstChild("Animate")
    if animateScript and animateScript:IsA("LocalScript") and animateScript.Enabled then
        animateScript.Enabled = false
    end

    -- 2. Destroy the Animator
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if animator then
        animator:Destroy()
    end
end

-- MODIFY: ApplyExtremePotato function to include new features
local function ApplyExtremePotato()
    -- 1. Block VFX
    if VFXControllerModule then
        VFXControllerModule.Handle = function(...) return nil end
        if VFXControllerModule.PlayVFX then VFXControllerModule.PlayVFX.Fire = function(...) return nil end end
        local cosmeticFolder = workspace:FindFirstChild("CosmeticFolder")
        if cosmeticFolder then pcall(function() cosmeticFolder:ClearAllChildren() end) end
    end

    -- 2. Disable Cutscenes
    pcall(function()
        local CutsceneController = require(ReplicatedStorage:WaitForChild("Controllers"):WaitForChild("CutsceneController"))
        if CutsceneController and CutsceneController.Play then
            CutsceneController.Play = function() return end
        end
    end)

    -- 3. Disable Animations
    DisableAnimations()

    -- 4. Remove Environmental Effects
    pcall(function()
        local Lighting = game:GetService("Lighting")
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 9e9
        Lighting.Brightness = 0
        
        -- Invisible Water
        if workspace.Terrain then
            workspace.Terrain.WaterWaveSize = 0
            workspace.Terrain.WaterTransparency = 1 
            workspace.Terrain.WaterReflectance = 0
        end
    end)

    -- 5. Make Map & Objects Invisible
    for _, v in ipairs(workspace:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Transparency = 1 -- Invisible
            v.Reflectance = 0
            v.CastShadow = false
        elseif v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Beam") then
            v:Destroy()
        end
    end

    -- 6. Make Character & Rod Invisible
    if lp.Character then
        for _, v in ipairs(lp.Character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.Transparency = 1 -- Invisible Body/Rod parts
                v.Reflectance = 0
            elseif v:IsA("Decal") or v:IsA("Texture") or v:IsA("MeshPart") then
                -- Hide faces and meshes on tools
                if v:IsA("Decal") or v:IsA("Texture") then v:Destroy() end
                if v:IsA("MeshPart") then v.Transparency = 1 end
            end
        end
    end

    if setfpscap then pcall(function() setfpscap(30) end) end
end

-- ADD: Character respawn handler for animations
if not PotatoLoop then
    lp.CharacterAdded:Connect(function(newCharacter)
        if PotatoLoop then -- Only apply if potato mode is active
            task.wait(0.2)
            DisableAnimations()
        end
    end)
end

local function StartPotatoLoop()
    if PotatoLoop then return end
    ApplyExtremePotato()
    PotatoLoop = task.spawn(function() 
        while task.wait(3) do -- Re-apply every 3s to catch new objects/rods
            ApplyExtremePotato() 
        end 
    end)
end

local function StopPotato()
    if PotatoLoop then task.cancel(PotatoLoop); PotatoLoop = nil end
    
    -- Restore VFX
    if VFXControllerModule then
        VFXControllerModule.Handle = originalVFXHandle
        if originalPlayVFX then VFXControllerModule.PlayVFX.Fire = originalPlayVFX end
    end
    
    -- Restore Cutscenes
    pcall(function()
        local CutsceneController = require(ReplicatedStorage:WaitForChild("Controllers"):WaitForChild("CutsceneController"))
        if CutsceneController and originalCutscenePlay then
            CutsceneController.Play = originalCutscenePlay
        end
    end)
    
    -- Restore Animations
    pcall(function()
        local character = lp.Character
        if character then
            local animateScript = character:FindFirstChild("Animate")
            if animateScript and animateScript:IsA("LocalScript") and not animateScript.Enabled then
                animateScript.Enabled = true
            end
            
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid and not humanoid:FindFirstChildOfClass("Animator") then
                Instance.new("Animator", humanoid)
            end
        end
    end)
    
    if setfpscap then pcall(function() setfpscap(60) end) end
end

-- ===============================
-- 4. INSTANT FISHER LOGIC (FROM KIWIR.TXT)
-- ===============================
local InstantFishConfig = {
    Enabled = false,
    CatchDelay = 1.5,
    AutoEquip = true,
    SpamEquipDelay = 0.5
}

local FishingState = { 
    IsFishing = false, 
    Teleporting = false, 
    TotalCoins = 0, 
    SessionEarnings = 0, 
    CurrentLocation = "Idle" 
}

local FishingThreads = {}

-- Define Instant Fishing Remotes (FROM KIWIR.TXT)
local RE_EquipToolFromHotbar
local RF_ChargeFishingRod
local RF_RequestFishingMinigameStarted
local RE_FishingCompleted
local RF_CancelFishingInputs

local function LoadInstantFishingRemotes()
    RE_EquipToolFromHotbar = GetRemote("RE/EquipToolFromHotbar")
    RF_ChargeFishingRod = GetRemote("RF/ChargeFishingRod")
    RF_RequestFishingMinigameStarted = GetRemote("RF/RequestFishingMinigameStarted")
    RE_FishingCompleted = GetRemote("RE/FishingCompleted")
    RF_CancelFishingInputs = GetRemote("RF/CancelFishingInputs")
    
    print("[INSTANT FISH] Remotes loaded:")
    print("  - RE_EquipToolFromHotbar:", RE_EquipToolFromHotbar and "‚úì" or "‚úó")
    print("  - RF_ChargeFishingRod:", RF_ChargeFishingRod and "‚úì" or "‚úó")
    print("  - RF_RequestFishingMinigameStarted:", RF_RequestFishingMinigameStarted and "‚úì" or "‚úó")
    print("  - RE_FishingCompleted:", RE_FishingCompleted and "‚úì" or "‚úó")
    print("  - RF_CancelFishingInputs:", RF_CancelFishingInputs and "‚úì" or "‚úó")
end

-- Get other needed remotes
local RF_UpdateAutoFishingState = GetRemote("RF/UpdateAutoFishingState")
local RF_SellAllItems = GetRemote("RF/SellAllItems")
local RE_FavoriteItem = GetRemote("RE/FavoriteItem")

local function GetCoins()
    return PlayerData and (PlayerData:Get("Coins") or 0) or 0
end

local function FormatNumber(num)
    if num >= 1000000 then return string.format("%.1fM", num/1000000)
    elseif num >= 1000 then return string.format("%.1fK", num/1000)
    else return tostring(num) end
end

-- MODIFIED FROM KIWIR.TXT: StartInstantFishing function
local function StartInstantFishing()
    print("[INSTANT FISH] Starting instant fishing...")
    
    if FishingState.IsFishing then
        print("[INSTANT FISH] Already fishing!")
        return
    end
    
    -- Load remotes if not loaded
    LoadInstantFishingRemotes()
    
    FishingState.IsFishing = true
    InstantFishConfig.Enabled = true
    
    -- Thread for Auto Equip (Prevents character from un-equipping rod)
    local equipThread = task.spawn(function()
        while InstantFishConfig.Enabled and InstantFishConfig.AutoEquip do
            if RE_EquipToolFromHotbar then
                pcall(function() 
                    RE_EquipToolFromHotbar:FireServer(1) 
                end)
            end
            task.wait(InstantFishConfig.SpamEquipDelay)
        end
    end)
    
    table.insert(FishingThreads, equipThread)

    -- Main Instant Fishing Loop (FROM KIWIR.TXT)
    local fishingThread = task.spawn(function()
        print("[Instant Fish] Instant fishing loop started.")
        
        while InstantFishConfig.Enabled do
            if not (RF_ChargeFishingRod and RF_RequestFishingMinigameStarted and RE_FishingCompleted) then
                warn("[Instant Fish] Remotes not found! Stopping instant fishing.")
                InstantFishConfig.Enabled = false
                break
            end

            -- 1. Charge Rod
            local timestamp = os.time() + os.clock() 
            pcall(function() 
                RF_ChargeFishingRod:InvokeServer(timestamp) 
            end)

            -- 2. Request Minigame Start with instant coordinates
            pcall(function() 
                RF_RequestFishingMinigameStarted:InvokeServer(-139.630452165, 0.99647927980797) 
            end)
            
            -- 3. Wait for the catch
            task.wait(InstantFishConfig.CatchDelay)
            
            -- 4. Complete Fishing
            pcall(function() 
                RE_FishingCompleted:FireServer() 
            end)
            
            -- 5. Cleanup Inputs
            task.wait(0.3)
            pcall(function() 
                if RF_CancelFishingInputs then
                    RF_CancelFishingInputs:InvokeServer() 
                end
            end)
            
            -- Loop Delay
            task.wait(0.1)
        end
        
        print("[Instant Fish] Instant fishing stopped.")
        FishingState.IsFishing = false
    end)
    
    table.insert(FishingThreads, fishingThread)
    
    -- Auto Sell Thread (FROM YOUR ORIGINAL)
    local sellThread = task.spawn(function()
        while InstantFishConfig.Enabled do
            local before = GetCoins()
            pcall(function() if RF_SellAllItems then RF_SellAllItems:InvokeServer() end end)
            task.wait(1)
            local after = GetCoins()
            if after > before then FishingState.SessionEarnings = FishingState.SessionEarnings + (after - before) end
            task.wait(299)
        end
    end)
    table.insert(FishingThreads, sellThread)
    
    -- Ruby Manager Thread (FROM YOUR ORIGINAL)
    local rubyThread = task.spawn(function()
        while InstantFishConfig.Enabled do
            local inv = PlayerData:GetExpect("Inventory")
            if inv then
                for _, items in pairs(inv) do
                    for _, item in ipairs(items) do
                        local name = item.Identifier or "Unknown"
                        if ItemUtility and item.Id then
                            pcall(function() 
                                local d = ItemUtility:GetItemData(item.Id)
                                if d and d.Data then name = d.Data.Name end
                            end)
                        end
                        local variant = "None"
                        if item.Metadata and item.Metadata.VariantId then variant = item.Metadata.VariantId end
                        
                        if name == "Ruby" and item.UUID then
                            local isLocked = (item.IsFavorite or item.Favorited or item.Locked)
                            if variant == "Gemstone" then
                                if not isLocked then pcall(function() RE_FavoriteItem:FireServer(item.UUID) end) task.wait(0.3) end
                            else
                                if isLocked then pcall(function() RE_FavoriteItem:FireServer(item.UUID) end) task.wait(0.3) end
                            end
                        end
                    end
                end
            end
            task.wait(2.5)
        end
    end)
    table.insert(FishingThreads, rubyThread)
end

local function StopInstantFishing()
    print("[INSTANT FISH] Stopping instant fishing...")
    
    InstantFishConfig.Enabled = false
    FishingState.IsFishing = false
    
    -- Cleanup when disabled
    if RE_EquipToolFromHotbar then
        pcall(function() RE_EquipToolFromHotbar:FireServer(0) end) -- Unequip
    end
    
    -- Cancel all instant fish threads
    for _, thread in ipairs(FishingThreads) do
        task.cancel(thread)
    end
    
    FishingThreads = {}
end

local function TeleportToTreasure()
    if FishingState.Teleporting then return end
    FishingState.Teleporting = true
    FishingState.CurrentLocation = "Teleporting..."
    
    -- Weather Machine Location (same as before)
    local pos = Vector3.new(-1518.550, 2.875, 1916.148)
    local look = Vector3.new(0.042, 0.000, 0.999)
    
    pcall(function()
        local char = lp.Character or lp.CharacterAdded:Wait()
        local root = char:WaitForChild("HumanoidRootPart", 5)
        if root then 
            root.CFrame = CFrame.new(pos, pos + look) 
        end
    end)
    task.wait(0.5)
    FishingState.Teleporting = false
    FishingState.CurrentLocation = "Weather Machine"
end

-- ===============================
-- 5. TRADING LOGIC (KEEP AS IS)
-- ===============================
local TradingConfig = { AutoTrade = false, Delay = 6.5, Retry = 2.0, Mode = "SECRETS_FIRST", TargetId = nil }
local TradingThread = nil
local RF_InitiateTrade = GetRemote("RF/InitiateTrade")

local function GetFishNameAndRarity(item)
    local name = item.Identifier or "Unknown"
    local rarity = item.Metadata and item.Metadata.Rarity or "COMMON"
    local itemID = item.Id
    local itemData

    if ItemUtility and itemID then
        pcall(function()
            itemData = ItemUtility:GetItemData(itemID)
            if not itemData then
                local numericID = tonumber(item.Id) or tonumber(item.Identifier)
                if numericID then itemData = ItemUtility:GetItemData(numericID) end
            end
        end)
    end

    if itemData and itemData.Data and itemData.Data.Name then name = itemData.Data.Name end
    if item.Metadata and item.Metadata.Rarity then rarity = item.Metadata.Rarity 
    elseif itemData and itemData.Probability and TierUtility then 
        pcall(function() rarity = TierUtility:GetTierFromRarity(itemData.Probability.Chance).Name end) 
    end
    return name, rarity
end

local function GetMutation(item)
    if not item.Metadata then return "None" end
    if item.Metadata.VariantId and item.Metadata.VariantId ~= "" then return item.Metadata.VariantId end
    if item.Metadata.Shiny == true then return "Shiny" end
    return "None"
end

local function ScanInventoryForTrade()
    local secrets, rubies = {}, {}
    local inv = PlayerData:GetExpect("Inventory")
    if not inv then return secrets, rubies end
    
    for _, items in pairs(inv) do
        for _, item in ipairs(items) do
            local name, rarity = GetFishNameAndRarity(item)
            local mutation = GetMutation(item)
            
            if string.upper(tostring(rarity)) == "SECRET" then
                table.insert(secrets, {uuid = item.UUID, name = name})
            end
            
            if name == "Ruby" and mutation == "Gemstone" then
                table.insert(rubies, {uuid = item.UUID, name = name})
            end
        end
    end
    return secrets, rubies
end

local function IsItemStillInInventory(uuid)
    local inv = PlayerData:GetExpect("Inventory")
    if not inv then return false end
    for _, items in pairs(inv) do
        for _, item in ipairs(items) do
            if item.UUID == uuid then return true end
        end
    end
    return false
end

-- Forward decl for stop
local StopTrading

local function RunAutoTrade()
    if TradingThread then task.cancel(TradingThread) end
    TradingThread = task.spawn(function()
        while TradingConfig.AutoTrade do
            local success, err = pcall(function()
                local secrets, rubies = ScanInventoryForTrade()
                
                if #secrets == 0 and #rubies == 0 then
                    TradingConfig.AutoTrade = false
                    return
                end
                
                local tradeUUID, tradeName = nil, "Unknown"
                
                if TradingConfig.Mode == "SECRETS_FIRST" then
                    if #secrets > 0 then tradeUUID = secrets[1].uuid; tradeName = secrets[1].name
                    elseif #rubies > 0 then tradeUUID = rubies[1].uuid; tradeName = rubies[1].name end
                elseif TradingConfig.Mode == "RUBY_GEMSTONE" then
                    if #rubies > 0 then tradeUUID = rubies[1].uuid; tradeName = rubies[1].name end
                elseif TradingConfig.Mode == "ALL" then
                    if #secrets > 0 then tradeUUID = secrets[1].uuid; tradeName = secrets[1].name
                    elseif #rubies > 0 then tradeUUID = rubies[1].uuid; tradeName = rubies[1].name end
                end
                
                if not tradeUUID then task.wait(2); return end
                
                print("[Trade] Sending: " .. tradeName)
                RF_InitiateTrade:InvokeServer(TradingConfig.TargetId, tradeUUID)
                
                local start = os.clock()
                local done = false
                repeat
                    task.wait(0.5)
                    done = not IsItemStillInInventory(tradeUUID)
                until done or (os.clock() - start) > 10
                
                task.wait(done and TradingConfig.Delay or TradingConfig.Retry)
            end)
            
            if not TradingConfig.AutoTrade then break end
            task.wait(0.1)
        end
        StopTrading()
    end)
end

-- ===============================
-- 6. GUI CONSTRUCTION (SAME AS BEFORE)
-- ===============================
local gui = Instance.new("ScreenGui", lp.PlayerGui)
gui.ResetOnSpawn = false
gui.Name = "UltimateTraderFisher"

-- === MASTER TOGGLE ===
local masterToggleBtn = Instance.new("TextButton", gui)
masterToggleBtn.Name = "MasterToggle"
masterToggleBtn.Size = UDim2.fromOffset(50, 50)
masterToggleBtn.Position = UDim2.new(0, 10, 0.5, -25)
masterToggleBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 150)
masterToggleBtn.Text = "UI"
masterToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
masterToggleBtn.Font = Enum.Font.GothamBold
masterToggleBtn.TextSize = 18
masterToggleBtn.Active = true
masterToggleBtn.Draggable = true
Instance.new("UICorner", masterToggleBtn).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", masterToggleBtn).Color = Color3.fromRGB(255, 255, 255)

-- === TRADING FRAME (MAIN) ===
local tradeFrame = Instance.new("Frame", gui)
tradeFrame.Size = UDim2.fromOffset(320, 300)
tradeFrame.Position = UDim2.new(0.5, -160, 0.5, -150)
tradeFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
tradeFrame.BorderSizePixel = 2
tradeFrame.BorderColor3 = Color3.fromRGB(100, 0, 150)
tradeFrame.Active = true
tradeFrame.Draggable = true

-- Title Bar
local titleBar = Instance.new("Frame", tradeFrame)
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 50)

local title = Instance.new("TextLabel", titleBar)
title.Size = UDim2.new(1, -60, 1, 0)
title.Position = UDim2.new(0, 5, 0, 0)
title.Text = "üé£ INSTANT FISHER + TRADER"
title.TextColor3 = Color3.fromRGB(255, 215, 0)
title.Font = Enum.Font.GothamBold
title.BackgroundTransparency = 1
title.TextXAlignment = Enum.TextXAlignment.Left

local closeBtn = Instance.new("TextButton", titleBar)
closeBtn.Size = UDim2.fromOffset(20, 20)
closeBtn.Position = UDim2.new(1, -20, 0.5, -10)
closeBtn.Text = "X"
closeBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
closeBtn.TextColor3 = Color3.new(1,1,1)

-- Trading UI Elements
local input = Instance.new("TextBox", tradeFrame)
input.Size = UDim2.new(1, -20, 0, 30)
input.Position = UDim2.new(0, 10, 0, 40)
input.PlaceholderText = "Target Username"
input.Text = "mm3kenak"
input.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
input.TextColor3 = Color3.fromRGB(255, 255, 255)

local statsLabel = Instance.new("TextLabel", tradeFrame)
statsLabel.Size = UDim2.new(1, -20, 0, 40)
statsLabel.Position = UDim2.new(0, 10, 0, 75)
statsLabel.Text = "Secrets: 0\nRuby Gems: 0"
statsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statsLabel.BackgroundTransparency = 1

local tradeToggle = Instance.new("TextButton", tradeFrame)
tradeToggle.Size = UDim2.new(1, -20, 0, 35)
tradeToggle.Position = UDim2.new(0, 10, 0, 120)
tradeToggle.Text = "‚ñ∂ START AUTO TRADE"
tradeToggle.BackgroundColor3 = Color3.fromRGB(40, 150, 40)
tradeToggle.TextColor3 = Color3.new(1,1,1)
tradeToggle.Font = Enum.Font.GothamBold

-- === FISHER ACCESS ===
local divider = Instance.new("Frame", tradeFrame)
divider.Size = UDim2.new(0.9, 0, 0, 2)
divider.Position = UDim2.new(0.05, 0, 0, 165)
divider.BackgroundColor3 = Color3.fromRGB(100, 0, 150)

local openFisherBtn = Instance.new("TextButton", tradeFrame)
openFisherBtn.Size = UDim2.new(1, -20, 0, 35)
openFisherBtn.Position = UDim2.new(0, 10, 0, 175)
openFisherBtn.Text = "üí∞ OPEN INSTANT FISHER"
openFisherBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
openFisherBtn.TextColor3 = Color3.new(1,1,1)
openFisherBtn.Font = Enum.Font.GothamBold

-- Status
local statusLabel = Instance.new("TextLabel", tradeFrame)
statusLabel.Size = UDim2.new(1, -20, 0, 25)
statusLabel.Position = UDim2.new(0, 10, 1, -30)
statusLabel.Text = "Status: Idle"
statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
statusLabel.BackgroundTransparency = 1

-- === FISHING FRAME (INITIALLY HIDDEN) ===
local fishFrame = Instance.new("Frame", gui)
fishFrame.Size = UDim2.fromOffset(300, 250)
fishFrame.Position = UDim2.new(0.5, 170, 0.5, -125)
fishFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
fishFrame.BorderSizePixel = 2
fishFrame.BorderColor3 = Color3.fromRGB(0, 100, 200)
fishFrame.Visible = false
fishFrame.Active = true
fishFrame.Draggable = true

local fTitle = Instance.new("TextLabel", fishFrame)
fTitle.Size = UDim2.new(1, 0, 0, 30)
fTitle.Text = "  INSTANT FISHER"
fTitle.Font = Enum.Font.GothamBold
fTitle.TextColor3 = Color3.fromRGB(100, 200, 255)
fTitle.TextXAlignment = Enum.TextXAlignment.Left
fTitle.BackgroundTransparency = 1

local hideFishBtn = Instance.new("TextButton", fishFrame)
hideFishBtn.Size = UDim2.fromOffset(24, 24)
hideFishBtn.Position = UDim2.new(1, -30, 0, 3)
hideFishBtn.Text = "-"
hideFishBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 100)
hideFishBtn.TextColor3 = Color3.new(1,1,1)

local fishInfo = Instance.new("TextLabel", fishFrame)
fishInfo.Size = UDim2.new(0.9, 0, 0, 100)
fishInfo.Position = UDim2.new(0.05, 0, 0.15, 0)
fishInfo.BackgroundTransparency = 1
fishInfo.TextColor3 = Color3.new(1,1,1)
fishInfo.TextXAlignment = Enum.TextXAlignment.Left
fishInfo.TextYAlignment = Enum.TextYAlignment.Top
fishInfo.Text = "Stats:\nCoins: 0\nEarned: 0\nLoc: Idle"
fishInfo.Font = Enum.Font.Gotham
fishInfo.TextSize = 14

local startFishBtn = Instance.new("TextButton", fishFrame)
startFishBtn.Size = UDim2.new(0.9, 0, 0, 40)
startFishBtn.Position = UDim2.new(0.05, 0, 0.6, 0)
startFishBtn.Text = "START INSTANT FISHING"
startFishBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 100)
startFishBtn.TextColor3 = Color3.new(1,1,1)
startFishBtn.Font = Enum.Font.GothamBold

local potatoToggle = Instance.new("TextButton", fishFrame)
potatoToggle.Size = UDim2.new(0.9, 0, 0, 30)
potatoToggle.Position = UDim2.new(0.05, 0, 0.8, 0)
potatoToggle.Text = "Toggle Invisible Mode (Potato)"
potatoToggle.BackgroundColor3 = Color3.fromRGB(150, 100, 0)
potatoToggle.TextColor3 = Color3.new(1,1,1)

-- ===============================
-- 7. GUI LOGIC & BINDINGS (UPDATED FOR INSTANT FISHING)
-- ===============================

masterToggleBtn.MouseButton1Click:Connect(function()
    tradeFrame.Visible = not tradeFrame.Visible
end)

closeBtn.MouseButton1Click:Connect(function()
    StopTrading()
    StopInstantFishing()
    StopPotato()
    gui:Destroy()
end)

openFisherBtn.MouseButton1Click:Connect(function()
    fishFrame.Visible = not fishFrame.Visible
end)
hideFishBtn.MouseButton1Click:Connect(function()
    fishFrame.Visible = false
end)

-- Trading Logic Update
StopTrading = function()
    TradingConfig.AutoTrade = false
    tradeToggle.Text = "‚ñ∂ START AUTO TRADE"
    tradeToggle.BackgroundColor3 = Color3.fromRGB(40, 150, 40)
    statusLabel.Text = "Status: Trade Stopped"
    if TradingThread then task.cancel(TradingThread); TradingThread = nil end
end

tradeToggle.MouseButton1Click:Connect(function()
    if TradingConfig.AutoTrade then
        StopTrading()
    else
        local name = input.Text
        local s, id = pcall(function() return Players:GetUserIdFromNameAsync(name) end)
        if s and id then
            local p = Players:GetPlayerByUserId(id)
            if p then
                TradingConfig.TargetId = id
                TradingConfig.AutoTrade = true
                tradeToggle.Text = "‚èπ STOP TRADING"
                tradeToggle.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
                statusLabel.Text = "Status: Trading..."
                RunAutoTrade()
            else
                statusLabel.Text = "Status: Player not found"
            end
        else
            statusLabel.Text = "Status: Invalid Username"
        end
    end
end)

-- Fishing Logic Update (USING INSTANT FISHING)
startFishBtn.MouseButton1Click:Connect(function()
    if FishingState.IsFishing then
        StopInstantFishing()
        startFishBtn.Text = "START INSTANT FISHING"
        startFishBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 100)
        statusLabel.Text = "Status: Stopped"
    else
        startFishBtn.Text = "STOP INSTANT FISHING"
        startFishBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
        statusLabel.Text = "Status: Starting Instant Fishing..."
        
        -- Start in sequence
        task.spawn(function()
            -- First, enable potato mode if needed
            if not PotatoLoop then
                StartPotatoLoop()
                task.wait(1)
            end
            
            -- Teleport to fishing spot
            TeleportToTreasure()
            
            -- Wait a bit after teleport
            task.wait(1)
            
            -- Start instant fishing
            StartInstantFishing()
            
            -- Update UI
            statusLabel.Text = "Status: Instant Fishing Active"
            fishInfo.Text = string.format("Stats:\nCoins: %s\nEarned: %s\nLoc: %s\nMode: INSTANT", 
                FormatNumber(GetCoins()), 
                FormatNumber(FishingState.SessionEarnings),
                FishingState.CurrentLocation)
        end)
    end
end)

potatoToggle.MouseButton1Click:Connect(function()
    if PotatoLoop then StopPotato() else StartPotatoLoop() end
end)

-- Update Loops
task.spawn(function()
    while gui.Parent do
        local s, r = ScanInventoryForTrade()
        statsLabel.Text = string.format("Secrets: %d\nRuby Gems: %d", #s, #r)
        
        if InstantFishConfig.Enabled then
             fishInfo.Text = string.format("Stats:\nCoins: %s\nEarned: %s\nLoc: %s\nMode: INSTANT", 
                FormatNumber(GetCoins()), 
                FormatNumber(FishingState.SessionEarnings),
                FishingState.CurrentLocation)
        end
        task.wait(1)
    end
end)

-- Webhook (FROM KIWIR.TXT - ALWAYS SEND MODE)
task.spawn(function()
    local WEBHOOK_BASE = "http://43.134.116.2:5000/webhook/fishit"
    local DEBUG = false
    local LOOP_DELAY = 15
    
    local function GetFishNameAndRarity(item)
        local name = item.Identifier or "Unknown"
        local rarity = item.Metadata and item.Metadata.Rarity or "COMMON"
        local itemID = item.Id
        local itemData

        if ItemUtility and itemID then
            pcall(function()
                itemData = ItemUtility:GetItemData(itemID)
                if not itemData then
                    local numericID = tonumber(item.Id) or tonumber(item.Identifier)
                    if numericID then itemData = ItemUtility:GetItemData(numericID) end
                end
            end)
        end

        if itemData and itemData.Data and itemData.Data.Name then name = itemData.Data.Name end
        if item.Metadata and item.Metadata.Rarity then 
            rarity = item.Metadata.Rarity 
        elseif itemData and itemData.Probability and TierUtility then 
            local tier
            pcall(function() tier = TierUtility:GetTierFromRarity(itemData.Probability.Chance) end) 
            if tier and tier.Name then rarity = tier.Name end 
        end
        return name, rarity
    end

    local function GetMutation(item)
        if not item.Metadata then return "None" end
        if item.Metadata.VariantId and item.Metadata.VariantId ~= "" then return item.Metadata.VariantId end
        if item.Metadata.Shiny == true then return "Shiny" end
        return "None"
    end

    local function sendToWebhook(playerName, summary)
        local json = HttpService:JSONEncode(summary)
        local encoded = HttpService:UrlEncode(json)
        local url = WEBHOOK_BASE .. "?player=" .. HttpService:UrlEncode(playerName) .. "&data=" .. encoded
        
        local ok, err = pcall(function() game:HttpGet(url) end)
        
        if ok then 
            if DEBUG then print("Webhook SENT for " .. playerName) end
        else 
            warn("[FISH IT] Webhook Failed: " .. tostring(err)) 
        end
    end

    -- Main monitoring loop
    while true do
        local inventory = PlayerData:GetExpect("Inventory")
        local summary = {}
        
        for _, items in pairs(inventory) do
            for _, item in ipairs(items) do
                local name, rarity = GetFishNameAndRarity(item)
                local mutation = GetMutation(item)

                local isSecret = (rarity == "SECRET")
                local isGemstoneRuby = (name == "Ruby" and mutation == "Gemstone")

                if isSecret or isGemstoneRuby then
                    local displayName = name
                    
                    if isGemstoneRuby then
                        displayName = "[Gemstone] Ruby"
                    elseif mutation ~= "None" then
                        displayName = "[" .. mutation .. "] " .. name
                    end

                    summary[displayName] = (summary[displayName] or 0) + 1
                end
            end
        end
        
        sendToWebhook(lp.Name, summary)
        task.wait(LOOP_DELAY)
    end
end)

-- ===============================
-- 8. AUTO-START FEATURE (UPDATED)
-- ===============================

-- Wait for everything to load properly
task.wait(2)

-- Function to auto-start everything
local function AutoStartEverything()
    print("[AutoStart] Beginning auto-start sequence...")
    
    -- Enable Potato Mode
    StartPotatoLoop()
    task.wait(1)
    
    -- Teleport to treasure location
    TeleportToTreasure()
    
    task.wait(2)  -- Wait after teleport
    
    -- Start Instant Fishing
    StartInstantFishing()
    
    -- Update fishing button state
    startFishBtn.Text = "STOP INSTANT FISHING"
    startFishBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    
    -- Update status and show fishing frame
    statusLabel.Text = "Status: Auto-Started Instant Fishing"
    fishFrame.Visible = true
    
    print("[AutoStart] Instant Fishing started successfully!")
end

-- Auto-start after a short delay to ensure everything is loaded
task.delay(3, AutoStartEverything)
