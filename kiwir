-- ===============================
-- 4. INSTANT FISHER LOGIC
-- ===============================
-- Adjusted for speed: CatchDelay 0.1 is "Instant". Increase if you get disconnected.
local FishingConfig = { Enabled = false, AutoEquip = true, CatchDelay = 0.15, SpamEquipDelay = 0.5 }
local FishingState = { IsFishing = false, Teleporting = false, TotalCoins = 0, SessionEarnings = 0, CurrentLocation = "Idle" }
local FishingThreads = {}

-- REMOTES (Using existing GetRemote function from Section 2)
local RF_ChargeFishingRod = GetRemote("RF/ChargeFishingRod")
local RF_RequestFishingMinigameStarted = GetRemote("RF/RequestFishingMinigameStarted")
local RE_FishingCompleted = GetRemote("RE/FishingCompleted")
local RF_CancelFishingInputs = GetRemote("RF/CancelFishingInputs")
local RE_EquipToolFromHotbar = GetRemote("RE/EquipToolFromHotbar")
local RF_UpdateAutoFishingState = GetRemote("RF/UpdateAutoFishingState")
local RF_SellAllItems = GetRemote("RF/SellAllItems")
local RE_FavoriteItem = GetRemote("RE/FavoriteItem")

local function GetCoins()
    return PlayerData and (PlayerData:Get("Coins") or 0) or 0
end

local function FormatNumber(num)
    if num >= 1000000 then return string.format("%.1fM", num/1000000)
    elseif num >= 1000 then return string.format("%.1fK", num/1000)
    else return tostring(num) end
end

local function StartFishingV1()
    if FishingState.IsFishing then return end
    FishingState.IsFishing = true
    FishingConfig.Enabled = true
    
    if RF_UpdateAutoFishingState then pcall(function() RF_UpdateAutoFishingState:InvokeServer(true) end) end
    
    -- 1. Auto Equip Thread
    local equipThread = task.spawn(function()
        while FishingConfig.Enabled do
            if FishingConfig.AutoEquip and RE_EquipToolFromHotbar then
                pcall(function() RE_EquipToolFromHotbar:FireServer(1) end)
            end
            task.wait(FishingConfig.SpamEquipDelay)
        end
    end)
    table.insert(FishingThreads, equipThread)
    
    -- 2. INSTANT FISHING LOOP
    local fishLoop = task.spawn(function()
        while FishingConfig.Enabled do
            -- A. Charge Rod
            local now = os.clock()
            pcall(function() 
                if RF_ChargeFishingRod then RF_ChargeFishingRod:InvokeServer(now) end
            end)

            -- B. Request Minigame (Instant Coords from your snippet)
            pcall(function() 
                if RF_RequestFishingMinigameStarted then 
                    RF_RequestFishingMinigameStarted:InvokeServer(-139.630452165, 0.99647927980797) 
                end
            end)

            -- C. Instant Catch Wait
            task.wait(FishingConfig.CatchDelay)

            -- D. Complete Fishing
            pcall(function() 
                if RE_FishingCompleted then RE_FishingCompleted:FireServer() end 
            end)

            -- E. Cleanup / Reset Inputs
            pcall(function() 
                if RF_CancelFishingInputs then RF_CancelFishingInputs:InvokeServer() end 
            end)
            
            task.wait(0.1) -- Tiny cooldown to prevent crash
        end
    end)
    table.insert(FishingThreads, fishLoop)

    -- 3. Auto Sell Thread (Kept from original)
    local sellThread = task.spawn(function()
        while FishingConfig.Enabled do
            local before = GetCoins()
            pcall(function() if RF_SellAllItems then RF_SellAllItems:InvokeServer() end end)
            task.wait(1)
            local after = GetCoins()
            if after > before then FishingState.SessionEarnings = FishingState.SessionEarnings + (after - before) end
            task.wait(299)
        end
    end)
    table.insert(FishingThreads, sellThread)
    
    -- 4. Ruby Manager Thread (Kept from original)
    local rubyThread = task.spawn(function()
        while FishingConfig.Enabled do
            local inv = PlayerData:GetExpect("Inventory")
            if inv then
                for _, items in pairs(inv) do
                    for _, item in ipairs(items) do
                        local name = item.Identifier or "Unknown"
                        if ItemUtility and item.Id then
                            pcall(function() 
                                local d = ItemUtility:GetItemData(item.Id)
                                if d and d.Data then name = d.Data.Name end
                            end)
                        end
                        local variant = "None"
                        if item.Metadata and item.Metadata.VariantId then variant = item.Metadata.VariantId end
                        
                        if name == "Ruby" and item.UUID then
                            local isLocked = (item.IsFavorite or item.Favorited or item.Locked)
                            if variant == "Gemstone" then
                                if not isLocked then pcall(function() RE_FavoriteItem:FireServer(item.UUID) end) task.wait(0.3) end
                            else
                                if isLocked then pcall(function() RE_FavoriteItem:FireServer(item.UUID) end) task.wait(0.3) end
                            end
                        end
                    end
                end
            end
            task.wait(2.5)
        end
    end)
    table.insert(FishingThreads, rubyThread)
end

local function StopFishingV1()
    FishingConfig.Enabled = false
    FishingState.IsFishing = false
    -- Cancel all threads (Equip, InstantFish, Sell, Ruby)
    for _, t in ipairs(FishingThreads) do task.cancel(t) end
    FishingThreads = {}
    
    if RF_UpdateAutoFishingState then pcall(function() RF_UpdateAutoFishingState:InvokeServer(false) end) end
    pcall(function() RE_EquipToolFromHotbar:FireServer(0) end)
    pcall(function() RF_CancelFishingInputs:InvokeServer() end)
end

local function TeleportToTreasure()
    if FishingState.Teleporting then return end
    FishingState.Teleporting = true
    FishingState.CurrentLocation = "Teleporting..."
    
    -- Changed to Weather Machine location
    local pos = Vector3.new(-1518.550, 2.875, 1916.148)
    local look = Vector3.new(0.042, 0.000, 0.999)
    
    pcall(function()
        local char = lp.Character or lp.CharacterAdded:Wait()
        local root = char:WaitForChild("HumanoidRootPart", 5)
        if root then 
            -- Create CFrame with position and look direction
            root.CFrame = CFrame.new(pos, pos + look) 
        end
    end)
    task.wait(0.5)
    FishingState.Teleporting = false
    FishingState.CurrentLocation = "Weather Machine"
end
