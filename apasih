--[[
    ENOCHHUB ULTIMATE - V5.1 (MANUAL SAVE & FIXES)
    - [FIX] Settings now load visually into Input fields correctly.
    - [FIX] Auto Save removed. Use the "Save Config" button.
    - [FIX] Auto Fav Ruby now starts automatically if enabled in config.
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local CollectionService = game:GetService("CollectionService")
local LocalPlayer = Players.LocalPlayer

-- ==========================================================
--  CONFIG & SAVE SYSTEM
-- ==========================================================
local FileName = "EnochHub_V5_Manual_Config.json"

local DefaultConfig = {
    -- Blatant (Kreinxy Settings)
    BlatantEnabled = false,
    AutoEquip = true,
    CompleteDelay = 0.705, 
    CancelDelay = 0.346,   
    
    -- Utilities
    AutoSellEnabled = false,
    AutoFavRubyEnabled = false,
    AntiAfkEnabled = true,
    
    -- Graphics
    PotatoModeEnabled = false,
    PotatoFPS = 60,

    -- Totem
    TotemType = "Luck Totem"
}

local Config = {}
for k,v in pairs(DefaultConfig) do Config[k] = v end

-- AUTO LOAD (On Script Start)
if isfile and isfile(FileName) then
    pcall(function()
        local decoded = HttpService:JSONDecode(readfile(FileName))
        for k, v in pairs(decoded) do Config[k] = v end
    end)
end

-- MANUAL SAVE FUNCTION
local function SaveSettings()
    if writefile then
        pcall(function() 
            writefile(FileName, HttpService:JSONEncode(Config)) 
        end)
    end
end

local function ResetConfig()
    if delfile and isfile(FileName) then delfile(FileName) end
    for k,v in pairs(DefaultConfig) do Config[k] = v end
    SaveSettings()
end

-- ==========================================================
--  WIND UI SETUP
-- ==========================================================
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "EnochHub | V5.1 (Manual Save)",
    Icon = "rbxassetid://130348378128532",
    Author = "EnochHub Standalone",
    Folder = "EnochHub",
    Size = UDim2.fromOffset(580, 480),
    Transparent = true,
    Theme = "Sky",
    Resizable = true,
})

local TabFish = Window:Tab({ Title = "Blatant", Icon = "anchor" })
local TabTotem = Window:Tab({ Title = "Totem", Icon = "box" })
local TabTp = Window:Tab({ Title = "Teleport", Icon = "map" })
local TabUtil = Window:Tab({ Title = "Utilities", Icon = "settings" }) 

_G.EnochHub_BlatantActive = false
_G.EnochHub_IsSelling = false 

-- ==========================================================
--  DATA & MODULES
-- ==========================================================
local Shared = ReplicatedStorage:WaitForChild("Shared")
local Packages = ReplicatedStorage:WaitForChild("Packages")

local ItemUtility = require(Shared:WaitForChild("ItemUtility"))
local Replion = require(Packages:WaitForChild("Replion")).Client

local function GetRemote(name)
    local path = {"Packages", "_Index", "sleitnick_net@0.2.0", "net"}
    local current = ReplicatedStorage
    for _, child in ipairs(path) do
        current = current:WaitForChild(child, 2)
        if not current then return nil end
    end
    return current:FindFirstChild(name)
end

local RF_ChargeFishingRod = GetRemote("RF/ChargeFishingRod")
local RF_RequestFishingMinigameStarted = GetRemote("RF/RequestFishingMinigameStarted")
local RE_FishingCompleted = GetRemote("RE/FishingCompleted")
local RF_CancelFishingInputs = GetRemote("RF/CancelFishingInputs")
local RE_EquipToolFromHotbar = GetRemote("RE/EquipToolFromHotbar")
local RF_SellAllItems = GetRemote("RF/SellAllItems")
local RE_FavoriteItem = GetRemote("RE/FavoriteItem")
local RF_UpdateAutoFishingState = GetRemote("RF/UpdateAutoFishingState")

local RE_SpawnTotem = GetRemote("RE/SpawnTotem")
local RF_EquipOxygenTank = GetRemote("RF/EquipOxygenTank")
local RF_UnequipOxygenTank = GetRemote("RF/UnequipOxygenTank")

-- ==========================================================
--  [HELPER] GET ITEM NAME
-- ==========================================================
local function GetItemName(item)
    if item.Name then return item.Name end
    if ItemUtility and item.Id then
        local success, itemData = pcall(function() return ItemUtility:GetItemData(item.Id) end)
        if success and itemData and itemData.Data and itemData.Data.Name then 
            return itemData.Data.Name 
        end
    end
    return item.Identifier or "Unknown"
end

-- ==========================================================
--  [CORE] LOGIC KILLER & VISUAL SPOOFING
-- ==========================================================
-- 1. Disable Client Fishing Controller Logic
task.spawn(function()
    local S1, FishingController = pcall(function() return require(game:GetService("ReplicatedStorage").Controllers.FishingController) end)
    if S1 and FishingController then
        local Old_Charge = FishingController.RequestChargeFishingRod
        local Old_Cast = FishingController.SendFishingRequestToServer
        FishingController.RequestChargeFishingRod = function(...)
            if _G.EnochHub_BlatantActive then return end 
            return Old_Charge(...)
        end
        FishingController.SendFishingRequestToServer = function(...)
            if _G.EnochHub_BlatantActive then return false, "Blocked by EnochHub" end
            return Old_Cast(...)
        end
    end
end)

-- 2. Hook Metatable
local mt = getrawmetatable(game)
local old_namecall = mt.__namecall
setreadonly(mt, false)
mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    if _G.EnochHub_BlatantActive and not checkcaller() then
        if method == "InvokeServer" and (self.Name == "RequestFishingMinigameStarted" or self.Name == "ChargeFishingRod" or self.Name == "UpdateAutoFishingState") then
            return nil 
        end
        if method == "FireServer" and self.Name == "FishingCompleted" then
            return nil
        end
    end
    return old_namecall(self, ...)
end)
setreadonly(mt, true)

-- 3. Visual Spoofing
local function SuppressGameVisuals(active)
    local Succ, TextController = pcall(function() return require(game.ReplicatedStorage.Controllers.TextNotificationController) end)
    if Succ and TextController then
        if active then
            if not TextController._OldDeliver then TextController._OldDeliver = TextController.DeliverNotification end
            TextController.DeliverNotification = function(self, data)
                if data and data.Text and (string.find(tostring(data.Text), "Auto Fishing") or string.find(tostring(data.Text), "Reach Level")) then return end
                return TextController._OldDeliver(self, data)
            end
        elseif TextController._OldDeliver then
            TextController.DeliverNotification = TextController._OldDeliver
            TextController._OldDeliver = nil
        end
    end

    if active then
        task.spawn(function()
            local InactiveColor = ColorSequence.new({ColorSequenceKeypoint.new(0, Color3.fromHex("ff5d60")), ColorSequenceKeypoint.new(1, Color3.fromHex("ff2256"))})
            while _G.EnochHub_BlatantActive do
                local targets = {}
                for _, btn in ipairs(CollectionService:GetTagged("AutoFishingButton")) do table.insert(targets, btn) end
                local guiBtn = LocalPlayer.PlayerGui:FindFirstChild("Backpack") and LocalPlayer.PlayerGui.Backpack:FindFirstChild("AutoFishingButton")
                if guiBtn then table.insert(targets, guiBtn) end
                for _, btn in ipairs(targets) do
                    local grad = btn:FindFirstChild("UIGradient")
                    if grad then grad.Color = InactiveColor end
                end
                RunService.RenderStepped:Wait()
            end
        end)
    end
end

-- ==========================================================
--  [FEATURE] BLATANT MODE
-- ==========================================================
local BlatantThread = nil
local EquipThread = nil
local phase = "STEP123"
local lastStepTime = 0

local function ForceStep123()
    task.spawn(function()
        pcall(function()
            RF_CancelFishingInputs:InvokeServer()
            RF_ChargeFishingRod:InvokeServer({ [1] = os.clock() })
            RF_RequestFishingMinigameStarted:InvokeServer(1, os.clock(), os.clock())
        end)
    end)
end

local function ForceStep4()
    task.spawn(function() pcall(function() RE_FishingCompleted:FireServer() end) end)
end

local function ToggleBlatant(state)
    _G.EnochHub_BlatantActive = state
    Config.BlatantEnabled = state
    -- NO SAVE SETTINGS HERE
    
    SuppressGameVisuals(state)

    if state then
        if RF_UpdateAutoFishingState then 
            pcall(function() RF_UpdateAutoFishingState:InvokeServer(true) end)
            task.wait(0.2)
            pcall(function() RF_UpdateAutoFishingState:InvokeServer(true) end)
        end

        if BlatantThread then task.cancel(BlatantThread) end
        phase = "INIT23"
        lastStepTime = os.clock()

        BlatantThread = task.spawn(function()
            while Config.BlatantEnabled do
                task.wait(0.01)
                if _G.EnochHub_IsSelling then
                    phase = "WAIT_STOP"; lastStepTime = os.clock(); task.wait(0.5); continue
                end

                local now = os.clock()
                if (now - lastStepTime) > 4 then phase = "STEP123" end

                if phase == "INIT23" or phase == "STEP123" then
                    lastStepTime = now; ForceStep123(); phase = "WAIT_COMPLETE"
                elseif phase == "WAIT_COMPLETE" then
                    if (now - lastStepTime) >= Config.CompleteDelay then phase = "STEP4" end
                elseif phase == "STEP4" then
                    lastStepTime = now; ForceStep4(); phase = "WAIT_STOP"
                elseif phase == "WAIT_STOP" then
                    if (now - lastStepTime) >= Config.CancelDelay then phase = "STEP123" end
                end
            end
        end)
        
        EquipThread = task.spawn(function()
            while Config.BlatantEnabled do
                if Config.AutoEquip and RE_EquipToolFromHotbar and not _G.EnochHub_IsSelling then 
                    pcall(function() RE_EquipToolFromHotbar:FireServer(1) end) 
                end
                task.wait(0.5)
            end
        end)
        WindUI:Notify({ Title = "Blatant", Content = "Enabled", Icon = "zap" })
    else
        if BlatantThread then task.cancel(BlatantThread) end
        if EquipThread then task.cancel(EquipThread) end
        phase = "STEP123"
        if RF_UpdateAutoFishingState then pcall(function() RF_UpdateAutoFishingState:InvokeServer(false) end) end
        pcall(function() RE_EquipToolFromHotbar:FireServer(0) end)
        pcall(function() RF_CancelFishingInputs:InvokeServer() end)
        WindUI:Notify({ Title = "Blatant", Content = "Disabled", Icon = "x" })
    end
end

-- ==========================================================
--  [FEATURE] AUTO FAVORITE RUBY (FIXED)
-- ==========================================================
local function ToggleAutoRuby(state)
    Config.AutoFavRubyEnabled = state
    -- NO SAVE SETTINGS HERE
    
    if state then
        task.spawn(function()
            while Config.AutoFavRubyEnabled do
                local r = Replion:WaitReplion("Data", 5)
                if r then
                    local success, inventory = pcall(function() return r:GetExpect("Inventory") end)
                    if success and inventory then
                        for _, items in pairs(inventory) do
                            for _, item in ipairs(items) do
                                local name = GetItemName(item)
                                if string.find(string.lower(name), "ruby") then
                                    local isFav = item.Favorited or item.Locked or false
                                    if not isFav then
                                        pcall(function() RE_FavoriteItem:FireServer(item.UUID) end)
                                        WindUI:Notify({ Title="Auto Favorite", Content="Favorited: "..name, Icon="star" })
                                        task.wait(0.2)
                                    end
                                end
                            end
                        end
                    end
                end
                task.wait(3) 
            end
        end)
    end
end

-- ==========================================================
--  UI BUILDING
-- ==========================================================
local SectFish = TabFish:Section({ Title = "Fishing", TextSize = 17 })

SectFish:Toggle({ Title = "Enable Blatant", Value = Config.BlatantEnabled, Callback = ToggleBlatant })
SectFish:Toggle({ Title = "Auto Equip", Value = Config.AutoEquip, Callback = function(v) Config.AutoEquip=v end })

SectFish:Input({ 
    Title = "Complete Delay", 
    Value = tostring(Config.CompleteDelay), -- CHANGED TO "Value" (Fixes loading issue)
    Placeholder = "0.705", 
    Numeric = true,
    Callback = function(text) 
        local n = tonumber(text)
        if n then Config.CompleteDelay = n end
    end 
})

SectFish:Input({ 
    Title = "Cancel Delay", 
    Value = tostring(Config.CancelDelay), -- CHANGED TO "Value"
    Placeholder = "0.346", 
    Numeric = true,
    Callback = function(text) 
        local n = tonumber(text)
        if n then Config.CancelDelay = n end
    end 
})

-- UTILITIES
local SectSystem = TabUtil:Section({ Title = "System", TextSize = 17 })

-- SAVE CONFIG BUTTON
SectSystem:Button({ 
    Title = "Save Config", 
    Icon = "save", 
    Callback = function() 
        SaveSettings()
        WindUI:Notify({Title="Config", Content="Settings Saved!", Icon="save"})
    end 
})

SectSystem:Toggle({ 
    Title="Auto Sell All", 
    Value=Config.AutoSellEnabled, 
    Callback=function(s) 
        Config.AutoSellEnabled=s 
        if s then 
            task.spawn(function() 
                while Config.AutoSellEnabled do 
                    if RF_SellAllItems then 
                        _G.EnochHub_IsSelling = true
                        pcall(function() RF_CancelFishingInputs:InvokeServer() end)
                        pcall(function() RE_EquipToolFromHotbar:FireServer(0) end)
                        task.wait(1.0) 
                        pcall(function() RF_SellAllItems:InvokeServer() end)
                        task.wait(0.5)
                        _G.EnochHub_IsSelling = false
                        if Config.BlatantEnabled and Config.AutoEquip then
                             pcall(function() RE_EquipToolFromHotbar:FireServer(1) end)
                        end
                        WindUI:Notify({Title="System", Content="Sold Items", Duration=1})
                    end 
                    task.wait(60) 
                end 
            end) 
        end 
    end 
})

SectSystem:Toggle({ 
    Title = "Auto Fav Ruby", 
    Value = Config.AutoFavRubyEnabled, 
    Callback = ToggleAutoRuby -- Call the function we defined earlier
})

SectSystem:Button({ Title="Reset Config", Icon="trash", Callback=function() ResetConfig(); WindUI:Notify({Title="Reset", Content="Done."}) end })

-- [INITIALIZATION CHECKS]
-- This ensures features start immediately if they were enabled in the config
if Config.BlatantEnabled then ToggleBlatant(true) end
if Config.AutoFavRubyEnabled then ToggleAutoRuby(true) end -- FIX: Force starts the loop

WindUI:Notify({ Title = "EnochHub", Content = "Loaded V5.1", Duration = 4, Icon = "check" })
