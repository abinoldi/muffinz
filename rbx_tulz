#!/system/bin/sh

# Konfigurasi Lokasi Backup
BACKUP_DIR="/sdcard/RobloxBackups"

# Fungsi untuk mengecek Root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "❌ Script ini MEMBUTUHKAN akses Root!"
        echo "Silakan jalankan dengan: su -c 'sh $0'"
        exit 1
    fi
}

# Fungsi Backup
do_backup() {
    echo "=========================================="
    echo "       MEMULAI PROSES BACKUP...           "
    echo "=========================================="
    
    # Buat folder backup jika belum ada
    mkdir -p "$BACKUP_DIR"
    
    # Loop mencari semua folder paket yang berawalan com.roblox.clien
    count=0
    for folder in /data/data/com.roblox.clien*; do
        # Lewati jika tidak ada folder yang cocok
        [ -e "$folder" ] || continue
        
        pkg_name=$(basename "$folder")
        
        # Cek dua kemungkinan lokasi Cookies (Default atau root webview)
        cookie_path=""
        if [ -f "$folder/app_webview/Default/Cookies" ]; then
            cookie_path="$folder/app_webview/Default/Cookies"
        elif [ -f "$folder/app_webview/Cookies" ]; then
            cookie_path="$folder/app_webview/Cookies"
        fi

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            echo "✅ Backup SUKSES: $pkg_name"
            count=$((count + 1))
        else
            echo "⚠️  SKIP: $pkg_name (File Cookies tidak ditemukan)"
        fi
    done
    
    echo "------------------------------------------"
    echo "Selesai! $count database tersimpan di:"
    echo "$BACKUP_DIR"
}

# Fungsi Restore
do_restore() {
    echo "=========================================="
    echo "       MEMULAI PROSES RESTORE...          "
    echo "=========================================="
    
    if [ ! -d "$BACKUP_DIR" ]; then
        echo "❌ Folder backup tidak ditemukan di $BACKUP_DIR"
        exit 1
    fi

    count=0
    for db_file in "$BACKUP_DIR"/com.roblox.clien*.db; do
        # Lewati jika folder kosong
        [ -e "$db_file" ] || continue

        filename=$(basename "$db_file")
        pkg_name="${filename%.db}"
        target_folder="/data/data/$pkg_name"
        
        # Tentukan target path (asumsi ke folder Default agar standar)
        # Kita buat strukturnya jika belum ada
        target_path="$target_folder/app_webview/Default/Cookies"
        target_dir_parent="$target_folder/app_webview/Default"

        if [ -d "$target_folder" ]; then
            # 1. Pastikan folder tujuan ada
            if [ ! -d "$target_dir_parent" ]; then
                mkdir -p "$target_dir_parent"
                # Set owner folder baru agar sesuai dengan aplikasi
                app_uid_folder=$(stat -c "%u:%g" "$target_folder")
                chown -R "$app_uid_folder" "$target_folder/app_webview"
            fi

            # 2. Copy file
            cp "$db_file" "$target_path"
            
            # 3. FIX PERMISSION (Sangat Penting)
            # Ambil UID:GID dari folder data aplikasi
            app_uid=$(stat -c "%u:%g" "$target_folder")
            
            # Terapkan owner ke file database
            chown "$app_uid" "$target_path"
            # Terapkan permission rw-rw---- (660)
            chmod 660 "$target_path"
            
            echo "✅ Restore SUKSES: $pkg_name (Perms Fixed)"
            count=$((count + 1))
        else
            echo "❌ GAGAL: Aplikasi $pkg_name belum terinstall."
        fi
    done

    echo "------------------------------------------"
    echo "Selesai! $count database berhasil dikembalikan."
}

# --- MAIN MENU ---
check_root

echo "=========================================="
echo "    ROBLOX CLONE COOKIE MANAGER (ROOT)    "
echo "=========================================="
echo "1. Backup Semua Akun (ke SDCard)"
echo "2. Restore Semua Akun (Fix Permissions)"
echo "3. Keluar"
echo -n "Pilih menu [1-3]: "
read choice

case $choice in
    1) do_backup ;;
    2) do_restore ;;
    3) echo "Keluar."; exit 0 ;;
    *) echo "Pilihan tidak valid."; exit 1 ;;
esac
