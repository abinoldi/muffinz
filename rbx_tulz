#!/data/data/com.termux/files/usr/bin/bash

# ==========================================================
# ROBLOX CLONE MANAGER v6.3 (PATH FIX + ROOT SAFE)
# ==========================================================

# --- [FIX MUTLAK] INJECT PATH AGAR ROOT BISA BACA PYTHON ---
export PATH="/data/data/com.termux/files/usr/bin:/data/data/com.termux/files/usr/bin/applets:$PATH"
export LD_LIBRARY_PATH="/data/data/com.termux/files/usr/lib"

# --- KONFIGURASI ---
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
GITHUB_PYTHON_URL="https://raw.githubusercontent.com/abinoldi/muffinz/main/downloader.py"
LOCAL_PYTHON_PATH="/data/data/com.termux/files/home/downloader.py"
GOFILE_URL="https://gofile.io/d/ewZLec"

export GF_DOWNLOAD_DIR="$DOWNLOAD_DIR"
export GF_MAX_CONCURRENT_DOWNLOADS=5
export GF_MAX_RETRIES=5

# --- WARNA ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

# --- FUNGSI SYSTEM ---

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "${RED}‚ùå Script ini MEMBUTUHKAN akses Root!${NC}"
        echo "üëâ Gunakan perintah tsu saat menjalankannya."
        exit 1
    fi
}

check_environment() {
    echo "üîç Memeriksa lingkungan sistem..."

    # Cek apakah Python terbaca oleh Root
    if ! command -v python3 > /dev/null 2>&1; then
        echo "${RED}‚ùå CRITICAL ERROR: Python tidak ditemukan oleh Root!${NC}"
        echo "${YELLOW}‚ö†Ô∏è Solusi:${NC} Keluar dari root, lalu jalankan: 'pkg install python'"
        echo "   Lalu jalankan script ini lagi."
        exit 1
    else
        echo "‚úÖ Python terdeteksi: $(which python3)"
    fi

    # Cek Module Requests
    if ! python3 -c "import requests" > /dev/null 2>&1; then
        echo "${YELLOW}üì¶ Modul 'requests' kurang. Mencoba install via pip root...${NC}"
        # Pip biasanya boleh dijalankan root (dengan warning), tidak seperti pkg
        pip install requests --break-system-packages > /dev/null 2>&1
        
        if ! python3 -c "import requests" > /dev/null 2>&1; then
             echo "${RED}‚ùå Gagal install requests. Install manual di Termux biasa!${NC}"
             exit 1
        fi
        echo "${GREEN}‚úÖ Modul requests berhasil diinstall.${NC}"
    fi
}

setup_downloader() {
    # Download script python jika belum ada
    if [ ! -f "$LOCAL_PYTHON_PATH" ]; then
        echo "‚òÅÔ∏è Mengambil script downloader dari GitHub..."
        curl -L -s "$GITHUB_PYTHON_URL" -o "$LOCAL_PYTHON_PATH"
        chmod +x "$LOCAL_PYTHON_PATH"
    fi
}

# --- FUNGSI INTI (BACKUP/RESTORE) ---

do_backup() {
    echo "=== BACKUP PROCESS ==="
    mkdir -p "$BACKUP_DIR"
    count=0
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg_name=$(basename "$folder")
        cookie_path=""
        [ -f "$folder/app_webview/Default/Cookies" ] && cookie_path="$folder/app_webview/Default/Cookies"
        [ -f "$folder/app_webview/Cookies" ] && [ -z "$cookie_path" ] && cookie_path="$folder/app_webview/Cookies"

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            echo "‚úÖ Backup: $pkg_name"
            count=$((count + 1))
        fi
    done
    echo "Selesai! $count database tersimpan."
}

do_restore_sequential() {
    echo "=== RESTORE SEQUENTIAL ==="
    # Fix untuk syntax array bash
    backups=($(ls -v "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null))
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))

    total_backups=${#backups[@]}
    total_pkgs=${#pkgs[@]}

    if [ "$total_backups" -eq 0 ]; then
        echo "${RED}‚ùå Data backup tidak ditemukan.${NC}"
        return 1
    fi

    i=0
    while [ $i -lt $total_backups ] && [ $i -lt $total_pkgs ]; do
        current_db="${backups[$i]}"
        current_pkg="${pkgs[$i]}"
        target_path="/data/data/$current_pkg/app_webview/Default/Cookies"

        echo "üîÑ Restore: $(basename "$current_db") -> $current_pkg"
        mkdir -p "$(dirname "$target_path")"
        cp "$current_db" "$target_path"
        
        # Permission Fix (Penting!)
        app_uid=$(stat -c "%u:%g" "/data/data/$current_pkg")
        chown -R "$app_uid" "/data/data/$current_pkg/app_webview"
        chmod 660 "$target_path"
        
        i=$((i + 1))
    done
    echo "‚úÖ Selesai!"
}

do_uninstall() {
    echo "=== UNINSTALL CLONES ==="
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    [ -z "$pkgs" ] && echo "‚ùå Tidak ada aplikasi." && return
    
    echo -n "‚ùì Yakin hapus SEMUA? (y/n): "
    read confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        for pkg in $pkgs; do
            pm uninstall "$pkg" > /dev/null 2>&1 && echo "‚úÖ $pkg Terhapus."
        done
    fi
}

do_auto_process() {
    echo "=========================================="
    echo "       PROSES OTOMATIS (ROOT v6.3)        "
    echo "=========================================="
    
    check_environment
    setup_downloader
    
    mkdir -p "$DOWNLOAD_DIR"

    echo "${CYAN}üöÄ Memulai Download via Python...${NC}"
    # Memanggil python dengan full path explicit untuk keamanan
    python3 "$LOCAL_PYTHON_PATH" "$GOFILE_URL"

    echo "------------------------------------------"
    echo "‚è≥ Memindai & Install APK..."
    
    count_files=$(find "$DOWNLOAD_DIR" -name "*.apk" | wc -l)
    
    if [ "$count_files" -eq 0 ]; then
        echo "${RED}‚ùå Tidak ada APK yang terdownload.${NC}"
        return
    fi

    find "$DOWNLOAD_DIR" -name "*.apk" | sort -V | while read apk_file; do
        echo "‚è≥ Memasang $(basename "$apk_file")..."
        pm install -r "$apk_file" > /dev/null 2>&1
    done

    do_restore_sequential
    echo "‚ú® SEMUA PROSES SELESAI!"
}

# --- MENU ---
check_root
while true; do
    echo ""
    echo "=========================================="
    echo "   ROBLOX MANAGER v6.3 (ROOT FIXED)       "
    echo "=========================================="
    echo "1. Backup Akun"
    echo "2. Restore Akun"
    echo "3. Hapus Clone"
    echo "4. AUTO (Download + Install + Restore)"
    echo "5. Keluar"
    echo "------------------------------------------"
    echo -n "Pilih menu [1-5]: "
    read choice
  
    case $choice in
        1) do_backup ;;
        2) do_restore_sequential ;;
        3) do_uninstall ;;
        4) do_auto_process ;;
        5) exit 0 ;;
        *) echo "‚ö†Ô∏è Pilihan salah." ;;
    esac
done
