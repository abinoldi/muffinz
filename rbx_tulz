#!/system/bin/sh

# ==========================================================
# ROBLOX CLONE MANAGER v3.6 (ADDED INSTALL ONLY MODE)
# ==========================================================

BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
BASE_URL="http://43.134.116.2:5555/uploaded"

# KONFIGURASI TIMEOUT
TIMEOUT_SEC=300

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        exit 1
    fi
}

do_backup() {
    echo "=========================================="
    echo "       MEMULAI PROSES BACKUP...           "
    echo "=========================================="
    mkdir -p "$BACKUP_DIR"
    count=0
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg_name=$(basename "$folder")
        
        cookie_file=""
        [ -f "$folder/app_webview/Default/Cookies" ] && cookie_file="$folder/app_webview/Default/Cookies"
        [ -f "$folder/app_webview/Cookies" ] && cookie_file="$folder/app_webview/Cookies"

        if [ -n "$cookie_file" ]; then
             cp "$cookie_file" "$BACKUP_DIR/${pkg_name}.db"
             count=$((count + 1))
        fi
    done
    echo "‚úÖ Backup Selesai! $count akun tersimpan."
}

do_restore_sequential() {
    echo ""
    echo "=========================================="
    echo "    RESTORE BERDASARKAN URUTAN (SEQ)      "
    echo "=========================================="
    backups=($(ls "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null))
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))

    total_backups=${#backups[@]}
    if [ "$total_backups" -eq 0 ]; then echo "‚ùå Tidak ada backup."; return 1; fi

    i=0
    while [ $i -lt $total_backups ] && [ $i -lt ${#pkgs[@]} ]; do
        current_db="${backups[$i]}"
        current_pkg="${pkgs[$i]}"
        target_dir="/data/data/$current_pkg/app_webview/Default"
        
        echo "üîÑ Restore: $current_pkg"
        mkdir -p "$target_dir"
        cp "$current_db" "$target_dir/Cookies"
        
        uid=$(stat -c "%u" "/data/data/$current_pkg")
        chown -R "$uid:$uid" "/data/data/$current_pkg/app_webview"
        chmod 660 "$target_dir/Cookies"
        
        i=$((i + 1))
    done
    echo "‚úÖ Restore Selesai."
}

do_uninstall() {
    echo "üóëÔ∏è Menghapus aplikasi..."
    for pkg in $(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"); do
        pm uninstall "$pkg" > /dev/null 2>&1
    done
    echo "‚úÖ Bersih."
}

do_auto_process() {
    echo "=========================================="
    echo "   üöÄ PROSES OTOMATIS (BACKUP -> INSTALL) "
    echo "=========================================="
    
    total_files=$(ls "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null | wc -l)
    if [ "$total_files" -eq 0 ]; then echo "‚ùå Tidak ada backup."; return; fi

    rm -rf "$DOWNLOAD_DIR"
    mkdir -p "$DOWNLOAD_DIR"

    echo "üì° Mendeteksi $total_files backup. Mulai download..."
    
    # DOWNLOAD LOOP
    for i in $(seq 1 "$total_files"); do
        APK_NAME="$i.apk"
        SAVE_PATH="$DOWNLOAD_DIR/$APK_NAME"
        echo -n "‚¨áÔ∏è  [$i/$total_files] Download $APK_NAME... "
        curl -L -f --retry 3 --retry-delay 2 -m $TIMEOUT_SEC "$BASE_URL/$APK_NAME" -o "$SAVE_PATH"
        if [ $? -eq 0 ]; then echo " ‚úÖ OK"; else echo " ‚ùå GAGAL"; fi
    done

    # INSTALL LOOP
    echo "üì¶ Menginstall..."
    for i in $(seq 1 "$total_files"); do
        APK_NAME="$i.apk"
        SAVE_PATH="$DOWNLOAD_DIR/$APK_NAME"
        if [ -f "$SAVE_PATH" ] && [ $(stat -c%s "$SAVE_PATH") -gt 1000 ]; then
            pm install -r "$SAVE_PATH" > /dev/null 2>&1
        fi
    done

    do_restore_sequential
    echo "‚ú® SELESAI!"
}

# --- FITUR BARU: DOWNLOAD & INSTALL ONLY ---
do_download_install_only() {
    echo "=========================================="
    echo "   üì• DOWNLOAD & INSTALL SAJA (NO RESTORE) "
    echo "=========================================="
    echo "‚ö†Ô∏è  Fitur ini akan mendownload APK dari 1.apk s/d N.apk"
    echo -n "üî¢ Masukkan jumlah clone yang mau diinstall: "
    read target_qty

    # Validasi input harus angka
    if ! [ "$target_qty" -eq "$target_qty" ] 2>/dev/null; then
        echo "‚ùå Input harus berupa angka!"
        return
    fi

    rm -rf "$DOWNLOAD_DIR"
    mkdir -p "$DOWNLOAD_DIR"

    echo "------------------------------------------"
    echo "üì° Target: $target_qty Aplikasi"
    
    # 1. DOWNLOAD PHASE
    for i in $(seq 1 "$target_qty"); do
        APK_NAME="$i.apk"
        SAVE_PATH="$DOWNLOAD_DIR/$APK_NAME"
        
        echo -n "‚¨áÔ∏è  [$i/$target_qty] Mendownload $APK_NAME... "
        curl -L -f --retry 3 --retry-delay 2 -m $TIMEOUT_SEC "$BASE_URL/$APK_NAME" -o "$SAVE_PATH"
        
        if [ $? -eq 0 ]; then
            echo " ‚úÖ Sukses."
        else
            echo " ‚ùå GAGAL! (Skip)"
        fi
    done

    echo "------------------------------------------"
    echo "üì¶ [PHASE 2] Menginstall Aplikasi..."
    
    installed_count=0
    for i in $(seq 1 "$target_qty"); do
        APK_NAME="$i.apk"
        SAVE_PATH="$DOWNLOAD_DIR/$APK_NAME"
        
        if [ -f "$SAVE_PATH" ] && [ $(stat -c%s "$SAVE_PATH") -gt 1000 ]; then
            echo "   üíø Menginstall $APK_NAME..."
            pm install -r "$SAVE_PATH" > /dev/null 2>&1
            installed_count=$((installed_count + 1))
        else
            echo "   ‚ö†Ô∏è File $APK_NAME tidak valid."
        fi
    done

    echo "‚ú® SELESAI! ($installed_count berhasil diinstall tanpa restore)"
}

# --- MAIN MENU ---
check_root
while true; do
    echo ""
    echo "=========================================="
    echo "    ROBLOX MANAGER v3.6 (SAFE MODE)       "
    echo "=========================================="
    echo "1. Backup Akun"
    echo "2. Restore Akun"
    echo "3. Hapus Semua Aplikasi"
    echo "4. AUTO PROCESS (Download + Install + Restore)"
    echo "5. DOWNLOAD & INSTALL SAJA (No Restore)"
    echo "6. Keluar"
    echo -n "Pilih: "
    read choice
    case $choice in
        1) do_backup ;;
        2) do_restore_sequential ;;
        3) do_uninstall ;;
        4) do_auto_process ;;
        5) do_download_install_only ;;
        6) exit 0 ;;
        *) echo "‚ö†Ô∏è Salah." ;;
    esac
done
