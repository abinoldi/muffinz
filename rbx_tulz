#!/system/bin/sh

# Konfigurasi Lokasi
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="uwNahlh"
GOFILE_URL="https://gofile.io/d/uwNalh"
GIT_REPO="https://github.com/ltsdw/gofile-downloader"

# Fungsi cek Root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "❌ Script ini MEMBUTUHKAN akses Root!"
        echo "Silakan jalankan dengan: su -c 'sh $0'"
        exit 1
    fi
}

# Fungsi 1: Backup
do_backup() {
    echo "=========================================="
    echo "       MEMULAI PROSES BACKUP...           "
    mkdir -p "$BACKUP_DIR"
    count=0
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg_name=$(basename "$folder")
        cookie_path=""
        if [ -f "$folder/app_webview/Default/Cookies" ]; then
            cookie_path="$folder/app_webview/Default/Cookies"
        elif [ -f "$folder/app_webview/Cookies" ]; then
            cookie_path="$folder/app_webview/Cookies"
        fi

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            echo "✅ Backup SUKSES: $pkg_name"
            count=$((count + 1))
        fi
    done
    echo "Selesai! $count database tersimpan."
}

# Fungsi 2: Restore
do_restore() {
    echo "=========================================="
    echo "       MEMULAI PROSES RESTORE...          "
    if [ ! -d "$BACKUP_DIR" ]; then
        echo "❌ Folder backup tidak ditemukan!"
        return 1
    fi
    count=0
    for db_file in "$BACKUP_DIR"/com.roblox.clien*.db; do
        [ -e "$db_file" ] || continue
        pkg_name=$(basename "$db_file" .db)
        target_folder="/data/data/$pkg_name"
        target_path="$target_folder/app_webview/Default/Cookies"
        
        if [ -d "$target_folder" ]; then
            mkdir -p "$(dirname "$target_path")"
            cp "$db_file" "$target_path"
            app_uid=$(stat -c "%u:%g" "$target_folder")
            chown "$app_uid" "$target_path"
            chmod 660 "$target_path"
            echo "✅ Restore SUKSES: $pkg_name"
            count=$((count + 1))
        fi
    done
}

# Fungsi 3: Download & Auto-Install
do_download_install() {
    echo "⏳ Cloning downloader..."
    [ -d "gofile-downloader" ] || git clone "$GIT_REPO"
    cd gofile-downloader || exit
    pip3 install -r requirements.txt
    python3 gofile-downloader.py "$GOFILE_URL"
    
    echo "⏳ Starting Python Auto-Installer..."
    python3 <<EOF
import os, subprocess
pkgs = subprocess.getoutput('pm list packages com.roblox.clien').split('\n')
installed_count = len([p for p in pkgs if p.strip()])
print(f"Found {installed_count} clones installed.")

for i in range(installed_count + 1, 9):
    apk = f"../$DOWNLOAD_DIR/{i}.apk"
    if os.path.exists(apk):
        print(f"Installing {apk}...")
        os.system(f"pm install {apk}")
    else:
        print(f"File {apk} not found, skipping.")
EOF
    cd ..
}

# Fungsi 4: Uninstall
do_uninstall() {
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    if [ -z "$pkgs" ]; then echo "❌ No clones found."; return; fi
    
    echo "⚠️ Yakin hapus SEMUA? (y/n)"
    read confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        for pkg in $pkgs; do
            echo "⏳ Menghapus $pkg..."
            pm uninstall "$pkg" > /dev/null 2>&1
        done
        echo "✨ Selesai."
    fi
}

# --- MAIN MENU ---
check_root 
while true; do 
    echo ""
    echo "1. Download & Install Clones (1-8)"
    echo "2. Backup Cookies"
    echo "3. Restore Cookies"
    echo "4. HAPUS SEMUA APP"
    echo "5. Keluar"
    printf "Pilih menu [1-5]: " 
    read choice

    case $choice in
        1) do_download_install ;;
        2) do_backup ;;
        3) do_restore ;;
        4) do_uninstall ;;
        5) exit 0 ;;
        *) echo "Pilihan salah." ;;
    esac
done
