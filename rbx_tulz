#!/system/sh

# Konfigurasi Lokasi Backup dan Download
BACKUP_DIR="/sdcard/RobloxBackups" [cite: 1]
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"

# Fungsi cek Root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then [cite: 1]
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!" [cite: 2]
        echo "Silakan jalankan dengan: su -c 'sh $0'" [cite: 3]
        exit 1 [cite: 3]
    fi
}

# Fungsi 1: Backup
do_backup() {
    echo "=========================================="
    echo "       MEMULAI PROSES BACKUP...           " [cite: 3]
    echo "=========================================="
    mkdir -p "$BACKUP_DIR" [cite: 3]
    count=0
    
    for folder in /data/data/com.roblox.clien*; do [cite: 3, 4]
        [ -e "$folder" ] || continue [cite: 4, 5]
        pkg_name=$(basename "$folder") [cite: 5]
        
        cookie_path=""
        if [ -f "$folder/app_webview/Default/Cookies" ]; then [cite: 5, 6]
            cookie_path="$folder/app_webview/Default/Cookies" [cite: 6]
        elif [ -f "$folder/app_webview/Cookies" ]; then [cite: 6, 7]
            cookie_path="$folder/app_webview/Cookies" [cite: 7]
        fi

        if [ -n "$cookie_path" ]; then [cite: 7, 8]
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db" [cite: 8]
            echo "‚úÖ Backup SUKSES: $pkg_name" [cite: 8]
            count=$((count + 1)) [cite: 8]
        else
            echo "‚ö†Ô∏è  SKIP: $pkg_name (File Cookies tidak ditemukan)" [cite: 8]
        fi
    done
    echo "------------------------------------------"
    echo "Selesai! $count database tersimpan di $BACKUP_DIR" [cite: 8]
}

# Fungsi 2: Restore
do_restore() {
    echo "=========================================="
    echo "       MEMULAI PROSES RESTORE...          " [cite: 9]
    echo "=========================================="
    if [ ! -d "$BACKUP_DIR" ]; then [cite: 9, 10]
        echo "‚ùå Folder backup tidak ditemukan!" [cite: 10]
        return 1 [cite: 11]
    fi

    count=0
    for db_file in "$BACKUP_DIR"/com.roblox.clien*.db; do [cite: 11, 12]
        [ -e "$db_file" ] || continue [cite: 12, 13]
        pkg_name=$(basename "$db_file" .db) [cite: 13]
        target_folder="/data/data/$pkg_name" [cite: 13]
        target_path="$target_folder/app_webview/Default/Cookies" [cite: 13]
        target_dir_parent="$target_folder/app_webview/Default" [cite: 13]

        if [ -d "$target_folder" ]; then [cite: 13, 14]
            if [ ! -d "$target_dir_parent" ]; then [cite: 14, 15]
                mkdir -p "$target_dir_parent" [cite: 15]
                app_uid_folder=$(stat -c "%u:%g" "$target_folder") [cite: 15]
                chown -R "$app_uid_folder" "$target_folder/app_webview" [cite: 15]
            fi

            cp "$db_file" "$target_path" [cite: 16]
            app_uid=$(stat -c "%u:%g" "$target_folder") [cite: 16]
            chown "$app_uid" "$target_path" [cite: 16]
            chmod 660 "$target_path" [cite: 16]
            
            echo "‚úÖ Restore SUKSES: $pkg_name" [cite: 16]
            count=$((count + 1)) [cite: 17]
        else
            echo "‚ùå GAGAL: $pkg_name belum terinstall." [cite: 17]
        fi
    done
    echo "------------------------------------------"
    echo "Selesai! $count database dikembalikan." [cite: 18]
}

# Fungsi 3: Uninstall
do_uninstall() {
    echo "=========================================="
    echo "       MENGHAPUS APLIKASI CLONE...        " [cite: 19]
    echo "=========================================="
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":") [cite: 19]

    if [ -z "$pkgs" ]; then [cite: 19, 20]
        echo "‚ùå Tidak ada aplikasi Roblox Clone yang terinstall." [cite: 20]
        return [cite: 21]
    fi

    echo "‚ö†Ô∏è  DAFTAR APLIKASI YANG AKAN DIHAPUS:"
    echo "$pkgs"
    echo "------------------------------------------"
    echo -n "‚ùì Yakin hapus SEMUA aplikasi di atas? (y/n): "
    read confirm

    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then [cite: 21, 22]
        for pkg in $pkgs; do [cite: 22]
            echo "‚è≥ Menghapus $pkg..." [cite: 23]
            pm uninstall "$pkg" > /dev/null 2>&1 [cite: 23]
            [ $? -eq 0 ] && echo "   ‚úÖ Terhapus." || echo "   ‚ùå Gagal menghapus." [cite: 23, 24, 25, 26]
        done
        echo "‚ú® Selesai. Semua bersih!" [cite: 26]
    else
        echo "üö´ Operasi dibatalkan." [cite: 27]
    fi
}

# Fungsi 4: Otomatisasi (New)
do_auto_process() {
    echo "=========================================="
    echo "       PROSES OTOMATIS BERJALAN           "
    echo "=========================================="

    # 1. Cek Data Backup
    if [ ! -d "$BACKUP_DIR" ]; then [cite: 10]
        echo "‚ùå Folder backup tidak ditemukan!"
        return
    fi
    
    backup_files=$(ls "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null)
    total_backup=$(echo "$backup_files" | wc -w)

    if [ "$total_backup" -eq 0 ]; then
        echo "‚ùå Tidak ada data backup untuk diproses."
        return
    fi
    echo "üì¶ Ditemukan $total_backup data akun terbackup."

    # 2. Download APK (Simulasi)
    mkdir -p "$DOWNLOAD_DIR"
    echo "üì• Mengunduh $total_backup APK..."
    for i in $(seq 1 "$total_backup"); do
        echo "   -> Menyiapkan APK ke-$i..."
        # Bagian ini bisa diisi dengan wget jika ada link download asli
        # wget -q "URL_SERVER/$i.apk" -O "$DOWNLOAD_DIR/$i.apk"
        sleep 1
    done

    # 3. Install Massal
    echo "üöÄ Memulai Instalasi Massal..."
    for i in $(seq 1 "$total_backup"); do
        if [ -f "$DOWNLOAD_DIR/$i.apk" ]; then
            echo "   ‚è≥ Memasang APK ke-$i..."
            pm install "$DOWNLOAD_DIR/$i.apk" > /dev/null 2>&1
        else
            echo "   ‚ö†Ô∏è APK $i.apk tidak ditemukan, melewati..."
        fi
    done

    # 4. Restore
    echo "üîß Memulai sinkronisasi data akun..."
    do_restore [cite: 29]
    echo "‚ú® SEMUA PROSES SELESAI!"
}

# --- MAIN MENU ---
check_root [cite: 27]

while true; do [cite: 27, 28]
    echo ""
    echo "=========================================="
    echo "    ROBLOX CLONE MANAGER v2.0 (ROOT)      " [cite: 28]
    echo "=========================================="
    echo "1. Backup Semua Akun (ke SDCard)" [cite: 28]
    echo "2. Restore Semua Akun (Fix Perms)" [cite: 28]
    echo "3. HAPUS SEMUA APP (Uninstall)" [cite: 28]
    echo "4. PROSES OTOMATIS (Download-Install-Restore)"
    echo "5. Keluar" [cite: 28]
    echo -n "Pilih menu [1-5]: " [cite: 28]
    read choice [cite: 28]

    case $choice in [cite: 28]
        1) do_backup ;; [cite: 28]
        2) do_restore ;; [cite: 29]
        3) do_uninstall ;; [cite: 29]
        4) do_auto_process ;;
        5) echo "Keluar."; exit 0 ;; [cite: 29]
        *) echo "Pilihan salah." ;; [cite: 29]
    esac
done [cite: 29]
