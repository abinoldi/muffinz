#!/bin/bash

# ==========================================================
# ROBLOX MANAGER v5.2 (PHASE SEPARATION: DL -> INSTALL)
# ==========================================================

# --- KONFIGURASI ---
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
GOFILE_URL="https://gofile.io/d/ewZLec"
TOKEN=""

# --- WARNA OUTPUT ---
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

_print() { echo -e "$1"; }

# ==========================================================
# BAGIAN 1: PARSING ENGINE (FIXED)
# ==========================================================

parse_json() {
    local key=$1
    local json=$2
    echo "$json" | sed -n 's/.*"'"$key"'":"\([^"]*\)".*/\1/p' | head -n 1
}

parse_children_ids() {
    # [CRITICAL FIX] 
    # Mengubah koma menjadi baris baru agar grep bisa membaca SEMUA ID (1-8)
    # Tanpa ini, grep akan berhenti di file pertama.
    echo "$1" | sed 's/,/\n/g' | grep -oP '"id":"\K[^"]+' | tail -n +2
}

setup_token() {
    if [ -z "$TOKEN" ]; then
        local response=$(curl -s -X POST https://api.gofile.io/accounts)
        TOKEN=$(parse_json "token" "$response")
    fi
}

# ==========================================================
# BAGIAN 2: DOWNLOAD PHASE
# ==========================================================

download_file() {
    local url="$1"
    local output_path="$2"
    local filename=$(basename "$output_path")
    
    if [ -s "$output_path" ]; then
        _print "   ‚è© Lewati: $filename (Sudah ada)"
        return
    fi

    _print "   ‚¨áÔ∏è Download: ${CYAN}$filename${NC}"
    curl -L -# --retry 3 -H "Authorization: Bearer $TOKEN" -o "$output_path" "$url"
}

fetch_contents() {
    local content_id="$1"
    local current_dir="$2"
    local password="$3"

    local api_url="https://api.gofile.io/contents/$content_id?cache=true"
    [ -n "$password" ] && api_url+="&password=$(echo -n $password | sha256sum | awk '{print $1}')"

    local response=$(curl -s -H "X-Website-Token: 4fd6sg89d7s6" -H "Authorization: Bearer $TOKEN" "$api_url")
    local type=$(parse_json "type" "$response")
    local name=$(parse_json "name" "$response")
    
    # Tentukan folder
    if [[ "$current_dir" == "$DOWNLOAD_DIR" ]] && [[ "$type" == "folder" ]]; then
         local target_path="$current_dir"
    else
         local target_path="$current_dir/$name"
    fi

    if [ "$type" == "folder" ]; then
        mkdir -p "$target_path"
        
        # Ambil SEMUA ID anak
        local ids=$(parse_children_ids "$response")
        
        # Loop Download
        for id in $ids; do
            fetch_contents "$id" "$target_path" "$password"
        done
    else
        local link=$(parse_json "link" "$response")
        download_file "$link" "$target_path"
    fi
}

# ==========================================================
# BAGIAN 3: UTILS & LOGIC
# ==========================================================

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        _print "${RED}‚ùå HARUS ROOT (Gunakan tsu)${NC}"
        exit 1
    fi
}

do_restore_sequential() {
    _print "\n${YELLOW}=== FASE 3: RESTORE AKUN ===${NC}"
    backups=($(ls -v "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null))
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))
    
    local count=0
    local max=${#backups[@]}
    [ ${#pkgs[@]} -lt $max ] && max=${#pkgs[@]}

    if [ $max -eq 0 ]; then
        _print "‚ùå Tidak ada data untuk direstore."
        return
    fi

    for ((i=0; i<max; i++)); do
        current_db="${backups[$i]}"
        current_pkg="${pkgs[$i]}"
        target_path="/data/data/$current_pkg/app_webview/Default/Cookies"
        
        _print "   üîÑ Restore: $(basename "$current_db") -> $current_pkg"
        
        mkdir -p "$(dirname "$target_path")"
        cp "$current_db" "$target_path"
        
        # Fix Permission
        uid=$(stat -c "%u:%g" "/data/data/$current_pkg")
        chown -R "$uid" "/data/data/$current_pkg/app_webview"
        chmod 660 "$target_path"
        count=$((count+1))
    done
    _print "‚úÖ Sukses restore $count akun."
}

do_backup() {
    _print "\n=== BACKUP ==="
    mkdir -p "$BACKUP_DIR"
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg=$(basename "$folder")
        [ -f "$folder/app_webview/Default/Cookies" ] && cp "$folder/app_webview/Default/Cookies" "$BACKUP_DIR/$pkg.db" && echo "‚úÖ $pkg"
    done
}

do_uninstall() {
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    [ -z "$pkgs" ] && return
    echo -n "‚ùì Hapus semua? (y/n): "
    read c
    if [[ "$c" == "y" ]]; then
        for p in $pkgs; do pm uninstall "$p" >/dev/null 2>&1 && echo "üóëÔ∏è $p"; done
    fi
}

# ==========================================================
# LOGIC UTAMA: DOWNLOAD DULU -> BARU INSTALL
# ==========================================================
do_auto_process() {
    _print "\n=========================================="
    _print "   PROSES OTOMATIS (TERPISAH)"
    _print "=========================================="
    
    mkdir -p "$DOWNLOAD_DIR"
    local content_id=$(echo "$GOFILE_URL" | grep -oE '[a-zA-Z0-9]+$' | tail -n 1)
    
    # --- FASE 1: DOWNLOAD ---
    _print "\n${YELLOW}=== FASE 1: DOWNLOAD SEMUA APK ===${NC}"
    _print "‚è≥ Sedang mengambil daftar file (Mohon tunggu)..."
    
    setup_token
    # Fungsi ini HANYA mendownload, tidak menginstall
    fetch_contents "$content_id" "$DOWNLOAD_DIR" ""
    
    # --- FASE 2: INSTALASI ---
    _print "\n${YELLOW}=== FASE 2: INSTALASI APK ===${NC}"
    
    # Cek jumlah file
    local count_files=$(ls "$DOWNLOAD_DIR"/*.apk 2>/dev/null | wc -l)
    
    if [ "$count_files" -eq 0 ]; then
        _print "${RED}‚ùå Tidak ada APK yang terdownload!${NC}"
        _print "   Cek koneksi internet atau URL Gofile."
        return
    fi
    
    _print "üìÇ Ditemukan $count_files APK. Memulai instalasi..."
    sleep 2

    # Loop install (Sortir angka: 1, 2, 3... 10)
    for apk in $(ls "$DOWNLOAD_DIR"/*.apk | sort -V); do
        _print "   üî® Memasang: ${GREEN}$(basename "$apk")${NC}..."
        pm install -r "$apk" > /dev/null 2>&1
    done

    # --- FASE 3: RESTORE ---
    do_restore_sequential
    
    _print "\n‚ú® SEMUA PROSES SELESAI!"
}

# --- MENU ---
check_root
while true; do
    echo ""
    echo "1. Backup"
    echo "2. Restore Only"
    echo "3. Hapus Clone"
    echo "4. AUTO (Download All -> Install All -> Restore)"
    echo "5. Exit"
    echo -n "Pilih: "
    read choice
    case $choice in
        1) do_backup ;;
        2) do_restore_sequential ;;
        3) do_uninstall ;;
        4) do_auto_process ;;
        5) exit 0 ;;
    esac
done
