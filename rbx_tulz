#!/bin/bash

# ==========================================================
# ROBLOX MANAGER v5.1 (BASH + FIX JSON PARSING)
# ==========================================================

# --- KONFIGURASI ---
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
GOFILE_URL="https://gofile.io/d/ewZLec"
TOKEN=""

# --- WARNA OUTPUT ---
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

_print() { echo -e "$1"; }

# ==========================================================
# BAGIAN 1: GOFILE DOWNLOADER ENGINE
# ==========================================================

parse_json() {
    local key=$1
    local json=$2
    # Mengambil value dari key JSON sederhana
    echo "$json" | sed -n 's/.*"'"$key"'":"\([^"]*\)".*/\1/p' | head -n 1
}

parse_children_ids() {
    # [FIX] Pecah baris panjang dengan sed agar grep tidak cut-off
    # Mengubah setiap koma (,) menjadi baris baru (\n) sebelum di-grep
    echo "$1" | sed 's/,/\n/g' | grep -oP '"id":"\K[^"]+' | tail -n +2
}

setup_token() {
    if [ -z "$TOKEN" ]; then
        _print "${YELLOW}üîë Meminta token akses tamu...${NC}"
        local response=$(curl -s -X POST https://api.gofile.io/accounts)
        TOKEN=$(parse_json "token" "$response")
        if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then 
            _print "${RED}‚ùå Gagal mendapatkan token.${NC}"
            exit 1
        fi
    fi
}

download_file() {
    local url="$1"
    local output_path="$2"
    local filename=$(basename "$output_path")
    
    # Cek apakah file sudah ada dan ukurannya > 0
    if [ -s "$output_path" ]; then
        _print "‚è© Skip (Sudah ada): $filename"
        return
    fi

    _print "‚¨áÔ∏è Download: ${GREEN}$filename${NC}"
    
    # Download dengan progress bar simple (-#)
    curl -L -# --retry 3 \
         -H "Authorization: Bearer $TOKEN" \
         -o "$output_path" \
         "$url"
}

fetch_contents() {
    local content_id="$1"
    local current_dir="$2"
    local password="$3"

    local api_url="https://api.gofile.io/contents/$content_id?cache=true"
    [ -n "$password" ] && api_url+="&password=$(echo -n $password | sha256sum | awk '{print $1}')"

    local response=$(curl -s -H "X-Website-Token: 4fd6sg89d7s6" -H "Authorization: Bearer $TOKEN" "$api_url")
    
    local status=$(parse_json "status" "$response")
    if [ "$status" != "ok" ]; then
        _print "${RED}‚ùå Gagal akses ID: $content_id${NC}"
        return
    fi

    local type=$(parse_json "type" "$response")
    local name=$(parse_json "name" "$response")
    
    # Atur path folder download
    if [[ "$current_dir" == "$DOWNLOAD_DIR" ]] && [[ "$type" == "folder" ]]; then
         local target_path="$current_dir"
    else
         local target_path="$current_dir/$name"
    fi

    if [ "$type" == "folder" ]; then
        mkdir -p "$target_path"
        _print "${YELLOW}üìÇ Scan Folder: $name${NC}"
        
        # [FIX] Menggunakan fungsi parse baru
        local ids=$(parse_children_ids "$response")
        
        # Loop download rekursif
        for id in $ids; do
            fetch_contents "$id" "$target_path" "$password"
        done
    else
        local link=$(parse_json "link" "$response")
        download_file "$link" "$target_path"
    fi
}

# ==========================================================
# BAGIAN 2: ROBLOX MANAGER UTILS
# ==========================================================

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        _print "${RED}‚ùå Script ini MEMBUTUHKAN akses Root!${NC}"
        _print "üëâ Ketik ${YELLOW}tsu${NC} dulu, baru jalankan script."
        exit 1
    fi
}

do_backup() {
    _print "\n=== MEMULAI BACKUP ==="
    mkdir -p "$BACKUP_DIR"
    count=0
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg_name=$(basename "$folder")
        cookie_path=""
        
        if [ -f "$folder/app_webview/Default/Cookies" ]; then
            cookie_path="$folder/app_webview/Default/Cookies"
        elif [ -f "$folder/app_webview/Cookies" ]; then
            cookie_path="$folder/app_webview/Cookies"
        fi

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            _print "‚úÖ Backup: $pkg_name"
            count=$((count + 1))
        fi
    done
    _print "Selesai! $count database tersimpan."
}

do_restore_sequential() {
    _print "\n=== RESTORE SEQUENTIAL ==="
    
    # Ambil list backup dan urutkan
    backups=($(ls -v "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null))
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))

    total_backups=${#backups[@]}
    total_pkgs=${#pkgs[@]}

    if [ "$total_backups" -eq 0 ] || [ "$total_pkgs" -eq 0 ]; then
        _print "${RED}‚ùå Backup atau Aplikasi tidak ditemukan.${NC}"
        return
    fi

    i=0
    while [ $i -lt $total_backups ] && [ $i -lt $total_pkgs ]; do
        current_db="${backups[$i]}"
        current_pkg="${pkgs[$i]}"
        
        target_folder="/data/data/$current_pkg"
        target_dir_parent="$target_folder/app_webview/Default"
        target_path="$target_dir_parent/Cookies"

        _print "üîÑ Restore [$(basename "$current_db")] -> [$current_pkg]"

        mkdir -p "$target_dir_parent"
        cp "$current_db" "$target_path"
        
        # Fix Permissions
        app_uid=$(stat -c "%u:%g" "$target_folder")
        if [ -n "$app_uid" ]; then
            chown -R "$app_uid" "$target_folder/app_webview"
            chmod 660 "$target_path"
        fi
        
        i=$((i + 1))
    done
    _print "‚úÖ Selesai! $i akun dipulihkan."
}

do_uninstall() {
    _print "\n=== HAPUS APLIKASI CLONE ==="
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    
    if [ -z "$pkgs" ]; then
        _print "${RED}‚ùå Tidak ada aplikasi terinstall.${NC}"
        return
    fi
    
    echo -n "‚ùì Yakin hapus SEMUA? (y/n): "
    read confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        for pkg in $pkgs; do
            pm uninstall "$pkg" > /dev/null 2>&1
            _print "üóëÔ∏è $pkg Terhapus."
        done
    fi
}

do_auto_process() {
    _print "\n=========================================="
    _print "   PROSES OTOMATIS (DOWNLOAD & INSTALL)   "
    _print "=========================================="
    
    mkdir -p "$DOWNLOAD_DIR"

    # 1. Download
    local content_id=$(echo "$GOFILE_URL" | grep -oE '[a-zA-Z0-9]+$' | tail -n 1)
    setup_token
    _print "üöÄ Memindai URL Gofile: $content_id"
    fetch_contents "$content_id" "$DOWNLOAD_DIR" ""
    
    _print "\n‚úÖ Download Selesai. Memulai Instalasi..."
    sleep 2

    # 2. Install (Menggunakan sort -V agar urutan 1.apk, 2.apk... 10.apk benar)
    # Pindah ke direktori download agar mudah diloop
    cd "$DOWNLOAD_DIR" || return

    # Cek apakah ada file apk
    if ! ls *.apk 1> /dev/null 2>&1; then
        _print "${RED}‚ùå Tidak ada file .apk di $DOWNLOAD_DIR${NC}"
        return
    fi

    for apk_file in $(ls *.apk | sort -V); do
        _print "‚è≥ Memasang: ${GREEN}$apk_file${NC}..."
        pm install -r "$apk_file" > /dev/null 2>&1
        if [ $? -eq 0 ]; then
             _print "   ‚îî‚îÄ Sukses."
        else
             _print "   ‚îî‚îÄ ${RED}Gagal install!${NC}"
        fi
    done

    # 3. Restore
    do_restore_sequential
    _print "‚ú® SEMUA PROSES SELESAI!"
}

# ==========================================================
# MAIN LOOP
# ==========================================================
check_root

while true; do
    echo ""
    _print "${GREEN}=== ROBLOX MANAGER v5.1 (FIXED) ===${NC}"
    echo "1. Backup Akun"
    echo "2. Restore Akun (Urutan Sequential)"
    echo "3. Hapus Semua Aplikasi Clone"
    echo "4. PROSES OTOMATIS (Download -> Install -> Restore)"
    echo "5. Keluar"
    echo "------------------------------------------"
    echo -n "Pilih menu [1-5]: "
    read choice
  
    case $choice in
        1) do_backup ;;
        2) do_restore_sequential ;;
        3) do_uninstall ;;
        4) do_auto_process ;;
        5) exit 0 ;;
        *) echo "‚ö†Ô∏è Pilihan salah." ;;
    esac
done
