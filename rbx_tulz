#!/system/bin/sh

# Konfigurasi Lokasi
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/data/data/com.termux/files/home/rbx_apks"
SERVER_URL="http://146.190.147.43:88"
SCRIPT_DIR="/data/data/com.termux/files/home"
LOG_FILE="/sdcard/RobloxAuto.log"

# Fungsi untuk log
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
    echo "$1"
}

# Fungsi cek Root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        log_message "‚ùå Script ini MEMBUTUHKAN akses Root!"
        echo "Silakan jalankan dengan: su -c 'sh $0'"
        exit 1
    fi
}

# Set PATH untuk root (Termux specific)
export PATH=/data/data/com.termux/files/usr/bin:$PATH

# Fungsi untuk menghitung jumlah cookies dalam database
count_cookies_in_db() {
    local db_file="$1"
    local count=0
    
    if [ ! -f "$db_file" ]; then
        echo 0
        return
    fi
    
    if command -v sqlite3 >/dev/null 2>&1; then
        count=$(sqlite3 "$db_file" "SELECT COUNT(*) FROM cookies;" 2>/dev/null || echo 0)
    fi
    
    echo "$count"
}

# Fungsi untuk menghitung jumlah file backup
count_backup_files() {
    if [ ! -d "$BACKUP_DIR" ]; then
        echo 0
        return 0
    fi
    
    # Hitung file .db yang ada di backup folder
    local count=$(ls "$BACKUP_DIR"/*.db 2>/dev/null | wc -l)
    echo $count
}

# Fungsi 1: Hitung jumlah aplikasi Roblox yang terinstall
count_installed_apps() {
    echo "=========================================="
    echo "   STEP 1: MENGHITUNG APLIKASI TERINSTALL"
    echo "=========================================="
    
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    app_count=$(echo "$pkgs" | wc -l)
    
    log_message "üîç Mencari aplikasi Roblox..."
    
    if [ -z "$pkgs" ]; then
        log_message "‚ÑπÔ∏è Tidak ada aplikasi Roblox yang terinstall!"
        echo 0
        return 0
    fi
    
    log_message "‚úÖ Ditemukan $app_count aplikasi Roblox:"
    counter=1
    for pkg in $pkgs; do
        log_message "   $counter. $pkg"
        counter=$((counter + 1))
    done
    
    echo $app_count
}

# Fungsi 2: Backup semua cookies
backup_all_cookies() {
    echo "=========================================="
    echo "   STEP 2: BACKUP SEMUA COOKIES"
    echo "=========================================="
    
    mkdir -p "$BACKUP_DIR"
    total_apps=0
    total_cookies=0
    backup_count=0
    
    log_message "üîç Mencari aplikasi Roblox untuk backup..."
    
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        total_apps=$((total_apps + 1))
        
        pkg_name=$(basename "$folder")
        cookie_path=""
        
        # Cari file cookies
        if [ -f "$folder/app_webview/Default/Cookies" ]; then
            cookie_path="$folder/app_webview/Default/Cookies"
            log_message "üìç $pkg_name: app_webview/Default/Cookies"
        elif [ -f "$folder/app_webview/Cookies" ]; then
            cookie_path="$folder/app_webview/Cookies"
            log_message "üìç $pkg_name: app_webview/Cookies"
        else
            log_message "‚ö†Ô∏è $pkg_name: Cookies tidak ditemukan"
        fi

        if [ -n "$cookie_path" ]; then
            backup_file="$BACKUP_DIR/${pkg_name}.db"
            
            # Backup file
            cp "$cookie_path" "$backup_file"
            
            # Hitung jumlah cookies
            cookie_count=$(count_cookies_in_db "$backup_file")
            total_cookies=$((total_cookies + cookie_count))
            
            log_message "‚úÖ Backup: $pkg_name ($cookie_count cookies)"
            backup_count=$((backup_count + 1))
        fi
    done
    
    if [ $backup_count -eq 0 ]; then
        log_message "‚ùå Tidak ada cookies yang berhasil dibackup!"
        echo 0
        return 0
    fi
    
    log_message "üìä BACKUP SELESAI: $backup_count/$total_apps apps, $total_cookies cookies"
    
    # Simpan jumlah backup ke file untuk referensi
    echo $backup_count > "$BACKUP_DIR/.backup_count"
    
    echo $backup_count
}

# Fungsi 3: Uninstall semua aplikasi
uninstall_all_apps() {
    echo "=========================================="
    echo "   STEP 3: UNINSTALL SEMUA APLIKASI"
    echo "=========================================="
    
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    total=$(echo "$pkgs" | wc -l)
    
    if [ -z "$pkgs" ]; then 
        log_message "‚ÑπÔ∏è Tidak ada app yang perlu diuninstall"
        echo 0
        return 0
    fi
    
    log_message "üóëÔ∏è Menghapus $total aplikasi..."
    
    uninstall_count=0
    for pkg in $pkgs; do
        log_message "   ‚è≥ Menghapus $pkg..."
        if pm uninstall "$pkg" > /dev/null 2>&1; then
            log_message "   ‚úÖ Berhasil dihapus"
            uninstall_count=$((uninstall_count + 1))
        else
            log_message "   ‚ùå Gagal menghapus $pkg"
        fi
        sleep 0.5
    done
    
    log_message "‚ú® UNINSTALL SELESAI: $uninstall_count/$total apps dihapus"
    echo $uninstall_count
}

# Fungsi 4: Download APK dari server berdasarkan jumlah backup
download_apk_from_server() {
    local app_count=$1
    echo "=========================================="
    echo "   STEP 4: DOWNLOAD APK DARI SERVER"
    echo "=========================================="
    
    # Validasi input
    if [ -z "$app_count" ] || ! [[ "$app_count" =~ ^[0-9]+$ ]] || [ "$app_count" -lt 1 ] || [ "$app_count" -gt 8 ]; then
        log_message "‚ùå ERROR: Jumlah app tidak valid: '$app_count' (harus 1-8)"
        return 1
    fi
    
    # Buat folder download jika belum ada
    mkdir -p "$DOWNLOAD_DIR"
    cd "$DOWNLOAD_DIR" || {
        log_message "‚ùå ERROR: Tidak bisa masuk ke folder $DOWNLOAD_DIR"
        return 1
    }
    
    # Hapus file APK lama jika ada
    rm -f *.apk 2>/dev/null
    
    log_message "üìÅ Folder download: $DOWNLOAD_DIR"
    log_message "üì° Server: $SERVER_URL"
    log_message "üì• Mendownload $app_count APK files..."
    
    downloaded_count=0
    failed_count=0
    
    for i in $(seq 1 $app_count); do
        apk_file="$i.apk"
        url="$SERVER_URL/$apk_file"
        
        echo ""
        echo "‚¨áÔ∏è  [$i/$app_count] Downloading $apk_file..."
        log_message "Downloading: $apk_file"
        
        # Coba download dengan wget atau curl
        download_success=false
        if command -v wget >/dev/null 2>&1; then
            if wget --timeout=30 --tries=3 --quiet "$url" -O "$apk_file" 2>/dev/null; then
                download_success=true
            fi
        elif command -v curl >/dev/null 2>&1; then
            if curl -L --connect-timeout 30 --max-time 60 --retry 3 --silent "$url" -o "$apk_file" 2>/dev/null; then
                download_success=true
            fi
        else
            log_message "‚ùå ERROR: Tidak ada wget atau curl!"
            return 1
        fi
        
        # Cek jika download berhasil
        if [ "$download_success" = true ] && [ -f "$apk_file" ] && [ -s "$apk_file" ]; then
            file_size=$(du -h "$apk_file" 2>/dev/null | cut -f1 || echo "?KB")
            log_message "‚úÖ Berhasil: $apk_file ($file_size)"
            downloaded_count=$((downloaded_count + 1))
        else
            log_message "‚ùå Gagal: $apk_file"
            rm -f "$apk_file" 2>/dev/null
            failed_count=$((failed_count + 1))
        fi
        
        # Jeda sebentar antar download
        sleep 1
    done
    
    echo ""
    log_message "üìä DOWNLOAD SELESAI: $downloaded_count berhasil, $failed_count gagal"
    
    if [ $downloaded_count -eq 0 ]; then
        log_message "‚ùå ERROR: Tidak ada file yang berhasil didownload!"
        return 1
    fi
    
    # Tampilkan file yang berhasil didownload
    echo ""
    echo "üìã File yang berhasil didownload:"
    ls -la *.apk 2>/dev/null || echo "   Tidak ada file .apk"
    
    return 0
}

# Fungsi 5: Install semua APK yang didownload
install_all_downloaded_apps() {
    local app_count=$1
    echo "=========================================="
    echo "   STEP 5: INSTALL SEMUA APK"
    echo "=========================================="
    
    # Validasi input
    if [ -z "$app_count" ] || ! [[ "$app_count" =~ ^[0-9]+$ ]] || [ "$app_count" -lt 1 ] || [ "$app_count" -gt 8 ]; then
        log_message "‚ùå ERROR: Jumlah app tidak valid: '$app_count'"
        return 1
    fi
    
    if [ ! -d "$DOWNLOAD_DIR" ]; then
        log_message "‚ùå ERROR: Folder download tidak ditemukan: $DOWNLOAD_DIR"
        return 1
    fi
    
    cd "$DOWNLOAD_DIR" || {
        log_message "‚ùå ERROR: Tidak bisa masuk ke folder $DOWNLOAD_DIR"
        return 1
    }
    
    log_message "üîß Memulai instalasi $app_count aplikasi..."
    
    installed_count=0
    failed_count=0
    
    for i in $(seq 1 $app_count); do
        apk_file="$i.apk"
        
        if [ ! -f "$apk_file" ]; then
            log_message "‚ö†Ô∏è File tidak ditemukan: $apk_file"
            failed_count=$((failed_count + 1))
            continue
        fi
        
        # Tentukan nama package
        if [ $i -eq 1 ]; then
            pkg_name="com.roblox.client"
        else
            pkg_name="com.roblox.clien$i"
        fi
        
        echo ""
        echo "üì¶ [$i/$app_count] Menginstall $apk_file..."
        log_message "Installing: $apk_file -> $pkg_name"
        
        # Cek apakah sudah terinstall
        if pm list packages | grep -q "$pkg_name" 2>/dev/null; then
            log_message "‚ÑπÔ∏è Sudah terinstall: $pkg_name"
            installed_count=$((installed_count + 1))
            continue
        fi
        
        # Install APK
        if pm install "$apk_file" 2>/dev/null; then
            log_message "‚úÖ Berhasil: $pkg_name"
            installed_count=$((installed_count + 1))
            sleep 1
        else
            log_message "‚ùå Gagal: $apk_file"
            failed_count=$((failed_count + 1))
        fi
    done
    
    log_message "üìä INSTALASI SELESAI: $installed_count berhasil, $failed_count gagal"
    echo $installed_count
}

# Fungsi 6: Restore semua cookies
restore_all_cookies() {
    echo "=========================================="
    echo "   STEP 6: RESTORE SEMUA COOKIES"
    echo "=========================================="
    
    if [ ! -d "$BACKUP_DIR" ]; then
        log_message "‚ùå ERROR: Folder backup tidak ditemukan!"
        return 1
    fi
    
    log_message "üîç Mencari file backup..."
    
    restore_count=0
    total_cookies_restored=0
    failed_count=0
    
    for db_file in "$BACKUP_DIR"/com.roblox.clien*.db; do
        [ -e "$db_file" ] || continue
        
        pkg_name=$(basename "$db_file" .db)
        target_folder="/data/data/$pkg_name"
        target_path="$target_folder/app_webview/Default/Cookies"
        
        # Hitung cookies sebelum restore
        cookie_count=$(count_cookies_in_db "$db_file")
        
        if [ -d "$target_folder" ]; then
            mkdir -p "$(dirname "$target_path")"
            
            # Backup file asli jika ada
            if [ -f "$target_path" ]; then
                backup_original="$BACKUP_DIR/${pkg_name}_original_$(date +%s).db"
                cp "$target_path" "$backup_original"
                log_message "üíæ Backup original: $backup_original"
            fi
            
            # Restore file
            cp "$db_file" "$target_path"
            
            # Set permission
            if app_uid=$(stat -c "%u:%g" "$target_folder" 2>/dev/null); then
                chown "$app_uid" "$target_path"
                chmod 660 "$target_path"
                log_message "‚úÖ Restore: $pkg_name ($cookie_count cookies)"
                restore_count=$((restore_count + 1))
                total_cookies_restored=$((total_cookies_restored + cookie_count))
            else
                log_message "‚ùå Gagal set permission: $pkg_name"
                failed_count=$((failed_count + 1))
            fi
        else
            log_message "‚ö†Ô∏è Aplikasi tidak ditemukan: $pkg_name"
            failed_count=$((failed_count + 1))
        fi
    done
    
    log_message "üìä RESTORE SELESAI: $restore_count berhasil, $failed_count gagal, $total_cookies_restored cookies"
    echo $total_cookies_restored
}

# Fungsi untuk menentukan jumlah app yang harus didownload
determine_app_count() {
    echo "=========================================="
    echo "   MENENTUKAN JUMLAH APP"
    echo "=========================================="
    
    local installed_count=$(count_installed_apps)
    local backup_count=$(count_backup_files)
    
    log_message "üìä Status saat ini:"
    log_message "   üì± App terinstall: $installed_count"
    log_message "   üíæ File backup: $backup_count"
    
    # Jika ada app terinstall, gunakan jumlah itu
    if [ "$installed_count" -gt 0 ]; then
        log_message "‚úÖ Menggunakan jumlah app terinstall: $installed_count"
        echo $installed_count
        return 0
    fi
    
    # Jika tidak ada app terinstall, cek backup
    if [ "$backup_count" -gt 0 ]; then
        log_message "‚úÖ Tidak ada app terinstall, menggunakan jumlah backup: $backup_count"
        echo $backup_count
        return 0
    fi
    
    # Jika tidak ada keduanya, gunakan default
    log_message "‚ö†Ô∏è Tidak ada app terinstall dan tidak ada backup, menggunakan default: 1"
    echo 1
}

# Fungsi utama: Jalankan semua step otomatis
run_automated_process() {
    echo "=========================================="
    echo "   ROBOX AUTOMATED PROCESS"
    echo "=========================================="
    echo "üîÑ Proses akan berjalan otomatis..."
    echo "   Log: $LOG_FILE"
    echo ""
    
    # Reset log file
    echo "=== ROBOX AUTOMATED PROCESS START ===" > "$LOG_FILE"
    log_message "Memulai proses otomatis..."
    
    # Step 1: Tentukan jumlah app yang akan diproses
    log_message "=== STEP 1: MENENTUKAN JUMLAH APP ==="
    APP_COUNT=$(determine_app_count)
    log_message "üì± Jumlah app yang akan diproses: $APP_COUNT"
    echo "üì± Jumlah app: $APP_COUNT"
    echo ""
    
    # Step 2: Backup cookies
    log_message "=== STEP 2: BACKUP COOKIES ==="
    echo "üíæ Backup semua cookies..."
    BACKUP_COOKIES=$(backup_all_cookies)
    echo "üç™ Cookies yang dibackup: $BACKUP_COOKIES"
    
    # Jika backup gagal atau tidak ada cookies, tetap lanjutkan dengan APP_COUNT
    if [ "$BACKUP_COOKIES" -eq 0 ]; then
        log_message "‚ö†Ô∏è Tidak ada cookies yang dibackup, menggunakan APP_COUNT: $APP_COUNT"
    else
        # Update APP_COUNT berdasarkan jumlah backup yang berhasil
        APP_COUNT=$BACKUP_COOKIES
        log_message "üîÑ Update jumlah app berdasarkan backup: $APP_COUNT"
    fi
    echo ""
    
    # Step 3: Uninstall semua apps
    log_message "=== STEP 3: UNINSTALL APPS ==="
    echo "üóëÔ∏è Uninstall semua apps..."
    UNINSTALLED=$(uninstall_all_apps)
    echo "üì± Apps diuninstall: $UNINSTALLED"
    echo ""
    
    # Step 4: Download APK dari server
    log_message "=== STEP 4: DOWNLOAD APKS ==="
    echo "‚¨áÔ∏è Download APK dari server ($APP_COUNT app)..."
    
    if ! download_apk_from_server "$APP_COUNT"; then
        log_message "‚ùå Gagal download APK files!"
        echo "‚ùå Gagal download APK files!"
        return 1
    fi
    echo ""
    
    # Step 5: Install semua APK
    log_message "=== STEP 5: INSTALL APKS ==="
    echo "üîß Install semua APK ($APP_COUNT app)..."
    INSTALLED=$(install_all_downloaded_apps "$APP_COUNT")
    echo "üì± Apps terinstall: $INSTALLED"
    echo ""
    
    # Step 6: Restore cookies
    log_message "=== STEP 6: RESTORE COOKIES ==="
    echo "üîÑ Restore semua cookies..."
    RESTORED_COOKIES=$(restore_all_cookies)
    echo "üç™ Cookies dipulihkan: $RESTORED_COOKIES"
    echo ""
    
    # Tampilkan summary
    echo "=========================================="
    echo "   PROSES SELESAI - SUMMARY"
    echo "=========================================="
    log_message "=== PROCESS COMPLETE ==="
    
    echo "üìä HASIL PROSES:"
    echo "   1. Jumlah app diproses: $APP_COUNT"
    echo "   2. Cookies dibackup: $BACKUP_COOKIES"
    echo "   3. Aplikasi diuninstall: $UNINSTALLED"
    echo "   4. Aplikasi diinstall ulang: $INSTALLED"
    echo "   5. Cookies dipulihkan: $RESTORED_COOKIES"
    echo ""
    echo "üìÅ Backup folder: $BACKUP_DIR"
    echo "üìÅ Download folder: $DOWNLOAD_DIR"
    echo "üìã Log file: $LOG_FILE"
    
    log_message "Summary: $APP_COUNT apps diproses, $BACKUP_COOKIES cookies backed up, $UNINSTALLED uninstalled, $INSTALLED reinstalled, $RESTORED_COOKIES cookies restored"
    
    # Tampilkan aplikasi yang sekarang terinstall
    echo ""
    echo "üì± APLIKASI TERINSTALL SEKARANG:"
    pm list packages | grep "roblox" || echo "   Tidak ada app Roblox"
}

# Fungsi manual (menu lama)
manual_menu() {
    echo "=========================================="
    echo "   MANUAL MENU"
    echo "=========================================="
    
    while true; do 
        echo ""
        echo "üì± MENU UTAMA:"
        echo "   1. Download & Install Clones (pilih jumlah)"
        echo "   2. Backup Cookies"
        echo "   3. Restore Cookies" 
        echo "   4. HAPUS SEMUA APP"
        echo "   5. Kembali ke menu utama"
        echo "   6. Keluar"
        printf "Pilih menu [1-6]: " 
        read choice

        case $choice in
            1) 
                echo "=========================================="
                echo "   DOWNLOAD & INSTALL MANUAL"
                echo "=========================================="
                
                echo ""
                echo "üì± Pilih jumlah app yang ingin diinstall:"
                for i in {1..8}; do
                    echo "   $i. $i app$( [ $i -gt 1 ] && echo "s" )"
                done
                printf "Pilih [1-8]: "
                read app_count
                
                if [[ "$app_count" =~ ^[1-8]$ ]]; then
                    echo "üì• Download $app_count APK dari server..."
                    if download_apk_from_server "$app_count"; then
                        echo "üîß Install $app_count APK..."
                        install_all_downloaded_apps "$app_count"
                    fi
                else
                    echo "‚ùå Pilihan tidak valid! Harus 1-8"
                fi
                ;;
            2) 
                echo "=========================================="
                echo "   BACKUP COOKIES MANUAL"
                echo "=========================================="
                backup_all_cookies
                ;;
            3) 
                echo "=========================================="
                echo "   RESTORE COOKIES MANUAL"
                echo "=========================================="
                restore_all_cookies
                ;;
            4) 
                echo "=========================================="
                echo "   UNINSTALL ALL APPS MANUAL"
                echo "=========================================="
                uninstall_all_apps
                ;;
            5) return ;;
            6) 
                echo "üëã Selamat tinggal!"
                exit 0 
                ;;
            *) echo "‚ùå Pilihan salah. Coba lagi." ;;
        esac
    done
}

# --- MAIN MENU ---
check_root 

echo "=========================================="
echo "       ROBOX MULTI-CLONE MANAGER          "
echo "=========================================="
echo "üì° Server APK: $SERVER_URL"
echo "üìÅ Download: $DOWNLOAD_DIR"
echo "üíæ Backup: $BACKUP_DIR"
echo "üìã Log: $LOG_FILE"
echo ""

# Cek aplikasi yang terinstall
CURRENT_APPS=$(pm list packages | grep "com.roblox.clien" | wc -l)
echo "üì± Aplikasi terinstall saat ini: $CURRENT_APPS"

# Cek backup yang tersedia
BACKUP_FILES=$(count_backup_files)
if [ "$BACKUP_FILES" -gt 0 ]; then
    echo "üíæ Backup tersedia: $BACKUP_FILES file"
    
    # Hitung total cookies di backup
    TOTAL_COOKIES=0
    for db_file in "$BACKUP_DIR"/*.db; do
        [ -e "$db_file" ] || continue
        count=$(count_cookies_in_db "$db_file")
        TOTAL_COOKIES=$((TOTAL_COOKIES + count))
    done
    echo "üç™ Total cookies di backup: $TOTAL_COOKIES"
fi

while true; do 
    echo ""
    echo "üéØ PILIH MODE:"
    echo "   1. AUTOMATIC PROCESS (Semua step otomatis)"
    echo "   2. MANUAL MENU (Pilih step manual)"
    echo "   3. KELUAR"
    printf "Pilih mode [1-3]: " 
    read mode

    case $mode in
        1) 
            echo ""
            echo "‚ö†Ô∏è  PERINGATAN: Proses otomatis akan:"
            echo "   1. Cek app terinstall / backup"
            echo "   2. Backup semua cookies"
            echo "   3. Uninstall semua aplikasi"
            echo "   4. Download APK dari server"
            echo "   5. Install semua APK"
            echo "   6. Restore semua cookies"
            echo ""
            echo "‚ùì Lanjutkan? (y/n)"
            printf "Pilih [y/n]: "
            read confirm
            
            confirm=$(echo "$confirm" | tr '[:upper:]' '[:lower:]')
            if [ "$confirm" = "y" ] || [ "$confirm" = "ya" ] || [ "$confirm" = "yes" ]; then
                run_automated_process
            else
                echo "‚ùå Dibatalkan."
            fi
            ;;
        2) manual_menu ;;
        3) 
            echo "üëã Selamat tinggal!"
            exit 0 
            ;;
        *) echo "‚ùå Pilihan salah. Coba lagi." ;;
    esac
done
