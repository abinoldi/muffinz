#!/data/data/com.termux/files/usr/bin/bash

# ==========================================================
# ROBLOX MANAGER v9.0 (PURE BASH + GOFILE)
# ==========================================================

# --- FIX WAJIB: Agar Root bisa baca perintah Termux ---
export PATH="/data/data/com.termux/files/usr/bin:/data/data/com.termux/files/usr/bin/applets:$PATH"

# --- KONFIGURASI ---
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
# URL Gofile Anda
GOFILE_URL="https://gofile.io/d/ewZLec" 
# Kosongkan jika tidak ada password
GOFILE_PASSWORD="" 

# --- WARNA ---
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

# ==========================================================
# BAGIAN 1: ENGINE DOWNLOAD GOFILE (TANPA PYTHON)
# ==========================================================

get_json_value() {
    echo "$1" | sed -n 's/.*"'"$2"'":"\([^"]*\)".*/\1/p' | head -n 1
}

get_token() {
    # Mengambil Token Tamu
    curl -s -X POST "https://api.gofile.io/accounts" | grep -o '"token":"[^"]*' | cut -d'"' -f4
}

fetch_recursive() {
    local content_id="$1"
    local current_dir="$2"
    local hashed_password="$3"
    
    local api_url="https://api.gofile.io/contents/$content_id?cache=true"
    [ -n "$hashed_password" ] && api_url="${api_url}&password=${hashed_password}"

    # Request ke Gofile
    local response=$(curl -s -H "Authorization: Bearer $TOKEN" -H "X-Website-Token: 4fd6sg89d7s6" "$api_url")
    local status=$(get_json_value "$response" "status")
    
    if [ "$status" != "ok" ]; then
        echo "${RED}‚ùå Gagal akses Gofile ID: $content_id${NC}"
        return
    fi

    local type=$(get_json_value "$response" "type")
    local name=$(get_json_value "$response" "name")

    if [[ "$current_dir" == "$DOWNLOAD_DIR" ]] && [[ "$type" == "folder" ]]; then
         local target_path="$current_dir"
    else
         local target_path="$current_dir/$name"
    fi

    if [ "$type" == "folder" ]; then
        mkdir -p "$target_path"
        # Trik SED: Ubah koma jadi enter agar grep bisa baca semua ID anak
        local child_ids=$(echo "$response" | sed 's/,"/\n/g' | grep '"id":' | cut -d'"' -f4)
        
        for cid in $child_ids; do
            [ "$cid" != "$content_id" ] && fetch_recursive "$cid" "$target_path" "$hashed_password"
        done
    else
        local link=$(get_json_value "$response" "link")
        if [ -n "$link" ]; then
            # Download jika file belum ada
            if [ ! -s "$target_path/$name" ]; then
                echo "   ‚¨áÔ∏è Download: ${CYAN}$name${NC}"
                curl -L -# -C - --retry 5 -H "Authorization: Bearer $TOKEN" -o "$target_path/$name" "$link"
            else
                echo "   ‚è© Lewati: $name (Sudah ada)"
            fi
        fi
    fi
}

# ==========================================================
# BAGIAN 2: MENU ASLI (DENGAN PERBAIKAN BASH)
# ==========================================================

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "${RED}‚ùå Script ini MEMBUTUHKAN akses Root!${NC}"
        echo "üëâ Jalankan dengan perintah: tsu"
        exit 1
    fi
}

do_backup() {
    echo "=== MEMULAI BACKUP ==="
    mkdir -p "$BACKUP_DIR"
    count=0
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg_name=$(basename "$folder")
        cookie_path=""
        [ -f "$folder/app_webview/Default/Cookies" ] && cookie_path="$folder/app_webview/Default/Cookies"
        [ -f "$folder/app_webview/Cookies" ] && [ -z "$cookie_path" ] && cookie_path="$folder/app_webview/Cookies"

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            echo "‚úÖ Backup: $pkg_name"
            count=$((count + 1))
        fi
    done
    echo "Selesai! $count database tersimpan."
}

do_restore_sequential() {
    echo "=== RESTORE SEQUENTIAL ==="
    
    # INI BAGIAN YANG ERROR SEBELUMNYA DI 'SH'
    # Syntax (...) hanya jalan di BASH
    backups=($(ls -v "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null))
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))

    total_backups=${#backups[@]}
    total_pkgs=${#pkgs[@]}

    if [ "$total_backups" -eq 0 ]; then
        echo "‚ùå Data backup tidak ditemukan."
        return
    fi

    echo "‚ÑπÔ∏è Mengembalikan $total_backups akun..."

    i=0
    while [ $i -lt $total_backups ] && [ $i -lt $total_pkgs ]; do
        current_db="${backups[$i]}"
        current_pkg="${pkgs[$i]}"
        target_path="/data/data/$current_pkg/app_webview/Default/Cookies"

        echo "üîÑ Restore: $(basename "$current_db") -> $current_pkg"
        mkdir -p "$(dirname "$target_path")"
        cp "$current_db" "$target_path"
        
        # Fix Permission
        app_uid=$(stat -c "%u:%g" "/data/data/$current_pkg")
        chown -R "$app_uid" "/data/data/$current_pkg/app_webview"
        chmod 660 "$target_path"
        
        i=$((i + 1))
    done
    echo "‚úÖ Selesai!"
}

do_uninstall() {
    echo "=== HAPUS APLIKASI ==="
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    [ -z "$pkgs" ] && echo "‚ùå Tidak ada aplikasi." && return
    
    echo -n "‚ùì Yakin hapus SEMUA? (y/n): "
    read confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        for pkg in $pkgs; do
            pm uninstall "$pkg" > /dev/null 2>&1 && echo "‚úÖ $pkg Terhapus."
        done
    fi
}

do_auto_process() {
    echo "=========================================="
    echo "   PROSES OTOMATIS (GOFILE BASH)          "
    echo "=========================================="
    
    mkdir -p "$DOWNLOAD_DIR"
    
    # 1. SETUP GOFILE
    echo "üöÄ Menghubungkan ke Gofile..."
    TOKEN=$(get_token)
    CONTENT_ID=$(echo "$GOFILE_URL" | grep -oE '[a-zA-Z0-9]+$' | tail -n 1)
    HASH_PASS=""
    [ -n "$GOFILE_PASSWORD" ] && HASH_PASS=$(echo -n "$GOFILE_PASSWORD" | sha256sum | awk '{print $1}')

    # 2. DOWNLOAD RECURSIVE (MENGGANTIKAN PYTHON)
    echo "‚è≥ Memindai & Mendownload..."
    fetch_recursive "$CONTENT_ID" "$DOWNLOAD_DIR" "$HASH_PASS"
    
    # 3. INSTALL APK
    echo "------------------------------------------"
    echo "üì¶ Memulai Instalasi..."
    
    count=$(find "$DOWNLOAD_DIR" -name "*.apk" | wc -l)
    if [ "$count" -eq 0 ]; then
        echo "${RED}‚ùå Tidak ada APK terdownload.${NC}"
        return
    fi
    
    find "$DOWNLOAD_DIR" -name "*.apk" | sort -V | while read apk; do
        echo "üî® Install: $(basename "$apk")..."
        pm install -r "$apk" > /dev/null 2>&1
    done

    # 4. RESTORE
    do_restore_sequential
    echo "‚ú® SEMUA PROSES SELESAI!"
}

# --- MENU ---
check_root
while true; do
    echo ""
    echo "1. Backup Akun"
    echo "2. Restore Akun (Sequential)"
    echo "3. Hapus Semua Aplikasi Clone"
    echo "4. PROSES OTOMATIS (Gofile -> Install -> Restore)"
    echo "5. Keluar"
    echo "------------------------------------------"
    echo -n "Pilih menu [1-5]: "
    read choice
    case $choice in
        1) do_backup ;;
        2) do_restore_sequential ;;
        3) do_uninstall ;;
        4) do_auto_process ;;
        5) exit 0 ;;
        *) echo "‚ö†Ô∏è Pilihan salah." ;;
    esac
done
