#!/system/bin/sh

# Konfigurasi Lokasi
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="uwNahlh"
GIT_REPO="https://github.com/ltsdw/gofile-downloader"
SCRIPT_DIR="/data/data/com.termux/files/home"

# Fungsi cek Root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        echo "Silakan jalankan dengan: su -c 'sh $0'"
        exit 1
    fi
}

# Set PATH untuk root (Termux specific)
export PATH=/data/data/com.termux/files/usr/bin:$PATH

# Fungsi 1: Backup
do_backup() {
    echo "=========================================="
    echo "       MEMULAI PROSES BACKUP...           "
    mkdir -p "$BACKUP_DIR"
    count=0
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg_name=$(basename "$folder")
        cookie_path=""
        if [ -f "$folder/app_webview/Default/Cookies" ]; then
            cookie_path="$folder/app_webview/Default/Cookies"
        elif [ -f "$folder/app_webview/Cookies" ]; then
            cookie_path="$folder/app_webview/Cookies"
        fi

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            echo "‚úÖ Backup SUKSES: $pkg_name"
            count=$((count + 1))
        fi
    done
    echo "Selesai! $count database tersimpan."
}

# Fungsi 2: Restore
do_restore() {
    echo "=========================================="
    echo "       MEMULAI PROSES RESTORE...          "
    if [ ! -d "$BACKUP_DIR" ]; then
        echo "‚ùå Folder backup tidak ditemukan!"
        return 1
    fi
    count=0
    for db_file in "$BACKUP_DIR"/com.roblox.clien*.db; do
        [ -e "$db_file" ] || continue
        pkg_name=$(basename "$db_file" .db)
        target_folder="/data/data/$pkg_name"
        target_path="$target_folder/app_webview/Default/Cookies"
        
        if [ -d "$target_folder" ]; then
            mkdir -p "$(dirname "$target_path")"
            cp "$db_file" "$target_path"
            app_uid=$(stat -c "%u:%g" "$target_folder")
            chown "$app_uid" "$target_path"
            chmod 660 "$target_path"
            echo "‚úÖ Restore SUKSES: $pkg_name"
            count=$((count + 1))
        fi
    done
    echo "‚úÖ Restore selesai: $count app dipulihkan."
}

# Fungsi 3: Download & Auto-Install dengan pilihan jumlah
do_download_install() {
    echo "=========================================="
    echo "       DOWNLOAD & INSTALL CLONES          "
    
    # Tanya berapa banyak app yang ingin diinstall
    echo ""
    echo "üì± Pilih jumlah app yang ingin diinstall:"
    echo "   1. 1 app (utama saja)"
    echo "   2. 2 apps"
    echo "   3. 3 apps" 
    echo "   4. 4 apps"
    echo "   5. 5 apps"
    echo "   6. 6 apps"
    echo "   7. 7 apps"
    echo "   8. 8 apps (semua)"
    echo "   0. Kembali"
    
    printf "Pilih [0-8]: "
    read app_count
    
    case $app_count in
        0) return ;;
        1|2|3|4|5|6|7|8)
            echo "‚è≥ Menginstall $app_count app..."
            ;;
        *)
            echo "‚ùå Pilihan tidak valid!"
            return 1
            ;;
    esac
    
    # Cek apakah sudah ada app yang terinstall
    installed_pkgs=$(pm list packages | grep "com.roblox.clien" | wc -l)
    echo "üìä Saat ini ada $installed_pkgs app terinstall."
    
    if [ $installed_pkgs -ge $app_count ]; then
        echo "‚ÑπÔ∏è  Jumlah app yang diminta ($app_count) sudah terinstall."
        echo "   Tidak perlu download/install tambahan."
        return 0
    fi
    
    # Hitung berapa banyak yang perlu diinstall
    need_to_install=$((app_count - installed_pkgs))
    echo "üì• Perlu install $need_to_install app tambahan."
    
    # Tanya apakah ingin download
    echo ""
    echo "‚¨áÔ∏è  Download APK files dari internet?"
    echo "   y = Ya, download dulu"
    echo "   n = Tidak, lanjut install dari file yang sudah ada"
    printf "Pilih [y/n]: "
    read download_choice
    
    if [ "$download_choice" = "y" ] || [ "$download_choice" = "Y" ]; then
        echo "‚è≥ Cloning downloader..."
        
        # Change to home directory first
        cd "$SCRIPT_DIR" || {
            echo "‚ùå Tidak bisa pindah ke direktori: $SCRIPT_DIR"
            return 1
        }
        
        # Check if git exists
        if ! command -v git >/dev/null 2>&1; then
            echo "‚ùå Git tidak ditemukan! Instal dulu di Termux: pkg install git"
            echo "   Jalankan di Termux (bukan sebagai root): pkg install git"
            return 1
        fi
        
        if [ ! -d "gofile-downloader" ]; then
            echo "üì¶ Cloning repository..."
            git clone "$GIT_REPO" || {
                echo "‚ùå Gagal clone repository!"
                return 1
            }
        fi
        
        cd gofile-downloader || {
            echo "‚ùå Tidak bisa masuk ke folder gofile-downloader"
            return 1
        }
        
        # Check if python3 exists
        if ! command -v python3 >/dev/null 2>&1; then
            echo "‚ùå Python3 tidak ditemukan! Instal dulu: pkg install python"
            return 1
        fi
        
        # Check if pip3 exists
        if command -v pip3 >/dev/null 2>&1; then
            echo "üì¶ Menginstall requirements..."
            pip3 install -r requirements.txt 2>/dev/null || echo "‚ö†Ô∏è Gagal install requirements (mungkin sudah terinstall)"
        else
            echo "‚ö†Ô∏è pip3 tidak ditemukan, skip install requirements"
        fi
        
        if [ -f "gofile-downloader.py" ]; then
            echo "üåê Downloading APK files..."
            python3 gofile-downloader.py || echo "‚ö†Ô∏è Gagal download dari gofile"
        else
            echo "‚ùå File gofile-downloader.py tidak ditemukan!"
        fi
        
        cd ..
    fi
    
    # Proses instalasi
    echo ""
    echo "üîß Memulai proses instalasi..."
    
    # Cek apakah folder download ada
    if [ ! -d "$DOWNLOAD_DIR" ]; then
        echo "‚ùå Folder $DOWNLOAD_DIR tidak ditemukan!"
        echo "   Silakan download manual atau pilih 'y' untuk download otomatis."
        return 1
    fi
    
    cd "$DOWNLOAD_DIR" || {
        echo "‚ùå Tidak bisa masuk ke folder $DOWNLOAD_DIR"
        return 1
    }
    
    installed_count=0
    start_number=$((installed_pkgs + 1))
    end_number=$app_count
    
    echo "üìÅ Mencari APK files dari $start_number.apk sampai $end_number.apk..."
    
    for i in $(seq $start_number $end_number); do
        apk_file="$i.apk"
        if [ -f "$apk_file" ]; then
            # Tentukan nama package
            if [ $i -eq 1 ]; then
                pkg_name="com.roblox.client"
            else
                pkg_name="com.roblox.clien$i"
            fi
            
            echo ""
            echo "üì¶ [$i/$end_number] Menginstall $apk_file..."
            echo "   Package name: $pkg_name"
            
            # Cek apakah sudah terinstall
            if pm list packages | grep -q "$pkg_name" 2>/dev/null; then
                echo "   ‚ö†Ô∏è  Sudah terinstall, skip..."
                installed_count=$((installed_count + 1))
                continue
            fi
            
            # Install APK
            if pm install "$apk_file" 2>/dev/null; then
                echo "   ‚úÖ Berhasil diinstall!"
                installed_count=$((installed_count + 1))
                
                # Tunggu sebentar agar package terdaftar
                sleep 1
            else
                echo "   ‚ùå Gagal menginstall $apk_file"
            fi
        else
            echo "‚ùå File $apk_file tidak ditemukan!"
        fi
    done
    
    cd "$SCRIPT_DIR"
    
    echo ""
    echo "=========================================="
    echo "üéØ INSTALASI SELESAI"
    echo "   Diminta: $app_count app"
    echo "   Berhasil: $installed_count app"
    
    if [ $installed_count -lt $app_count ]; then
        echo "   ‚ùå Ada $(($app_count - $installed_count)) app yang gagal diinstall"
    else
        echo "   ‚úÖ Semua app berhasil diinstall!"
    fi
}

# Fungsi 4: Uninstall
do_uninstall() {
    echo "=========================================="
    echo "       UNINSTALL SEMUA APP                "
    
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    total=$(echo "$pkgs" | wc -l)
    
    if [ -z "$pkgs" ]; then 
        echo "‚ùå Tidak ada app ditemukan."
        return
    fi
    
    echo "üì± Ditemukan $total app:"
    for pkg in $pkgs; do
        echo "   üì¶ $pkg"
    done
    
    echo ""
    echo "‚ö†Ô∏è  PERINGATAN: Ini akan menghapus SEMUA app di atas!"
    echo "   Yakin ingin menghapus? (y/n)"
    printf "Pilih [y/n]: "
    read confirm
    
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        echo ""
        echo "üóëÔ∏è  Menghapus app..."
        count=0
        for pkg in $pkgs; do
            echo "   ‚è≥ Menghapus $pkg..."
            if pm uninstall "$pkg" > /dev/null 2>&1; then
                echo "   ‚úÖ Berhasil dihapus"
                count=$((count + 1))
            else
                echo "   ‚ùå Gagal menghapus $pkg"
            fi
        done
        echo ""
        echo "‚ú® Selesai! $count app berhasil dihapus."
    else
        echo "‚ùå Dibatalkan."
    fi
}

# --- MAIN MENU ---
check_root 
echo "=========================================="
echo "       ROBOX MULTI-CLONE MANAGER          "
echo "=========================================="

while true; do 
    echo ""
    echo "üì± MENU UTAMA:"
    echo "   1. Download & Install Clones (pilih jumlah)"
    echo "   2. Backup Cookies"
    echo "   3. Restore Cookies" 
    echo "   4. HAPUS SEMUA APP"
    echo "   5. Keluar"
    printf "Pilih menu [1-5]: " 
    read choice

    case $choice in
        1) do_download_install ;;
        2) do_backup ;;
        3) do_restore ;;
        4) do_uninstall ;;
        5) 
            echo "üëã Selamat tinggal!"
            exit 0 
            ;;
        *) echo "‚ùå Pilihan salah. Coba lagi." ;;
    esac
done
