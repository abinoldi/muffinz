#!/system/bin/sh

# Konfigurasi
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/data/data/com.termux/files/home/rbx_apks"
SERVER_URL="http://146.190.147.43:88"
SCRIPT_DIR="/data/data/com.termux/files/home"
LOG_FILE="/sdcard/RobloxAuto.log"

# Fungsi log
log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
    echo "$1"
}

# Cek root
check_root() {
    if [ "$(id -u)" != "0" ]; then
        echo "Butuh root! Jalankan: su -c 'sh $0'"
        exit 1
    fi
}

# Set PATH
export PATH=/data/data/com.termux/files/usr/bin:$PATH

# Hitung cookies
count_cookies() {
    local db="$1"
    [ ! -f "$db" ] && echo "0" && return
    command -v sqlite3 >/dev/null 2>&1 && sqlite3 "$db" "SELECT COUNT(*) FROM cookies;" 2>/dev/null || echo "0"
}

# Hitung backup files
count_backups() {
    [ ! -d "$BACKUP_DIR" ] && echo "0" && return
    ls "$BACKUP_DIR"/*.db 2>/dev/null | wc -l
}

# Hitung app terinstall
count_apps() {
    local pkgs=$(pm list packages | grep "com.roblox.clien" | cut -d: -f2)
    [ -n "$pkgs" ] && echo "$pkgs" | wc -l || echo "0"
}

# Backup cookies
backup_cookies() {
    echo "Memulai backup cookies..."
    mkdir -p "$BACKUP_DIR"
    local backup_count=0

    for folder in /data/data/com.roblox.clien*; do
        [ ! -d "$folder" ] && continue
        local pkg_name=$(basename "$folder")
        local cookie_path=""

        [ -f "$folder/app_webview/Default/Cookies" ] && cookie_path="$folder/app_webview/Default/Cookies"
        [ -z "$cookie_path" ] && [ -f "$folder/app_webview/Cookies" ] && cookie_path="$folder/app_webview/Cookies"

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            backup_count=$((backup_count + 1))
            log_msg "Backup: $pkg_name"
        fi
    done

    echo "$backup_count"
}

# Uninstall apps
uninstall_apps() {
    local pkgs=$(pm list packages | grep "com.roblox.clien" | cut -d: -f2)
    local count=0
    for pkg in $pkgs; do
        pm uninstall "$pkg" >/dev/null 2>&1 && count=$((count+1))
    done
    echo "$count"
}

# Download APK
download_apk() {
    local count="$1"
    mkdir -p "$DOWNLOAD_DIR"
    cd "$DOWNLOAD_DIR" || return 1
    local i=1 downloaded=0

    while [ "$i" -le "$count" ]; do
        local f="$i.apk"
        local url="$SERVER_URL/$f"
        wget -q "$url" -O "$f" || curl -s -L "$url" -o "$f"
        [ -s "$f" ] && downloaded=$((downloaded+1))
        i=$((i+1))
    done

    [ "$downloaded" -gt 0 ]
}

# Install APK
install_apk() {
    local count="$1"
    cd "$DOWNLOAD_DIR" || return
    local i=1 installed=0

    while [ "$i" -le "$count" ]; do
        [ -f "$i.apk" ] && pm install "$i.apk" >/dev/null 2>&1 && installed=$((installed+1))
        i=$((i+1))
    done
    echo "$installed"
}

# Restore cookies
restore_cookies() {
    local restored=0
    for db in "$BACKUP_DIR"/com.roblox.clien*.db; do
        [ ! -f "$db" ] && continue
        local pkg=$(basename "$db" .db)
        local dst="/data/data/$pkg/app_webview/Default/Cookies"
        mkdir -p "$(dirname "$dst")"
        cp "$db" "$dst" && restored=$((restored+1))
    done
    echo "$restored"
}

# Tentukan jumlah app
get_app_count() {
    local installed=$(count_apps)
    local backup=$(count_backups)

    echo "App terinstall: $installed"
    echo "File backup: $backup"

    if [ "$installed" -gt 0 ]; then
        echo "$installed"
    elif [ "$backup" -gt 0 ]; then
        echo "$backup"
    else
        echo "1"
    fi
}

# Proses utama
auto_process() {
    echo "=== PROSES OTOMATIS ==="

    # ðŸ”¥ FIX FINAL â€” SATU BARIS INI SAJA ðŸ”¥
    APP_COUNT=$(get_app_count | grep -E '^[0-9]+$' | tail -n 1)

    download_apk "$APP_COUNT" || { echo "Download gagal"; return; }
    install_apk "$APP_COUNT"
    restore_cookies
}

# MAIN
check_root
clear

while true; do
    echo "1. Mode Otomatis"
    echo "2. Keluar"
    read c
    case $c in
        1) auto_process ;;
        2) exit ;;
    esac
done
