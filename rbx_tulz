#!/data/data/com.termux/files/usr/bin/bash

# ==========================================================
# ROBLOX MANAGER v8.0 (PURE BASH PORT OF PYTHON SCRIPT)
# ==========================================================

# --- INJECT PATH (Agar Root bisa akses tool Termux) ---
export PATH="/data/data/com.termux/files/usr/bin:/data/data/com.termux/files/usr/bin/applets:$PATH"

# --- KONFIGURASI ---
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
GOFILE_URL="https://gofile.io/d/ewZLec"
GOFILE_PASSWORD="" # Isi jika ada password

# --- WARNA ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

# ==========================================================
# BAGIAN 1: BASH GOFILE ENGINE (PORTED FROM PYTHON)
# ==========================================================

# Fungsi Helper: Parsing nilai JSON sederhana dengan sed
# Mirip dengan logika dictionary di Python
get_json_value() {
    local json="$1"
    local key="$2"
    echo "$json" | sed -n 's/.*"'"$key"'":"\([^"]*\)".*/\1/p' | head -n 1
}

# Fungsi: Setup Token (Sama seperti _set_account_access_token di Python)
get_token() {
    local response=$(curl -s -X POST "https://api.gofile.io/accounts")
    local token=$(get_json_value "$response" "token")
    echo "$token"
}

# Fungsi: Download File (Sama seperti _perform_download di Python)
download_file() {
    local url="$1"
    local filename="$2"
    local output_path="$3"
    
    # Cek jika file sudah ada (Logic _should_skip_download)
    if [ -s "$output_path" ]; then
        echo "   ‚è© Lewati: $filename (Sudah ada)"
        return
    fi

    echo "   ‚¨áÔ∏è Download: ${CYAN}$filename${NC}"
    
    # curl -C - (Resume) menggantikan logic Range header di Python
    # curl -# (Progress Bar) menggantikan logic _update_progress di Python
    curl -L -# -C - --retry 5 --connect-timeout 30 \
        -H "Authorization: Bearer $TOKEN" \
        -o "$output_path" "$url"
}

# Fungsi: Recursive Fetch (Sama seperti _build_content_tree_structure di Python)
fetch_recursive() {
    local content_id="$1"
    local current_dir="$2"
    local hashed_password="$3"
    
    local api_url="https://api.gofile.io/contents/$content_id?cache=true"
    
    # Tambahkan password hash jika ada
    if [ -n "$hashed_password" ]; then
        api_url="${api_url}&password=${hashed_password}"
    fi

    # Request API
    local response=$(curl -s -H "Authorization: Bearer $TOKEN" \
                             -H "X-Website-Token: 4fd6sg89d7s6" \
                             "$api_url")
    
    local status=$(get_json_value "$response" "status")
    
    if [ "$status" != "ok" ]; then
        echo "${RED}‚ùå Gagal akses ID: $content_id (Status: $status)${NC}"
        return
    fi

    local type=$(get_json_value "$response" "type")
    local name=$(get_json_value "$response" "name")

    # Tentukan path tujuan
    if [[ "$current_dir" == "$DOWNLOAD_DIR" ]] && [[ "$type" == "folder" ]]; then
         local target_path="$current_dir" # Flatten root folder
    else
         local target_path="$current_dir/$name"
    fi

    if [ "$type" == "folder" ]; then
        mkdir -p "$target_path"
        
        # [TEKNIK PURE BASH PARSING]
        # Python menggunakan: for child in data["children"].values():
        # Bash tidak bisa parsing object nested dengan mudah.
        # Trik: Ubah setiap objek anak "{"id":..." menjadi baris baru.
        
        # 1. Ambil bagian "children":{...}
        # 2. Ganti pembuka objek id "":{" menjadi baris baru
        # 3. Parsing setiap baris
        
        # Kita ambil SEMUA ID anak (baik folder maupun file)
        local child_ids=$(echo "$response" | sed 's/,"/\n/g' | grep '"id":' | cut -d'"' -f4)
        
        # Jika folder kosong
        if [ -z "$child_ids" ]; then return; fi

        for cid in $child_ids; do
            # Rekursif: Panggil fungsi ini lagi untuk setiap anak
            # (Ini meniru logic rekursif Python)
            fetch_recursive "$cid" "$target_path" "$hashed_password"
        done

    else
        # Jika tipe adalah FILE
        local link=$(get_json_value "$response" "link")
        if [ -n "$link" ]; then
            download_file "$link" "$name" "$target_path/$name"
        fi
    fi
}

# ==========================================================
# BAGIAN 2: MANAGER UTILS
# ==========================================================

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "${RED}‚ùå Script ini butuh ROOT (tsu).${NC}"
        exit 1
    fi
}

do_restore_sequential() {
    echo "=== FASE RESTORE ==="
    # Array Bash (Membutuhkan #!/bin/bash)
    backups=($(ls -v "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null))
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))

    local max=${#backups[@]}
    [ ${#pkgs[@]} -lt $max ] && max=${#pkgs[@]}

    if [ $max -eq 0 ]; then
        echo "‚ùå Tidak ada data restore."
        return
    fi

    for ((i=0; i<max; i++)); do
        local db="${backups[$i]}"
        local pkg="${pkgs[$i]}"
        local target="/data/data/$pkg/app_webview/Default/Cookies"
        
        echo "üîÑ Restore: $(basename "$db") -> $pkg"
        mkdir -p "$(dirname "$target")"
        cp "$db" "$target"
        
        local uid=$(stat -c "%u:%g" "/data/data/$pkg")
        chown -R "$uid" "/data/data/$pkg/app_webview"
        chmod 660 "$target"
    done
    echo "‚úÖ Selesai."
}

do_backup() {
    echo "=== BACKUP ==="
    mkdir -p "$BACKUP_DIR"
    for f in /data/data/com.roblox.clien*; do
        [ -d "$f" ] || continue
        local pkg=$(basename "$f")
        local cookie="$f/app_webview/Default/Cookies"
        [ -f "$cookie" ] && cp "$cookie" "$BACKUP_DIR/$pkg.db" && echo "‚úÖ $pkg"
    done
}

do_uninstall() {
    local pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    [ -z "$pkgs" ] && return
    echo -n "‚ùì Hapus semua? (y/n): "
    read c
    if [[ "$c" == "y" ]]; then
        for p in $pkgs; do pm uninstall "$p" >/dev/null 2>&1 && echo "üóëÔ∏è $p"; done
    fi
}

# ==========================================================
# MAIN LOGIC
# ==========================================================

do_auto_process() {
    echo "=========================================="
    echo "   PROSES OTOMATIS (PURE BASH ENGINE)     "
    echo "=========================================="
    
    mkdir -p "$DOWNLOAD_DIR"
    local content_id=$(echo "$GOFILE_URL" | grep -oE '[a-zA-Z0-9]+$' | tail -n 1)
    
    # 1. Setup Token & Password Hash
    echo "${CYAN}üöÄ Menyiapkan koneksi Gofile...${NC}"
    TOKEN=$(get_token)
    
    local hashed_pass=""
    if [ -n "$GOFILE_PASSWORD" ]; then
        # Logic Hashing SHA256 (Port dari Python: hashlib.sha256(pwd).hexdigest())
        hashed_pass=$(echo -n "$GOFILE_PASSWORD" | sha256sum | awk '{print $1}')
    fi
    
    # 2. Start Recursive Download
    echo "‚è≥ Memindai folder (Recursive)..."
    # Fungsi ini akan berjalan layaknya class Downloader di Python
    fetch_recursive "$content_id" "$DOWNLOAD_DIR" "$hashed_pass"
    
    # 3. Install APK
    echo "------------------------------------------"
    echo "üì¶ Memulai Instalasi..."
    
    local count=$(find "$DOWNLOAD_DIR" -name "*.apk" | wc -l)
    if [ "$count" -eq 0 ]; then
        echo "${RED}‚ùå Tidak ada APK terdownload.${NC}"
        return
    fi
    
    # Sortir versi (sort -V) mirip logic python sorting
    find "$DOWNLOAD_DIR" -name "*.apk" | sort -V | while read apk; do
        echo "üî® Install: $(basename "$apk")..."
        pm install -r "$apk" > /dev/null 2>&1
    done

    # 4. Restore
    do_restore_sequential
    echo "‚ú® SELESAI!"
}

# --- MENU ---
check_root
while true; do
    echo ""
    echo "1. Backup"
    echo "2. Restore"
    echo "3. Hapus Clone"
    echo "4. AUTO (Pure Bash Download)"
    echo "5. Exit"
    echo -n "Pilih: "
    read c
    case $c in
        1) do_backup ;;
        2) do_restore_sequential ;;
        3) do_uninstall ;;
        4) do_auto_process ;;
        5) exit 0 ;;
    esac
done
