#!/system/bin/sh

# Configuration
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="uwNahlh"
GOFILE_URL="https://gofile.io/d/uwNalh"
GIT_REPO="https://github.com/ltsdw/gofile-downloader"

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "❌ Script ini MEMBUTUHKAN akses Root!" [cite: 2]
        exit 1
    fi
}

# --- New Function: Setup & Download ---
setup_and_download() {
    echo "=========================================="
    echo "    SETTING UP DOWNLOADER & APKS          "
    echo "=========================================="
    
    # Clone and Install Requirements
    if [ ! -d "gofile-downloader" ]; then
        git clone "$GIT_REPO"
    fi
    cd gofile-downloader || exit
    pip3 install -r requirements.txt
    
    # Run Downloader
    python3 gofile-downloader.py "$GOFILE_URL"
    cd ..
    echo "✅ Download complete in $DOWNLOAD_DIR"
}

# --- New Function: Python-based Installer ---
run_installer() {
    echo "=========================================="
    echo "       INSTALLING MISSING APKS            "
    echo "=========================================="
    
    # We use a python one-liner to check missing instances and install
    python3 -c "
import os, subprocess
current_pkgs = subprocess.getoutput('pm list packages com.roblox.clien').split('\n')
installed_count = len([p for p in current_pkgs if p.strip()])
print(f'Detected {installed_count} installed instances.')

target_dir = '$DOWNLOAD_DIR'
if not os.path.exists(target_dir):
    print(f'❌ Directory {target_dir} not found!')
    exit()

# If you have 3 installed and want 8, install 4.apk through 8.apk
for i in range(installed_count + 1, 9):
    apk_path = os.path.join(target_dir, f'{i}.apk')
    if os.path.exists(apk_path):
        print(f'⏳ Installing {apk_path}...')
        os.system(f'pm install {apk_path}')
    else:
        print(f'⚠️  {apk_path} not found.')
"
}

# --- Original Functions ---
do_backup() {
    mkdir -p "$BACKUP_DIR"
    count=0
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue [cite: 4, 5]
        pkg_name=$(basename "$folder")
        cookie_path=""
        if [ -f "$folder/app_webview/Default/Cookies" ]; then [cite: 6]
            cookie_path="$folder/app_webview/Default/Cookies"
        elif [ -f "$folder/app_webview/Cookies" ]; then [cite: 7]
            cookie_path="$folder/app_webview/Cookies"
        fi
        if [ -n "$cookie_path" ]; then [cite: 8]
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            count=$((count + 1))
        fi
    done
    echo "✅ Backup Selesai: $count file."
}

do_restore() {
    [ -d "$BACKUP_DIR" ] || return [cite: 10]
    for db_file in "$BACKUP_DIR"/com.roblox.clien*.db; do
        [ -e "$db_file" ] || continue [cite: 12, 13]
        pkg_name=$(basename "$db_file" .db)
        target_path="/data/data/$pkg_name/app_webview/Default/Cookies"
        cp "$db_file" "$target_path" [cite: 16]
        app_uid=$(stat -c "%u:%g" "/data/data/$pkg_name")
        chown "$app_uid" "$target_path" [cite: 16]
        chmod 660 "$target_path" [cite: 16]
    done
}

do_uninstall() {
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    [ -z "$pkgs" ] && return [cite: 20, 21]
    for pkg in $pkgs; do
        pm uninstall "$pkg" > /dev/null 2>&1 [cite: 23]
    done
    echo "✨ Cleaned all clones." [cite: 26]
}

# --- MAIN MENU ---
check_root
while true; do
    echo "1. Download APKS (Gofile)"
    echo "2. Install Missing APKS (1-8)"
    echo "3. Backup Cookies"
    echo "4. Restore Cookies"
    echo "5. Uninstall All Clones"
    echo "6. Exit"
    read -p "Pilih: " choice
    case $choice in
        1) setup_and_download ;;
        2) run_installer ;;
        3) do_backup ;;
        4) do_restore ;;
        5) do_uninstall ;;
        6) exit 0 ;;
    esac
done
