#!/system/bin/sh

# Konfigurasi Lokasi
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/data/data/com.termux/files/home/rbx_apks"
SERVER_URL="http://146.190.147.43:88"
SCRIPT_DIR="/data/data/com.termux/files/home"

# Fungsi cek Root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        echo "Silakan jalankan dengan: su -c 'sh $0'"
        exit 1
    fi
}

# Set PATH untuk root (Termux specific)
export PATH=/data/data/com.termux/files/usr/bin:$PATH

# Fungsi untuk menghitung jumlah cookies dalam database
count_cookies_in_db() {
    local db_file="$1"
    local count=0
    
    # Cek apakah file database ada
    if [ ! -f "$db_file" ]; then
        echo 0
        return
    fi
    
    # Coba hitung cookies dengan sqlite3 jika tersedia
    if command -v sqlite3 >/dev/null 2>&1; then
        count=$(sqlite3 "$db_file" "SELECT COUNT(*) FROM cookies;" 2>/dev/null || echo 0)
    fi
    
    echo "$count"
}

# Fungsi untuk download APK dari server
download_apk_files() {
    local app_count=$1
    echo "‚è≥ Memulai proses download dari server..."
    
    # Buat folder download jika belum ada
    mkdir -p "$DOWNLOAD_DIR"
    cd "$DOWNLOAD_DIR" || {
        echo "‚ùå Tidak bisa masuk ke folder $DOWNLOAD_DIR"
        return 1
    }
    
    echo "üìÅ Folder download: $DOWNLOAD_DIR"
    
    downloaded_count=0
    for i in $(seq 1 $app_count); do
        apk_file="$i.apk"
        url="$SERVER_URL/$apk_file"
        
        # Cek apakah file sudah ada
        if [ -f "$apk_file" ]; then
            file_size=$(du -h "$apk_file" | cut -f1)
            echo "üì¶ File $apk_file sudah ada ($file_size), skip download..."
            downloaded_count=$((downloaded_count + 1))
            continue
        fi
        
        echo "‚¨áÔ∏è  Downloading $apk_file..."
        echo "   URL: $url"
        
        # Coba download dengan wget atau curl
        if command -v wget >/dev/null 2>&1; then
            wget --timeout=30 --tries=3 "$url" -O "$apk_file"
        elif command -v curl >/dev/null 2>&1; then
            curl -L --connect-timeout 30 --max-time 60 --retry 3 "$url" -o "$apk_file"
        else
            echo "‚ùå Tidak ada wget atau curl!"
            echo "   Install di Termux: pkg install wget"
            return 1
        fi
        
        # Cek jika download berhasil
        if [ -f "$apk_file" ] && [ -s "$apk_file" ]; then
            file_size=$(du -h "$apk_file" | cut -f1)
            echo "   ‚úÖ Berhasil ($file_size)"
            downloaded_count=$((downloaded_count + 1))
        else
            echo "   ‚ùå Gagal download $apk_file"
            rm -f "$apk_file" 2>/dev/null
        fi
        
        # Jeda sebentar antar download
        sleep 1
    done
    
    echo ""
    echo "üìä Download selesai: $downloaded_count/$app_count file berhasil"
    
    if [ $downloaded_count -eq 0 ]; then
        echo "‚ùå Tidak ada file yang berhasil didownload!"
        return 1
    fi
    
    # Tampilkan file yang berhasil didownload
    echo ""
    echo "üìã File APK yang tersedia:"
    ls -la *.apk 2>/dev/null | head -10
    
    return 0
}

# Fungsi 1: Backup dengan penghitung cookies
do_backup() {
    echo "=========================================="
    echo "       MEMULAI PROSES BACKUP...           "
    echo "=========================================="
    
    mkdir -p "$BACKUP_DIR"
    total_apps=0
    total_cookies=0
    backup_count=0
    
    echo "üîç Mencari aplikasi Roblox..."
    
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        total_apps=$((total_apps + 1))
        
        pkg_name=$(basename "$folder")
        cookie_path=""
        
        echo ""
        echo "üì¶ Aplikasi: $pkg_name"
        
        # Cari file cookies
        if [ -f "$folder/app_webview/Default/Cookies" ]; then
            cookie_path="$folder/app_webview/Default/Cookies"
            echo "   üìç Lokasi: app_webview/Default/Cookies"
        elif [ -f "$folder/app_webview/Cookies" ]; then
            cookie_path="$folder/app_webview/Cookies"
            echo "   üìç Lokasi: app_webview/Cookies"
        else
            echo "   ‚ùå Cookies tidak ditemukan"
            continue
        fi

        if [ -n "$cookie_path" ]; then
            backup_file="$BACKUP_DIR/${pkg_name}.db"
            
            # Backup file
            cp "$cookie_path" "$backup_file"
            
            # Hitung jumlah cookies
            cookie_count=$(count_cookies_in_db "$backup_file")
            total_cookies=$((total_cookies + cookie_count))
            
            # Tampilkan informasi
            file_size=$(du -h "$backup_file" | cut -f1)
            echo "   ‚úÖ Backup SUKSES"
            echo "   üìä Cookies: $cookie_count"
            echo "   üíæ Size: $file_size"
            echo "   üìÅ Tersimpan: $backup_file"
            
            backup_count=$((backup_count + 1))
        fi
    done
    
    echo ""
    echo "=========================================="
    echo "           BACKUP SELESAI                 "
    echo "=========================================="
    echo "üì± Aplikasi ditemukan: $total_apps"
    echo "‚úÖ Berhasil dibackup: $backup_count"
    echo "üç™ Total cookies: $total_cookies"
    echo "üìÅ Lokasi backup: $BACKUP_DIR"
    
    if [ $backup_count -gt 0 ]; then
        echo ""
        echo "üìã Daftar file backup:"
        ls -la "$BACKUP_DIR"/*.db 2>/dev/null | while read line; do
            file=$(echo "$line" | awk '{print $9}')
            size=$(echo "$line" | awk '{print $5}')
            if [ -f "$file" ]; then
                file_name=$(basename "$file")
                count=$(count_cookies_in_db "$file")
                echo "   üì¶ $file_name ($count cookies, $size bytes)"
            fi
        done
    fi
}

# Fungsi 2: Restore dengan informasi cookies
do_restore() {
    echo "=========================================="
    echo "       MEMULAI PROSES RESTORE...          "
    
    if [ ! -d "$BACKUP_DIR" ]; then
        echo "‚ùå Folder backup tidak ditemukan!"
        echo "   Lokasi: $BACKUP_DIR"
        return 1
    fi
    
    echo "üìÅ Folder backup: $BACKUP_DIR"
    echo "üîç Mencari file backup..."
    
    restore_count=0
    total_cookies_restored=0
    
    for db_file in "$BACKUP_DIR"/com.roblox.clien*.db; do
        [ -e "$db_file" ] || continue
        
        pkg_name=$(basename "$db_file" .db)
        target_folder="/data/data/$pkg_name"
        target_path="$target_folder/app_webview/Default/Cookies"
        
        # Hitung cookies sebelum restore
        cookie_count=$(count_cookies_in_db "$db_file")
        
        if [ -d "$target_folder" ]; then
            mkdir -p "$(dirname "$target_path")"
            
            # Backup file asli jika ada
            if [ -f "$target_path" ]; then
                backup_original="$BACKUP_DIR/${pkg_name}_original.db"
                cp "$target_path" "$backup_original"
                echo "   üíæ Backup original disimpan: $backup_original"
            fi
            
            # Restore file
            cp "$db_file" "$target_path"
            
            # Set permission
            app_uid=$(stat -c "%u:%g" "$target_folder")
            chown "$app_uid" "$target_path"
            chmod 660 "$target_path"
            
            echo ""
            echo "‚úÖ Restore SUKSES: $pkg_name"
            echo "   üç™ Cookies: $cookie_count"
            restore_count=$((restore_count + 1))
            total_cookies_restored=$((total_cookies_restored + cookie_count))
        else
            echo "‚ö†Ô∏è  Aplikasi $pkg_name tidak ditemukan, skip..."
        fi
    done
    
    echo ""
    echo "=========================================="
    echo "           RESTORE SELESAI                "
    echo "=========================================="
    echo "‚úÖ Aplikasi dipulihkan: $restore_count"
    echo "üç™ Total cookies dipulihkan: $total_cookies_restored"
}

# Fungsi 3: Download & Install dengan pilihan jumlah
do_download_install() {
    echo "=========================================="
    echo "       DOWNLOAD & INSTALL CLONES          "
    
    # Tanya berapa banyak app yang ingin diinstall
    echo ""
    echo "üì± Pilih jumlah app yang ingin diinstall:"
    echo "   1. 1 app (utama saja)"
    echo "   2. 2 apps"
    echo "   3. 3 apps" 
    echo "   4. 4 apps"
    echo "   5. 5 apps"
    echo "   6. 6 apps"
    echo "   7. 7 apps"
    echo "   8. 8 apps (semua)"
    echo "   0. Kembali"
    
    printf "Pilih [0-8]: "
    read app_count
    
    case $app_count in
        0) 
            echo "Kembali ke menu utama..."
            return 
            ;;
        1|2|3|4|5|6|7|8)
            echo "‚è≥ Menginstall $app_count app..."
            ;;
        *)
            echo "‚ùå Pilihan tidak valid!"
            return 1
            ;;
    esac
    
    # Cek apakah sudah ada app yang terinstall
    installed_pkgs=$(pm list packages | grep "com.roblox.clien" | wc -l)
    echo "üìä Saat ini ada $installed_pkgs app terinstall."
    
    if [ $installed_pkgs -ge $app_count ]; then
        echo "‚ÑπÔ∏è  Jumlah app yang diminta ($app_count) sudah terinstall."
        echo "   Tidak perlu install tambahan."
        return 0
    fi
    
    # Hitung berapa banyak yang perlu diinstall
    need_to_install=$((app_count - installed_pkgs))
    echo "üì• Perlu install $need_to_install app tambahan."
    
    # Tanya apakah ingin download
    echo ""
    echo "‚¨áÔ∏è  Download APK files dari server?"
    echo "   y = Ya, download dulu"
    echo "   n = Tidak, lanjut install dari file yang sudah ada"
    printf "Pilih [y/n]: "
    read download_choice
    
    # Normalize input
    download_choice=$(echo "$download_choice" | tr '[:upper:]' '[:lower:]')
    
    if [ "$download_choice" = "y" ] || [ "$download_choice" = "ya" ] || [ "$download_choice" = "yes" ]; then
        # Download APK files dari server
        download_apk_files $app_count
        
        if [ $? -ne 0 ]; then
            echo "‚ùå Gagal download APK files!"
            echo "   Cek koneksi internet atau server."
            return 1
        fi
    fi
    
    # Proses instalasi
    echo ""
    echo "üîß Memulai proses instalasi..."
    
    # Pastikan kita di folder yang benar
    if [ ! -d "$DOWNLOAD_DIR" ]; then
        echo "‚ùå Folder download tidak ditemukan: $DOWNLOAD_DIR"
        echo "   Silakan pilih 'y' untuk download terlebih dahulu."
        return 1
    fi
    
    cd "$DOWNLOAD_DIR" || {
        echo "‚ùå Tidak bisa masuk ke folder $DOWNLOAD_DIR"
        return 1
    }
    
    echo "üìÅ Direktori: $(pwd)"
    
    # Tampilkan file APK yang ada
    echo "üìã File APK yang tersedia:"
    ls -la *.apk 2>/dev/null || echo "   Tidak ada file .apk ditemukan"
    
    installed_count=0
    start_number=$((installed_pkgs + 1))
    end_number=$app_count
    
    for i in $(seq $start_number $end_number); do
        apk_file="$i.apk"
        
        if [ ! -f "$apk_file" ]; then
            echo "‚ùå File $apk_file tidak ditemukan!"
            echo "   Download manual: $SERVER_URL/$apk_file"
            continue
        fi
        
        # Tentukan nama package
        if [ $i -eq 1 ]; then
            pkg_name="com.roblox.client"
        else
            pkg_name="com.roblox.clien$i"
        fi
        
        echo ""
        echo "üì¶ [$i/$end_number] Menginstall $apk_file..."
        echo "   Package name: $pkg_name"
        echo "   File size: $(du -h "$apk_file" | cut -f1)"
        
        # Cek apakah sudah terinstall
        if pm list packages | grep -q "$pkg_name" 2>/dev/null; then
            echo "   ‚ö†Ô∏è  Sudah terinstall, skip..."
            installed_count=$((installed_count + 1))
            continue
        fi
        
        # Install APK
        echo "   ‚öôÔ∏è  Menginstall..."
        if pm install "$apk_file" 2>/dev/null; then
            echo "   ‚úÖ Berhasil diinstall!"
            installed_count=$((installed_count + 1))
            sleep 1
        else
            echo "   ‚ùå Gagal menginstall $apk_file"
            echo "   üí° Coba: pm install -r \"$apk_file\""
        fi
    done
    
    cd "$SCRIPT_DIR"
    
    echo ""
    echo "=========================================="
    echo "üéØ INSTALASI SELESAI"
    echo "   Diminta: $app_count app"
    echo "   Berhasil: $installed_count app"
    
    if [ $installed_count -lt $app_count ]; then
        echo "   ‚ö†Ô∏è  Ada $(($app_count - $installed_count)) app yang gagal diinstall"
    else
        echo "   ‚úÖ Semua app berhasil diinstall!"
    fi
    
    # Tampilkan semua app Roblox yang terinstall
    echo ""
    echo "üì± Daftar app Roblox yang terinstall:"
    pm list packages | grep "roblox" || echo "   Tidak ada app Roblox"
}

# Fungsi 4: Uninstall
do_uninstall() {
    echo "=========================================="
    echo "       UNINSTALL SEMUA APP                "
    
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    total=$(echo "$pkgs" | wc -l)
    
    if [ -z "$pkgs" ]; then 
        echo "‚ùå Tidak ada app ditemukan."
        return
    fi
    
    echo "üì± Ditemukan $total app:"
    for pkg in $pkgs; do
        echo "   üì¶ $pkg"
    done
    
    echo ""
    echo "‚ö†Ô∏è  PERINGATAN: Ini akan menghapus SEMUA app di atas!"
    echo "   Yakin ingin menghapus? (y/n)"
    printf "Pilih [y/n]: "
    read confirm
    
    confirm=$(echo "$confirm" | tr '[:upper:]' '[:lower:]')
    
    if [ "$confirm" = "y" ] || [ "$confirm" = "ya" ] || [ "$confirm" = "yes" ]; then
        echo ""
        echo "üóëÔ∏è  Menghapus app..."
        count=0
        for pkg in $pkgs; do
            echo "   ‚è≥ Menghapus $pkg..."
            if pm uninstall "$pkg" > /dev/null 2>&1; then
                echo "   ‚úÖ Berhasil dihapus"
                count=$((count + 1))
            else
                echo "   ‚ùå Gagal menghapus $pkg"
                echo "   üí° Coba: pm uninstall -k --user 0 \"$pkg\""
            fi
        done
        echo ""
        echo "‚ú® Selesai! $count app berhasil dihapus."
    else
        echo "‚ùå Dibatalkan."
    fi
}

# --- MAIN MENU ---
check_root 
echo "=========================================="
echo "       ROBOX MULTI-CLONE MANAGER          "
echo "=========================================="
echo "üì° Server APK: $SERVER_URL"
echo "üìÅ Folder: $DOWNLOAD_DIR"
echo "üíæ Backup: $BACKUP_DIR"

# Cek apakah ada backup sebelumnya
if [ -d "$BACKUP_DIR" ]; then
    backup_files=$(ls "$BACKUP_DIR"/*.db 2>/dev/null | wc -l)
    if [ $backup_files -gt 0 ]; then
        echo "üìä Backup tersedia: $backup_files file"
        
        # Hitung total cookies di backup
        total_backup_cookies=0
        for db_file in "$BACKUP_DIR"/*.db; do
            [ -e "$db_file" ] || continue
            count=$(count_cookies_in_db "$db_file")
            total_backup_cookies=$((total_backup_cookies + count))
        done
        echo "üç™ Cookies tersimpan: $total_backup_cookies"
    fi
fi

while true; do 
    echo ""
    echo "üì± MENU UTAMA:"
    echo "   1. Download & Install Clones (pilih jumlah)"
    echo "   2. Backup Cookies"
    echo "   3. Restore Cookies" 
    echo "   4. HAPUS SEMUA APP"
    echo "   5. Keluar"
    printf "Pilih menu [1-5]: " 
    read choice

    case $choice in
        1) do_download_install ;;
        2) do_backup ;;
        3) do_restore ;;
        4) do_uninstall ;;
        5) 
            echo "üëã Selamat tinggal!"
            exit 0 
            ;;
        *) echo "‚ùå Pilihan salah. Coba lagi." ;;
    esac
done
