#!/system/bin/sh

# ==========================================================
# ROBLOX CLONE MANAGER v3.1 (CLEAN START + FAST DL)
# ==========================================================

BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
BASE_URL="http://43.134.116.2:5555/uploaded"

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        exit 1
    fi
}

do_backup() {
    echo "=========================================="
    echo "       MEMULAI PROSES BACKUP...           "
    echo "=========================================="
    mkdir -p "$BACKUP_DIR"
    count=0
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg_name=$(basename "$folder")
        cookie_path=""
        [ -f "$folder/app_webview/Default/Cookies" ] && cookie_path="$folder/app_webview/Default/Cookies"
        [ -f "$folder/app_webview/Cookies" ] && [ -z "$cookie_path" ] && cookie_path="$folder/app_webview/Cookies"

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            echo "‚úÖ Backup SUKSES: $pkg_name"
            count=$((count + 1))
        fi
    done
    echo "------------------------------------------"
    echo "Selesai! $count database tersimpan."
}

do_restore_sequential() {
    echo "=========================================="
    echo "    RESTORE BERDASARKAN URUTAN (SEQ)      "
    echo "=========================================="
    
    backups=($(ls "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null))
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))

    total_backups=${#backups[@]}
    total_pkgs=${#pkgs[@]}

    if [ "$total_backups" -eq 0 ] || [ "$total_pkgs" -eq 0 ]; then
        echo "‚ùå Data backup atau aplikasi tidak ditemukan."
        return 1
    fi

    echo "‚ÑπÔ∏è Ditemukan $total_backups backup dan $total_pkgs aplikasi."
    echo "------------------------------------------"

    i=0
    while [ $i -lt $total_backups ] && [ $i -lt $total_pkgs ]; do
        current_db="${backups[$i]}"
        current_pkg="${pkgs[$i]}"
        
        target_folder="/data/data/$current_pkg"
        target_dir_parent="$target_folder/app_webview/Default"
        target_path="$target_dir_parent/Cookies"

        echo "üîÑ Restore [$(basename "$current_db")] -> [$current_pkg]"

        mkdir -p "$target_dir_parent"
        cp "$current_db" "$target_path"
        
        app_uid=$(stat -c "%u:%g" "$target_folder")
        chown -R "$app_uid" "$target_folder/app_webview"
        chmod 660 "$target_path"
        
        i=$((i + 1))
    done
    echo "‚úÖ Restore Selesai."
}

do_uninstall() {
    echo "=========================================="
    echo "       MENGHAPUS APLIKASI CLONE...        "
    echo "=========================================="
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")
    [ -z "$pkgs" ] && echo "‚ùå Tidak ada aplikasi." && return
    
    echo -n "‚ùì Yakin hapus SEMUA? (y/n): "
    read confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        for pkg in $pkgs; do
            pm uninstall "$pkg" > /dev/null 2>&1 && echo "üóëÔ∏è $pkg Terhapus."
        done
    fi
}

do_auto_process() {
    echo "=========================================="
    echo "   üöÄ PROSES OTOMATIS (CLEAN & FAST) üöÄ   "
    echo "=========================================="
    
    total_backup=$(ls "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null | wc -l)
    
    if [ "$total_backup" -eq 0 ]; then
        echo "‚ùå Tidak ada backup ditemukan. Batalkan." 
        return
    fi

    # --- BAGIAN HAPUS FILE LAMA ---
    if [ -d "$DOWNLOAD_DIR" ]; then
        echo "üßπ Membersihkan folder $DOWNLOAD_DIR..."
        rm -rf "$DOWNLOAD_DIR"
    fi
    # Buat folder baru yang bersih
    mkdir -p "$DOWNLOAD_DIR"
    # ------------------------------

    echo "üì° [PHASE 1] Mendownload $total_backup file SEKALIGUS..."
    
    for i in $(seq 1 "$total_backup"); do
        APK_NAME="$i.apk"
        SAVE_PATH="$DOWNLOAD_DIR/$APK_NAME"
        
        # Langsung download paralel tanpa cek file ada/tidak (karena folder sudah dibersihkan)
        echo "   ‚¨áÔ∏è  Mulai download: $APK_NAME"
        (curl -L -s "$BASE_URL/$APK_NAME" -o "$SAVE_PATH" && echo "   ‚úÖ Selesai download: $APK_NAME") &
    done

    echo "‚è≥ Menunggu semua download selesai..."
    wait
    echo "‚úÖ Semua download tuntas!"
    echo "------------------------------------------"

    echo "üì¶ [PHASE 2] Menginstall Aplikasi..."
    for i in $(seq 1 "$total_backup"); do
        APK_NAME="$i.apk"
        SAVE_PATH="$DOWNLOAD_DIR/$APK_NAME"
        
        if [ -f "$SAVE_PATH" ]; then
            echo "   üíø Menginstall $APK_NAME..."
            pm install -r "$SAVE_PATH" > /dev/null 2>&1
        else
            echo "   ‚ö†Ô∏è $APK_NAME Gagal didownload."
        fi
    done

    do_restore_sequential
    echo "‚ú® SEMUA PROSES SELESAI!"
}

# --- MAIN MENU ---
check_root
while true; do
    echo ""
    echo "=========================================="
    echo "    ROBLOX CLONE MANAGER v3.1 (ROOT)      "
    echo "=========================================="
    echo "1. Backup Akun"
    echo "2. Restore Akun (Urutan Sequential)"
    echo "3. Hapus Semua Aplikasi Clone"
    echo "4. PROSES OTOMATIS (Clean -> Download -> Install)"
    echo "5. Keluar"
    echo "------------------------------------------"
    echo -n "Pilih menu [1-5]: "
    read choice
    case $choice in
        1) do_backup ;;
        2) do_restore_sequential ;;
        3) do_uninstall ;;
        4) do_auto_process ;;
        5) exit 0 ;;
        *) echo "‚ö†Ô∏è Pilihan salah." ;;
    esac
done
