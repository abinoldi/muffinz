#!/system/sh

# ==========================================================
# ROBLOX CLONE MANAGER v2.3 (CLEAN VERSION)
# ==========================================================

# Konfigurasi Lokasi
BACKUP_DIR="/sdcard/RobloxBackups"
DOWNLOAD_DIR="/sdcard/Download/RobloxAPKs"
BASE_URL="http://146.190.147.43:88"

# Fungsi cek Root [cite: 1, 2, 3]
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        echo "Silakan jalankan dengan: su -c 'sh $0'"
        exit 1
    fi
}

# Fungsi 1: Backup Akun [cite: 3, 5, 8]
do_backup() {
    echo "=========================================="
    echo "       MEMULAI PROSES BACKUP...           "
    echo "=========================================="
    mkdir -p "$BACKUP_DIR"
    count=0
    
    for folder in /data/data/com.roblox.clien*; do
        [ -e "$folder" ] || continue
        pkg_name=$(basename "$folder")
        
        cookie_path=""
        if [ -f "$folder/app_webview/Default/Cookies" ]; then
            cookie_path="$folder/app_webview/Default/Cookies"
        elif [ -f "$folder/app_webview/Cookies" ]; then
            cookie_path="$folder/app_webview/Cookies"
        fi

        if [ -n "$cookie_path" ]; then
            cp "$cookie_path" "$BACKUP_DIR/${pkg_name}.db"
            echo "‚úÖ Backup SUKSES: $pkg_name"
            count=$((count + 1))
        else
            echo "‚ö†Ô∏è  SKIP: $pkg_name (File Cookies tidak ditemukan)"
        fi
    done
    echo "------------------------------------------"
    echo "Selesai! $count database tersimpan di $BACKUP_DIR"
}

# Fungsi 2: Restore Akun (Fix Permissions) [cite: 9, 13, 16]
do_restore() {
    echo "=========================================="
    echo "       MEMULAI PROSES RESTORE...          "
    echo "=========================================="
    if [ ! -d "$BACKUP_DIR" ]; then
        echo "‚ùå Folder backup tidak ditemukan!"
        return 1
    fi

    count=0
    for db_file in "$BACKUP_DIR"/com.roblox.clien*.db; do
        [ -e "$db_file" ] || continue
        pkg_name=$(basename "$db_file" .db)
        target_folder="/data/data/$pkg_name"
        target_path="$target_folder/app_webview/Default/Cookies"
        target_dir_parent="$target_folder/app_webview/Default"

        if [ -d "$target_folder" ]; then
            if [ ! -d "$target_dir_parent" ]; then
                mkdir -p "$target_dir_parent"
                app_uid_folder=$(stat -c "%u:%g" "$target_folder")
                chown -R "$app_uid_folder" "$target_folder/app_webview"
            fi

            cp "$db_file" "$target_path"
            # Perbaikan Izin Akses agar aplikasi bisa membaca database 
            app_uid=$(stat -c "%u:%g" "$target_folder")
            chown "$app_uid" "$target_path"
            chmod 660 "$target_path"
            
            echo "‚úÖ Restore SUKSES: $pkg_name"
            count=$((count + 1))
        else
            echo "‚ùå GAGAL: $pkg_name belum terinstall."
        fi
    done
    echo "------------------------------------------"
    echo "Selesai! $count database dikembalikan."
}

# Fungsi 3: Hapus Semua Aplikasi Clone [cite: 19, 23, 26]
do_uninstall() {
    echo "=========================================="
    echo "       MENGHAPUS APLIKASI CLONE...        "
    echo "=========================================="
    pkgs=$(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":")

    if [ -z "$pkgs" ]; then
        echo "‚ùå Tidak ada aplikasi Roblox Clone yang terinstall."
        return
    fi

    echo "‚ö†Ô∏è  Daftar aplikasi terdeteksi: $pkgs"
    echo -n "‚ùì Yakin hapus SEMUA? (y/n): "
    read confirm

    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        for pkg in $pkgs; do
            echo "‚è≥ Menghapus $pkg..."
            pm uninstall "$pkg" > /dev/null 2>&1
            [ $? -eq 0 ] && echo "   ‚úÖ Terhapus." || echo "   ‚ùå Gagal."
        done
        echo "‚ú® Pembersihan selesai!"
    else
        echo "üö´ Operasi dibatalkan."
    fi
}

# Fungsi 4: AUTO PROCESS (Download -> Install -> Restore) [cite: 28, 29]
do_auto_process() {
    echo "=========================================="
    echo "       PROSES OTOMATIS BERJALAN           "
    echo "=========================================="

    if [ ! -d "$BACKUP_DIR" ]; then
        echo "‚ùå Folder backup tidak ditemukan! Silakan lakukan backup terlebih dahulu."
        return
    fi

    # Cek jumlah backup untuk menentukan jumlah download APK
    total_backup=$(ls "$BACKUP_DIR"/com.roblox.clien*.db 2>/dev/null | wc -l)

    if [ "$total_backup" -eq 0 ]; then
        echo "‚ùå Tidak ada data backup yang tersedia."
        return
    fi

    echo "üì¶ Menyiapkan $total_backup akun untuk dipasang."
    mkdir -p "$DOWNLOAD_DIR"

    for i in $(seq 1 "$total_backup"); do
        echo "------------------------------------------"
        APK_NAME="$i.apk"
        TARGET_URL="$BASE_URL/$APK_NAME"
        SAVE_PATH="$DOWNLOAD_DIR/$APK_NAME"

        # Step 1: Download
        if [ ! -f "$SAVE_PATH" ]; then
            echo "üì• Mengunduh $APK_NAME dari $BASE_URL..."
            wget -q "$TARGET_URL" -O "$SAVE_PATH" || curl -L "$TARGET_URL" -o "$SAVE_PATH"
        else
            echo "‚úÖ $APK_NAME sudah ada di folder download."
        fi

        # Step 2: Install
        if [ -f "$SAVE_PATH" ]; then
            echo "‚è≥ Menginstall $APK_NAME..."
            pm install -r "$SAVE_PATH" > /dev/null 2>&1
            if [ $? -eq 0 ]; then
                echo "‚úÖ Install $APK_NAME Berhasil."
            else
                echo "‚ùå Gagal menginstall $APK_NAME."
            fi
        else
            echo "‚ùå File $APK_NAME tidak ditemukan/gagal unduh."
        fi
    done

    # Step 3: Restore Data
    echo "------------------------------------------"
    echo "üîß Sinkronisasi Cookies ke aplikasi baru..."
    do_restore
    echo "‚ú® SEMUA PROSES SELESAI!"
}

# --- MAIN MENU --- [cite: 27, 28]
check_root

while true; do
    echo ""
    echo "=========================================="
    echo "    ROBLOX CLONE MANAGER v2.3 (ROOT)      "
    echo "=========================================="
    echo "1. Backup Akun (Sekarang)"
    echo "2. Restore Akun (Manual)"
    echo "3. Hapus Semua Aplikasi Clone"
    echo "4. PROSES OTOMATIS (Download+Install+Restore)"
    echo "5. Keluar"
    echo "------------------------------------------"
    echo -n "Pilih menu [1-5]: "
    read choice

    case $choice in
        1) do_backup ;;
        2) do_restore ;;
        3) do_uninstall ;;
        4) do_auto_process ;;
        5) echo "Keluar."; exit 0 ;;
        *) echo "‚ö†Ô∏è Pilihan tidak valid." ;;
    esac
done
