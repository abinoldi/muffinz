-- ======================================================
-- DIPSINEXT: STABLE FISHING (REMFARM LOGIC IMPLEMENTED)
-- Fitur: Exact Remfarm Potato Mode + Stable Anti-Stuck
-- ======================================================

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    RunService = game:GetService("RunService"),
    Lighting = game:GetService("Lighting"),
    VirtualUser = game:GetService("VirtualUser")
}

local lp = Services.Players.LocalPlayer

-- [1] CONFIGURATION
local Config = {
    FishingEnabled = true,
    PotatoMode = true,      -- Wajib True biar lancar seperti Remfarm
    CatchDelay = 0.05       -- Speed klik
}

-- [2] VARIABLES
local FishingState = { IsFishing = false }
local LegitState = { Status = "Idle" }
local FishingThreads = {}
local PotatoLoopThread = nil
local LegitClickThread = nil
local HooksInstalled = false

-- [3] MODULES & REMOTES
local FishingController = require(Services.ReplicatedStorage.Controllers.FishingController)
local VFXControllerModule

-- Coba ambil VFX Module untuk dimatikan (Potato Mode)
pcall(function()
    VFXControllerModule = require(Services.ReplicatedStorage:WaitForChild("Controllers").VFXController)
end)

local function GetRemote(name)
    local path = {"Packages", "_Index", "sleitnick_net@0.2.0", "net"}
    local current = Services.ReplicatedStorage
    for _, child in ipairs(path) do
        current = current:WaitForChild(child, 2)
        if not current then return nil end
    end
    return current:FindFirstChild(name)
end

local RF_UpdateAutoFishingState = GetRemote("RF/UpdateAutoFishingState")

-- ======================================================
-- [IMPLEMENTASI 1] EXACT REMFARM POTATO MODE
-- Logic ini disalin persis dari remfarm (8).txt
-- ======================================================

local function DisableAnimations()
    local character = lp.Character
    if not character then return end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    -- Matikan Animate Script
    local animateScript = character:FindFirstChild("Animate")
    if animateScript and animateScript:IsA("LocalScript") and animateScript.Enabled then 
        animateScript.Enabled = false 
    end
    
    -- Hapus Animator (Persis Remfarm)
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if animator then animator:Destroy() end 
end

local function ApplyExtremePotato()
    -- 1. Matikan VFX Game Controller
    if VFXControllerModule then
        VFXControllerModule.Handle = function(...) return nil end
        if VFXControllerModule.PlayVFX then VFXControllerModule.PlayVFX.Fire = function(...) return nil end end
        local cosmeticFolder = workspace:FindFirstChild("CosmeticFolder")
        if cosmeticFolder then pcall(function() cosmeticFolder:ClearAllChildren() end) end
    end
    
    -- 2. Matikan Cutscene
    pcall(function()
        local CutsceneController = require(Services.ReplicatedStorage:WaitForChild("Controllers"):WaitForChild("CutsceneController"))
        if CutsceneController and CutsceneController.Play then CutsceneController.Play = function() return end end
    end)
    
    DisableAnimations()
    
    -- 3. Matikan Lighting & Terrain
    pcall(function()
        Services.Lighting.GlobalShadows = false
        Services.Lighting.FogEnd = 9e9
        Services.Lighting.Brightness = 0
        if workspace.Terrain then
            workspace.Terrain.WaterWaveSize = 0
            workspace.Terrain.WaterTransparency = 1
            workspace.Terrain.WaterReflectance = 0
        end
    end)
    
    -- 4. Loop Agresif Hapus Part/Effect di Workspace
    for _, v in ipairs(workspace:GetDescendants()) do
        if v:IsA("BasePart") then 
            v.Transparency = 1; v.Reflectance = 0; v.CastShadow = false
        elseif v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Beam") then 
            v:Destroy()
        end
    end
    
    -- 5. Loop Karakter Sendiri
    if lp.Character then
        for _, v in ipairs(lp.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.Transparency = 1; v.Reflectance = 0
            elseif v:IsA("Decal") or v:IsA("Texture") then v:Destroy() end
            if v:IsA("MeshPart") then v.Transparency = 1 end
        end
    end
    
    if setfpscap then pcall(function() setfpscap(30) end) end
end

local function StartPotatoLoop()
    if PotatoLoopThread then return end
    ApplyExtremePotato()
    -- Loop 3 Detik (Persis Remfarm)
    PotatoLoopThread = task.spawn(function() 
        while task.wait(3) do 
            ApplyExtremePotato() 
        end 
    end)
end

-- ======================================================
-- [IMPLEMENTASI 2] EXACT REMFARM FISHING LOGIC
-- Anti-Stuck menggunakan Force Monitor & Thread Management
-- ======================================================

local function SetupLegitHooks()
    if HooksInstalled then return end
    
    local oldStart = FishingController.FishingRodStarted
    local oldStop = FishingController.FishingStopped
    
    -- [HOOK] SAAT MINIGAME MUNCUL
    FishingController.FishingRodStarted = function(self, ...)
        oldStart(self, ...)
        
        if FishingState.IsFishing then
            LegitState.Status = "Reeling"
            
            -- [PENTING] Cancel thread lama sebelum buat baru (Remfarm Logic)
            if LegitClickThread then task.cancel(LegitClickThread) end
            
            LegitClickThread = task.spawn(function()
                while FishingState.IsFishing and LegitState.Status == "Reeling" do
                    FishingController:RequestFishingMinigameClick()
                    task.wait(Config.CatchDelay)
                end
            end)
        end
    end

    -- [HOOK] SAAT MINIGAME SELESAI
    FishingController.FishingStopped = function(self, ...)
        oldStop(self, ...)
        
        if FishingState.IsFishing then
            LegitState.Status = "Casting" -- Ubah status jadi siap lempar
            
            -- [PENTING] Matikan klik thread segera
            if LegitClickThread then 
                task.cancel(LegitClickThread)
                LegitClickThread = nil
            end
        end
    end
    
    HooksInstalled = true
    print("[Dipsinext] Hooks Installed (Stable Remfarm Logic).")
end

-- ANTI-IDLE BIASA (Biar tidak disconnect Roblox)
local function AntiAFK()
    for i, v in pairs(getconnections(lp.Idled)) do
        if v.Disable then v:Disable() end
    end
    task.spawn(function()
        while task.wait(60) do
            Services.VirtualUser:CaptureController()
            Services.VirtualUser:ClickButton2(Vector2.new())
        end
    end)
end

-- FUNGSI UTAMA START
function StartDipsinext()
    if FishingState.IsFishing then return end
    FishingState.IsFishing = true
    
    print("[Dipsinext] Starting Stable Farming...")
    
    -- 1. Jalankan Potato Mode (Jika aktif)
    if Config.PotatoMode then 
        StartPotatoLoop() 
    end
    
    -- 2. Setup Hooks
    SetupLegitHooks()
    LegitState.Status = "Casting" 
    
    -- 3. [ANTI-STUCK UTAMA] FORCE MONITOR LOOP
    -- Logic: Kirim sinyal TRUE ke server setiap 2 detik. 
    -- Ini mencegah server menganggap player 'Walked Away'.
    table.insert(FishingThreads, task.spawn(function()
        while FishingState.IsFishing do
            if RF_UpdateAutoFishingState then
                -- Gunakan pcall seperti Remfarm agar tidak error jika server lag
                pcall(function() RF_UpdateAutoFishingState:InvokeServer(true) end)
            end
            task.wait(2.0)
        end
    end))
    
    -- 4. [SMART RECAST]
    -- Logic: Jika status casting, paksa update server dan reset ke Idle
    table.insert(FishingThreads, task.spawn(function()
        while FishingState.IsFishing do
            task.wait(1)
            if LegitState.Status == "Casting" then
                 if RF_UpdateAutoFishingState then
                     pcall(function() RF_UpdateAutoFishingState:InvokeServer(true) end)
                 end
                 LegitState.Status = "Idle" 
            end
        end
    end))
    
    -- Jalankan Anti-AFK Roblox
    AntiAFK()
end

function StopDipsinext()
    FishingState.IsFishing = false
    LegitState.Status = "Idle"
    
    if RF_UpdateAutoFishingState then 
        pcall(function() RF_UpdateAutoFishingState:InvokeServer(false) end) 
    end
    
    if LegitClickThread then 
        task.cancel(LegitClickThread) 
        LegitClickThread = nil 
    end
    
    if PotatoLoopThread then
        task.cancel(PotatoLoopThread)
        PotatoLoopThread = nil
    end
    
    for _, t in pairs(FishingThreads) do
        if t then task.cancel(t) end
    end
    FishingThreads = {}
    print("[Dipsinext] Stopped.")
end

-- [AUTO START]
StartDipsinext()
