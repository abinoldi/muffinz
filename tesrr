#!/data/data/com.termux/files/usr/bin/bash

# Ultimate Roblox Clone Launcher with Auto-Restart & Monitoring
# Launches ALL clones, monitors, and auto-restarts

echo "========================================"
echo "Roblox Auto-Launcher with Monitor & Restart"
echo "========================================"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check for root/su access
check_root() {
    if command -v su &> /dev/null && su -c "id" | grep -q "uid=0"; then
        echo -e "${GREEN}[‚úì] Root access available${NC}"
        return 0
    else
        echo -e "${RED}[‚úó] Root access NOT available${NC}"
        echo "Some features may not work without root"
        return 1
    fi
}

# ========== CONFIGURATION ==========
DEEP_LINK="roblox://placeID=121864768012064&linkCode=15722060451108192164607998273789"
WAIT_BETWEEN_APPS=8
WAIT_FOR_INPUT=15
WAIT_BETWEEN_CYCLES=7200  # 2 hours in seconds

# ========== MONITORING FUNCTIONS ==========
monitor_processes() {
    echo -e "\n${CYAN}[*] Current Status Monitor${NC}"
    echo "Time: $(date '+%H:%M:%S')"
    
    # Get all Roblox packages
    if command -v su &> /dev/null; then
        PACKAGES=$(su -c "pm list packages | grep -i roblox | cut -d: -f2" 2>/dev/null)
    else
        PACKAGES=$(pm list packages | grep -i roblox | cut -d: -f2)
    fi
    
    if [ -z "$PACKAGES" ]; then
        echo -e "${RED}No Roblox packages found!${NC}"
        return
    fi
    
    echo -e "${YELLOW}Found packages:${NC}"
    echo "$PACKAGES"
    
    # Check running processes
    echo -e "\n${YELLOW}Running processes:${NC}"
    ROBLOX_PIDS=$(find /proc -maxdepth 2 -name "cmdline" -exec grep -l "roblox" {} \; 2>/dev/null | grep -o '[0-9]\+' | sort -n | uniq)
    
    if [ -z "$ROBLOX_PIDS" ]; then
        echo -e "${RED}No Roblox processes running${NC}"
    else
        echo -e "${GREEN}Active PIDs: $ROBLOX_PIDS${NC}"
        echo "Total unique processes: $(echo "$ROBLOX_PIDS" | wc -w)"
        
        # Detailed process info
        for pid in $ROBLOX_PIDS; do
            CMD=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ' | head -c 80)
            NAME=$(cat /proc/$pid/comm 2>/dev/null)
            echo "  PID $pid: $NAME - ${CMD:0:60}..."
        done
    fi
    
    # Memory usage
    echo -e "\n${YELLOW}Memory usage:${NC}"
    for pkg in $PACKAGES; do
        if command -v su &> /dev/null; then
            MEM=$(su -c "dumpsys meminfo $pkg 2>/dev/null | grep -E 'TOTAL.*PSS|TOTAL'" | head -1)
        else
            MEM=$(dumpsys meminfo $pkg 2>/dev/null | grep -E 'TOTAL.*PSS|TOTAL' | head -1)
        fi
        if [ ! -z "$MEM" ]; then
            echo "  $pkg: $MEM"
        fi
    done
}

# ========== LAUNCH FUNCTION ==========
launch_all_clones() {
    echo -e "\n${GREEN}[+] Launching ALL Roblox Clones${NC}"
    
    # Get all packages
    if command -v su &> /dev/null; then
        PACKAGES=$(su -c "pm list packages | grep -i roblox | cut -d: -f2" 2>/dev/null)
    else
        PACKAGES=$(pm list packages | grep -i roblox | cut -d: -f2)
    fi
    
    if [ -z "$PACKAGES" ]; then
        echo -e "${RED}No Roblox packages found to launch!${NC}"
        return 0
    fi
    
    TOTAL_PACKAGES=$(echo "$PACKAGES" | wc -l)
    echo "Found $TOTAL_PACKAGES Roblox clone(s)"
    
    COUNT=0
    for pkg in $PACKAGES; do
        COUNT=$((COUNT + 1))
        echo -e "\n${BLUE}[$COUNT/$TOTAL_PACKAGES] Launching $pkg${NC}"
        
        # Launch the app
        if command -v su &> /dev/null; then
            su -c "am start -n $pkg/com.roblox.client.ActivityProtocolLaunch -a android.intent.action.VIEW -d '$DEEP_LINK'" 2>/dev/null
        else
            am start -n $pkg/com.roblox.client.ActivityProtocolLaunch -a android.intent.action.VIEW -d "$DEEP_LINK" 2>/dev/null
        fi
        
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}[‚úì] Launch command sent${NC}"
        else
            echo -e "${RED}[‚úó] Failed to launch $pkg${NC}"
        fi
        
        # Wait between apps
        if [ $COUNT -lt $TOTAL_PACKAGES ]; then
            echo -e "${YELLOW}Waiting ${WAIT_BETWEEN_APPS}s before next app...${NC}"
            sleep $WAIT_BETWEEN_APPS
        fi
    done
    
    echo -e "\n${GREEN}[‚úì] All clones launched${NC}"
    return $COUNT
}

# ========== RESTART LOOP ==========
restart_loop() {
    CYCLE=1
    
    while true; do
        echo -e "\n${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo -e "${PURPLE}[ CYCLE $CYCLE ] Starting at $(date)${NC}"
        echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        
        # ========== STOP PHASE ==========
        echo -e "\n${RED}[üõë] Stopping all Roblox clones...${NC}"
        STOP_COUNT=0
        
        if command -v su &> /dev/null; then
            PACKAGES=$(su -c "pm list packages | grep -i roblox | cut -d: -f2" 2>/dev/null)
            for pkg in $PACKAGES; do
                su -c "am force-stop $pkg" 2>/dev/null
                if [ $? -eq 0 ]; then
                    STOP_COUNT=$((STOP_COUNT + 1))
                    echo "  Stopped: $pkg"
                fi
            done
        else
            PACKAGES=$(pm list packages | grep -i roblox | cut -d: -f2)
            for pkg in $PACKAGES; do
                am force-stop $pkg 2>/dev/null
                if [ $? -eq 0 ]; then
                    STOP_COUNT=$((STOP_COUNT + 1))
                    echo "  Stopped: $pkg"
                fi
            done
        fi
        
        echo -e "${GREEN}[‚úì] Stopped $STOP_COUNT package(s)${NC}"
        sleep 3
        
        # ========== LAUNCH PHASE ==========
        echo -e "\n${GREEN}[üöÄ] Starting Roblox apps...${NC}"
        LAUNCHED_COUNT=0
        
        if command -v su &> /dev/null; then
            PACKAGES=$(su -c "pm list packages | grep -i roblox | cut -d: -f2" 2>/dev/null)
            TOTAL=$(echo "$PACKAGES" | wc -l)
            
            for pkg in $PACKAGES; do
                LAUNCHED_COUNT=$((LAUNCHED_COUNT + 1))
                echo -e "\n${BLUE}[$LAUNCHED_COUNT/$TOTAL] Launching $pkg...${NC}"
                
                # Launch with deep link
                su -c "am start -n $pkg/com.roblox.client.ActivityProtocolLaunch -a android.intent.action.VIEW -d '$DEEP_LINK'" 2>/dev/null
                
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}[‚úì] Launched${NC}"
                else
                    echo -e "${RED}[‚úó] Failed${NC}"
                fi
                
                # Wait before sending DPAD key
                echo -e "${YELLOW}Waiting ${WAIT_BETWEEN_APPS}s...${NC}"
                sleep $WAIT_BETWEEN_APPS
                
                # Send DPAD_CENTER key (Enter key)
                if command -v su &> /dev/null; then
                    su -c "input keyevent KEYCODE_DPAD_CENTER" 2>/dev/null
                    echo -e "${CYAN}[‚Üí] Sent ENTER key${NC}"
                fi
                
                # Wait for app initialization
                echo -e "${YELLOW}Waiting ${WAIT_FOR_INPUT}s for initialization...${NC}"
                sleep $WAIT_FOR_INPUT
            done
        else
            PACKAGES=$(pm list packages | grep -i roblox | cut -d: -f2)
            TOTAL=$(echo "$PACKAGES" | wc -l)
            
            for pkg in $PACKAGES; do
                LAUNCHED_COUNT=$((LAUNCHED_COUNT + 1))
                echo -e "\n${BLUE}[$LAUNCHED_COUNT/$TOTAL] Launching $pkg...${NC}"
                
                # Launch with deep link
                am start -n $pkg/com.roblox.client.ActivityProtocolLaunch -a android.intent.action.VIEW -d "$DEEP_LINK" 2>/dev/null
                
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}[‚úì] Launched${NC}"
                else
                    echo -e "${RED}[‚úó] Failed${NC}"
                fi
                
                # Wait before sending DPAD key
                echo -e "${YELLOW}Waiting ${WAIT_BETWEEN_APPS}s...${NC}"
                sleep $WAIT_BETWEEN_APPS
                
                # Send DPAD_CENTER key if we have input access
                if [ -f /data/data/com.termux/files/home/.termux/termux.properties ]; then
                    input keyevent KEYCODE_DPAD_CENTER 2>/dev/null && echo -e "${CYAN}[‚Üí] Sent ENTER key${NC}"
                fi
                
                # Wait for app initialization
                echo -e "${YELLOW}Waiting ${WAIT_FOR_INPUT}s for initialization...${NC}"
                sleep $WAIT_FOR_INPUT
            done
        fi
        
        echo -e "\n${GREEN}[‚úì] Launched $LAUNCHED_COUNT/$TOTAL package(s)${NC}"
        
        # ========== MONITORING PHASE ==========
        echo -e "\n${CYAN}[üìä] Running detailed monitor...${NC}"
        monitor_processes
        
        # ========== WAIT PHASE ==========
        echo -e "\n${PURPLE}[‚è≥] Waiting 2 hours until next cycle...${NC}"
        echo "Next restart at: $(date -d "+2 hours" '+%H:%M:%S')"
        
        # Countdown display
        for ((i=1; i<=120; i++)); do  # 120 minutes = 2 hours
            for ((j=0; j<60; j+=10)); do  # Update every 10 seconds
                echo -ne "\rTime until next cycle: $((119 - i + 1))h $((59 - j))m $(printf "%02d" $((59 - (j/10)*10)))s remaining"
                sleep 10
            done
        done
        
        CYCLE=$((CYCLE + 1))
    done
}

# ========== MAIN MENU ==========
echo "Select mode:"
echo "1. Launch once with monitoring"
echo "2. Auto-restart loop (2-hour cycles)"
echo "3. Just monitor current status"
echo -n "Choose (1-3): "
read CHOICE

case $CHOICE in
    1)
        echo -e "${GREEN}[*] Single launch mode${NC}"
        check_root
        launch_all_clones
        echo -e "\n${YELLOW}[*] Waiting 40s for initialization...${NC}"
        sleep 40
        monitor_processes
        ;;
    2)
        echo -e "${GREEN}[*] Auto-restart loop mode${NC}"
        echo "Each cycle: Stop ‚Üí Launch ‚Üí Monitor ‚Üí Wait 2 hours"
        check_root
        restart_loop
        ;;
    3)
        echo -e "${GREEN}[*] Monitor-only mode${NC}"
        monitor_processes
        ;;
    *)
        echo -e "${RED}Invalid choice${NC}"
        exit 1
        ;;
esac

echo -e "\n${GREEN}[‚úì] Script completed${NC}"
