#!/system/bin/sh

# ==========================================================
# ROBLOX INJECTOR v8.0 (CLONE DB STRUCTURE & RESTORE)
# ==========================================================

TERMUX_SQLITE="/data/data/com.termux/files/usr/bin/sqlite3"
TMP_SQLITE="/data/local/tmp/sqlite3_exec"
TEMP_DB_DIR="/data/local/tmp/rbx_temp_cookies"
COOKIE_QUEUE="/data/local/tmp/rbx_queue.txt"

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        exit 1
    fi
}

prepare_env() {
    # 1. Siapkan Sqlite
    rm -f "$TMP_SQLITE"
    if [ -f "$TERMUX_SQLITE" ]; then
        cp "$TERMUX_SQLITE" "$TMP_SQLITE"
        chmod 755 "$TMP_SQLITE"
        SQLITE_BIN="$TMP_SQLITE"
    else
        SQLITE_BIN=$(which sqlite3)
    fi

    if [ -z "$SQLITE_BIN" ] || [ ! -x "$SQLITE_BIN" ]; then
        echo "‚ùå sqlite3 tidak ditemukan. Wajib install di Termux."
        exit 1
    fi

    # 2. Siapkan Folder Temp
    rm -rf "$TEMP_DB_DIR"
    mkdir -p "$TEMP_DB_DIR"
    chmod 777 "$TEMP_DB_DIR"
}

# --- PHASE 1: GENERATE DB (SESUAI STRUKTUR FILE ANDA) ---
generate_db_file() {
    local index="$1"
    local raw_cookie="$2"
    local db_path="$TEMP_DB_DIR/cookie_$index.db"

    # Hapus file lama
    rm -f "$db_path"

    # 1. CREATE TABLE (Struktur EXACT dari Cookies_Salinan.db Anda)
    "$SQLITE_BIN" "$db_path" "CREATE TABLE cookies(creation_utc INTEGER NOT NULL, top_frame_site_key TEXT NOT NULL, host_key TEXT NOT NULL, name TEXT NOT NULL, value TEXT NOT NULL, encrypted_value BLOB DEFAULT '', path TEXT NOT NULL, expires_utc INTEGER NOT NULL, is_secure INTEGER NOT NULL, is_httponly INTEGER NOT NULL, last_access_utc INTEGER NOT NULL, has_expires INTEGER NOT NULL DEFAULT 1, is_persistent INTEGER NOT NULL DEFAULT 1, priority INTEGER NOT NULL DEFAULT 1, samesite INTEGER NOT NULL DEFAULT -1, source_scheme INTEGER NOT NULL DEFAULT 0, source_port INTEGER NOT NULL DEFAULT -1, is_same_party INTEGER NOT NULL DEFAULT 0, UNIQUE (top_frame_site_key, host_key, name, path));"

    # 2. CREATE META (Opsional tapi bagus agar persis asli)
    "$SQLITE_BIN" "$db_path" "CREATE TABLE meta(key LONGVARCHAR NOT NULL UNIQUE PRIMARY KEY, value LONGVARCHAR);"
    "$SQLITE_BIN" "$db_path" "INSERT INTO meta(key, value) VALUES('version','15');"
    "$SQLITE_BIN" "$db_path" "INSERT INTO meta(key, value) VALUES('last_compatible_version','15');"

    # 3. INSERT COOKIE (Mengisi SEMUA kolom agar tidak error constraint)
    # Perhatikan urutan kolom harus sesuai CREATE TABLE di atas
    "$SQLITE_BIN" "$db_path" "INSERT INTO cookies (creation_utc, top_frame_site_key, host_key, name, value, encrypted_value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme, source_port, is_same_party) VALUES ((strftime('%s','now')*1000000), '', '.roblox.com', '.ROBLOSECURITY', '$raw_cookie', '', '/', 253402300799000000, 1, 1, (strftime('%s','now')*1000000), 1, 1, 1, -1, 1, -1, 0);"

    if [ -f "$db_path" ]; then
        echo "   ‚úÖ Generated DB #$index (Struktur Valid)"
    else
        echo "   ‚ùå Gagal membuat DB #$index"
    fi
}

# --- PHASE 2: RESTORE TO APP (Metode Copy Paste) ---
restore_db() {
    local pkg_name="$1"
    local source_db="$2"
    
    local target_root="/data/data/$pkg_name"
    # Target FOLDER (Parent)
    local target_folder="$target_root/app_webview/Default"
    # Target FILE
    local target_file="$target_folder/Cookies"

    echo "------------------------------------------"
    echo "üîÑ Target: $pkg_name"

    # 1. Force Stop
    am force-stop "$pkg_name" > /dev/null 2>&1

    # 2. HAPUS FILE LAMA (PENTING!)
    if [ -e "$target_file" ]; then
        rm -f "$target_file"
    fi
    # Hapus juga jika ada folder nyasar dengan nama Cookies
    if [ -d "$target_file" ]; then
        rm -rf "$target_file"
    fi

    # 3. BUAT FOLDER (Jika belum ada)
    if [ ! -d "$target_folder" ]; then
        mkdir -p "$target_folder"
        # Fix owner folder parent
        local uid_awal=$(stat -c "%u:%g" "$target_root")
        chown -R "$uid_awal" "$target_root/app_webview"
    fi

    # 4. COPY DATABASE BARU
    echo "   üì• Menyalin database..."
    cp "$source_db" "$target_file"

    if [ -f "$target_file" ]; then
        # 5. FIX PERMISSION (Paling Penting)
        local app_uid=$(stat -c "%u:%g" "$target_root")
        
        # Ubah pemilik folder recursive biar aman
        chown -R "$app_uid" "$target_root/app_webview"
        
        # Ubah permission file database spesifik
        chmod 660 "$target_file"
        
        echo "   ‚ú® SUKSES TERPASANG"
    else
        echo "   ‚ùå Gagal menyalin file."
    fi
}

do_main_process() {
    echo "=========================================="
    echo "   ROBLOX INJECTOR v8.0 (CLONE METHOD)    "
    echo "=========================================="
    prepare_env
    
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))
    total_apps=${#pkgs[@]}
    
    if [ $total_apps -eq 0 ]; then
        echo "‚ùå Tidak ada aplikasi Roblox Clone."
        return
    fi

    # Input Cookie
    echo "üì± Terdeteksi $total_apps aplikasi."
    echo "üìù INPUT COOKIE (Ketik 'done' selesai)"
    echo "------------------------------------------"
    
    rm -f "$COOKIE_QUEUE"
    i=0
    while true; do
        display_num=$((i + 1))
        echo -n "[$display_num] Cookie: "
        read -r input_cookie

        if [ "$input_cookie" = "done" ]; then break; fi
        if [ -n "$input_cookie" ]; then
            echo "$input_cookie" >> "$COOKIE_QUEUE"
            i=$((i + 1))
        fi
        if [ $i -ge $total_apps ]; then echo "‚ö†Ô∏è  Slot penuh."; break; fi
    done
    total_cookies=$i

    # Phase 1: Generate
    echo "------------------------------------------"
    echo "üî® [1/2] Membuat Database (Struktur Asli)..."
    line_num=1
    while [ $line_num -le $total_cookies ]; do
        current_cookie=$(sed "${line_num}q;d" "$COOKIE_QUEUE")
        generate_db_file "$line_num" "$current_cookie"
        line_num=$((line_num + 1))
    done

    # Phase 2: Restore
    echo "------------------------------------------"
    echo "üöÄ [2/2] Mengirim ke Aplikasi..."
    idx=0
    for pkg in "${pkgs[@]}"; do
        db_num=$((idx + 1))
        source_db="$TEMP_DB_DIR/cookie_$db_num.db"

        if [ ! -f "$source_db" ]; then break; fi

        restore_db "$pkg" "$source_db"
        idx=$((idx + 1))
    done

    # Clean up
    rm -rf "$TEMP_DB_DIR"
    rm -f "$COOKIE_QUEUE"
    echo "------------------------------------------"
    echo "‚ú® SELESAI! Silakan buka aplikasinya."
}

check_root
do_main_process
