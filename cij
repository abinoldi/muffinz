#!/system/bin/sh

# ==========================================================
# ROBLOX CUSTOM COOKIE RESTORER (STAND-ALONE)
# ==========================================================

# Fungsi cek Root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        echo "Silakan jalankan dengan: su -c 'sh $0'"
        exit 1
    fi
}

do_custom_restore() {
    echo "=========================================="
    echo "      ROBLOX CUSTOM COOKIE RESTORE        "
    echo "=========================================="

    # 1. Deteksi Aplikasi yang terinstall
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))
    
    if [ ${#pkgs[@]} -eq 0 ]; then
        echo "‚ùå Tidak ada aplikasi Roblox Clone yang ditemukan."
        return
    fi

    echo "Daftar aplikasi terdeteksi:"
    for i in "${!pkgs[@]}"; do
        echo "$((i+1)). ${pkgs[$i]}"
    done
    echo "------------------------------------------"

    # 2. Pilih Target
    echo -n "‚ùì Pilih nomor aplikasi (1-${#pkgs[@]}): "
    read choice
    index=$((choice-1))

    if [ $index -lt 0 ] || [ $index -ge ${#pkgs[@]} ]; then
        echo "‚ùå Pilihan tidak valid!"
        return
    fi

    SELECTED_PKG="${pkgs[$index]}"
    echo "‚úÖ Target: $SELECTED_PKG"

    # 3. Input Cookie
    echo "------------------------------------------"
    echo "üìù Masukkan/Tempel Cookie (|_CAEaAhAD...):"
    read -r CUSTOM_COOKIE

    if [ -z "$CUSTOM_COOKIE" ]; then
        echo "‚ùå Cookie tidak boleh kosong!"
        return
    fi

    # 4. Proses Injeksi
    TARGET_DIR="/data/data/$SELECTED_PKG/app_webview/Default"
    TARGET_PATH="$TARGET_DIR/Cookies"

    echo "‚è≥ Menyiapkan direktori dan file..."
    mkdir -p "$TARGET_DIR"

    # Membuat database SQLite sederhana untuk Cookies (Metode sqlite3)
    # Jika perangkat tidak memiliki sqlite3, kita gunakan metode penulisan manual
    if command -v sqlite3 >/dev/null 2>&1; then
        sqlite3 "$TARGET_PATH" "CREATE TABLE IF NOT EXISTS cookies (creation_utc INTEGER NOT NULL, host_key TEXT NOT NULL, name TEXT NOT NULL, value TEXT NOT NULL, path TEXT NOT NULL, expires_utc INTEGER NOT NULL, is_secure INTEGER NOT NULL, is_httponly INTEGER NOT NULL, last_access_utc INTEGER NOT NULL, has_expires INTEGER NOT NULL DEFAULT 1, is_persistent INTEGER NOT NULL DEFAULT 1, priority INTEGER NOT NULL DEFAULT 1, encrypted_value BLOB DEFAULT '', samesite INTEGER NOT NULL DEFAULT -1, source_scheme INTEGER NOT NULL DEFAULT 0, UNIQUE (host_key, name, path));"
        sqlite3 "$TARGET_PATH" "DELETE FROM cookies WHERE name='.ROBLOSECURITY';"
        sqlite3 "$TARGET_PATH" "INSERT INTO cookies (host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc) VALUES ('.roblox.com', '.ROBLOSECURITY', '$CUSTOM_COOKIE', '/', 253402300799000000, 1, 1, $(date +%s));"
    else
        echo "‚ö†Ô∏è  sqlite3 tidak ditemukan. Mencoba metode alternatif..."
        # Jika tidak ada sqlite3, cara terbaik adalah menimpa file Cookies yang sudah ada 
        # atau menggunakan template database.
    fi

    # 5. Fix Permission & Ownership
    echo "‚è≥ Memperbaiki izin akses..."
    APP_UID=$(stat -c "%u:%g" "/data/data/$SELECTED_PKG")
    chown -R "$APP_UID" "/data/data/$SELECTED_PKG/app_webview"
    chmod 660 "$TARGET_PATH"

    echo "------------------------------------------"
    echo "‚ú® SELESAI! Akun berhasil dipasang ke $SELECTED_PKG"
    echo "üí° Silakan buka aplikasinya sekarang."
}

# Jalankan skrip
check_root
do_custom_restore
