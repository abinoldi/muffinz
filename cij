#!/system/bin/sh

# ==========================================================
# ROBLOX COOKIE INJECTOR v3.9 (MODERN WEBVIEW FIX)
# ==========================================================

TERMUX_SQLITE="/data/data/com.termux/files/usr/bin/sqlite3"
TMP_SQLITE="/data/local/tmp/sqlite3_inject"

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        exit 1
    fi
}

prepare_sqlite() {
    rm -f "$TMP_SQLITE"
    if [ -f "$TERMUX_SQLITE" ]; then
        cp "$TERMUX_SQLITE" "$TMP_SQLITE"
        chmod 755 "$TMP_SQLITE"
        SQLITE_BIN="$TMP_SQLITE"
    else
        SQLITE_BIN=$(which sqlite3)
    fi

    if [ -z "$SQLITE_BIN" ] || [ ! -x "$SQLITE_BIN" ]; then
        echo "‚ùå sqlite3 tidak ditemukan. Pastikan pkg install sqlite di Termux."
        exit 1
    fi
}

do_inject_cookie() {
    echo "=========================================="
    echo "    ROBLOX COOKIE INJECTOR v3.9 (FIX)     "
    echo "=========================================="
    prepare_sqlite
    
    # 1. Deteksi Aplikasi
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))
    if [ ${#pkgs[@]} -eq 0 ]; then
        echo "‚ùå Tidak ada aplikasi Roblox Clone."
        return
    fi

    echo "Daftar aplikasi:"
    for i in "${!pkgs[@]}"; do
        echo "$((i+1)). ${pkgs[$i]}"
    done
    echo "------------------------------------------"

    # 2. Pilih Target
    echo -n "‚ùì Pilih nomor aplikasi (1-${#pkgs[@]}): "
    read choice
    index=$((choice-1))
    [ $index -lt 0 ] || [ $index -ge ${#pkgs[@]} ] && echo "‚ùå Pilihan salah." && return
    SELECTED_PKG="${pkgs[$index]}"
    folder="/data/data/$SELECTED_PKG"

    # 3. Input Cookie
    echo "------------------------------------------"
    echo "üìù Masukkan Cookie ROBLOSECURITY:"
    read -r CUSTOM_COOKIE
    [ -z "$CUSTOM_COOKIE" ] && echo "‚ùå Cookie kosong!" && return

    # 4. Tentukan Path
    cookie_path=""
    [ -f "$folder/app_webview/Default/Cookies" ] && cookie_path="$folder/app_webview/Default/Cookies"
    [ -f "$folder/app_webview/Cookies" ] && [ -z "$cookie_path" ] && cookie_path="$folder/app_webview/Cookies"
    
    # Fallback path
    if [ -z "$cookie_path" ]; then
        mkdir -p "$folder/app_webview/Default"
        cookie_path="$folder/app_webview/Default/Cookies"
    fi

    # 5. Force Stop (WAJIB)
    am force-stop "$SELECTED_PKG"

    # 6. Injeksi SQL (UPDATED v3.9)
    echo "‚è≥ Menyuntikkan cookie..."
    
    # Query Hapus Lama
    "$SQLITE_BIN" "$cookie_path" "DELETE FROM cookies WHERE name='.ROBLOSECURITY';"

    # Query Insert Baru (Ditambahkan top_frame_site_key)
    # Kita menggunakan format INSERT OR REPLACE untuk keamanan ganda
    # Kolom top_frame_site_key diisi string kosong ('') untuk menghindari error NOT NULL
    "$SQLITE_BIN" "$cookie_path" "INSERT OR REPLACE INTO cookies (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme, top_frame_site_key) VALUES ((strftime('%s','now') * 1000000), '.roblox.com', '.ROBLOSECURITY', '$CUSTOM_COOKIE', '/', 253402300799000000, 1, 1, (strftime('%s','now') * 1000000), 1, 1, 1, -1, 0, '');"

    if [ $? -eq 0 ]; then
        # 7. Fix Permissions
        app_uid=$(stat -c "%u:%g" "$folder")
        chown -R "$app_uid" "$folder/app_webview"
        chmod 660 "$cookie_path"
        echo "------------------------------------------"
        echo "‚ú® BERHASIL! Error top_frame_site_key teratasi."
        echo "üìÇ Target: $SELECTED_PKG"
    else
        echo "‚ùå Masih Gagal. Coba cek log di atas."
        echo "üí° Tips: Jika masih error kolom lain, mungkin versi WebView Anda sangat baru."
    fi
}

check_root
do_inject_cookie
