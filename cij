#!/system/bin/sh

# ==========================================================
# ROBLOX MASS INJECTOR v4.4 (DELAYED 30s)
# ==========================================================

TERMUX_SQLITE="/data/data/com.termux/files/usr/bin/sqlite3"
TMP_SQLITE="/data/local/tmp/sqlite3_inject"
COOKIE_QUEUE="/data/local/tmp/rbx_cookie_queue.txt"

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        exit 1
    fi
}

prepare_sqlite() {
    rm -f "$TMP_SQLITE"
    if [ -f "$TERMUX_SQLITE" ]; then
        cp "$TERMUX_SQLITE" "$TMP_SQLITE"
        chmod 755 "$TMP_SQLITE"
        SQLITE_BIN="$TMP_SQLITE"
    else
        SQLITE_BIN=$(which sqlite3)
    fi

    if [ -z "$SQLITE_BIN" ] || [ ! -x "$SQLITE_BIN" ]; then
        echo "‚ùå sqlite3 tidak ditemukan. Pastikan pkg install sqlite di Termux."
        exit 1
    fi
}

# --- LOGIKA INJEKSI TUNGGAL (CORE v3.9) ---
inject_single_step() {
    local TARGET_PKG="$1"
    local TARGET_COOKIE="$2"
    local folder="/data/data/$TARGET_PKG"

    echo "------------------------------------------"
    echo "üîÑ Memproses: $TARGET_PKG"
    
    # 1. Force Stop (Sesuai Permintaan)
    echo "   üõë Mematikan aplikasi..."
    am force-stop "$TARGET_PKG" > /dev/null 2>&1
    sleep 1

    # 2. Setup Path
    local cookie_path=""
    [ -f "$folder/app_webview/Default/Cookies" ] && cookie_path="$folder/app_webview/Default/Cookies"
    [ -f "$folder/app_webview/Cookies" ] && [ -z "$cookie_path" ] && cookie_path="$folder/app_webview/Cookies"
    
    if [ -z "$cookie_path" ]; then
        mkdir -p "$folder/app_webview/Default"
        cookie_path="$folder/app_webview/Default/Cookies"
    fi

    # 3. Eksekusi SQL (Create -> Delete -> Insert)
    echo "   üíâ Menyuntikkan database..."
    
    # Create Table (Agar tidak error "no such table")
    "$SQLITE_BIN" "$cookie_path" "CREATE TABLE IF NOT EXISTS cookies (creation_utc INTEGER NOT NULL, host_key TEXT NOT NULL, name TEXT NOT NULL, value TEXT NOT NULL, path TEXT NOT NULL, expires_utc INTEGER NOT NULL, is_secure INTEGER NOT NULL, is_httponly INTEGER NOT NULL, last_access_utc INTEGER NOT NULL, has_expires INTEGER NOT NULL DEFAULT 1, is_persistent INTEGER NOT NULL DEFAULT 1, priority INTEGER NOT NULL DEFAULT 1, encrypted_value BLOB DEFAULT '', samesite INTEGER NOT NULL DEFAULT -1, source_scheme INTEGER NOT NULL DEFAULT 0, top_frame_site_key TEXT NOT NULL DEFAULT '', UNIQUE (host_key, name, path));"

    # Delete Old
    "$SQLITE_BIN" "$cookie_path" "DELETE FROM cookies WHERE name='.ROBLOSECURITY';"

    # Insert New (Logika v3.9)
    "$SQLITE_BIN" "$cookie_path" "INSERT OR REPLACE INTO cookies (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc, has_expires, is_persistent, priority, samesite, source_scheme, top_frame_site_key) VALUES ((strftime('%s','now') * 1000000), '.roblox.com', '.ROBLOSECURITY', '$TARGET_COOKIE', '/', 253402300799000000, 1, 1, (strftime('%s','now') * 1000000), 1, 1, 1, -1, 0, '');"

    if [ $? -eq 0 ]; then
        # 4. Fix Permission
        local app_uid=$(stat -c "%u:%g" "$folder")
        chown -R "$app_uid" "$folder/app_webview"
        chmod 660 "$cookie_path"
        echo "   ‚úÖ SUKSES TERPASANG!"
        return 0
    else
        echo "   ‚ùå GAGAL (Error SQL)"
        return 1
    fi
}

do_delayed_process() {
    echo "=========================================="
    echo "    ROBLOX INJECTOR (DELAY 30s MODE)      "
    echo "=========================================="
    prepare_sqlite
    
    # Reset Queue
    rm -f "$COOKIE_QUEUE"
    touch "$COOKIE_QUEUE"

    # Deteksi App
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))
    total_apps=${#pkgs[@]}
    
    if [ $total_apps -eq 0 ]; then
        echo "‚ùå Tidak ada aplikasi Roblox Clone."
        return
    fi

    echo "üì± Ditemukan $total_apps aplikasi."
    echo "üìù INPUT COOKIE (Ketik 'done' untuk mulai)"
    echo "------------------------------------------"

    # Loop Input
    i=0
    while true; do
        display_num=$((i + 1))
        echo -n "[$display_num] Cookie: "
        read -r input_cookie

        if [ "$input_cookie" = "done" ]; then
            break
        fi

        if [ -n "$input_cookie" ]; then
            echo "$input_cookie" >> "$COOKIE_QUEUE"
            i=$((i + 1))
        fi
        
        if [ $i -ge $total_apps ]; then
            echo "‚ö†Ô∏è  Slot penuh. Memulai proses..."
            break
        fi
    done

    echo "=========================================="
    echo "üöÄ MEMULAI PROSES SATU PER SATU..."
    echo "=========================================="

    # Loop Eksekusi dengan Delay
    line_num=1
    for pkg in "${pkgs[@]}"; do
        # Baca cookie baris ke-N
        current_cookie=$(sed "${line_num}q;d" "$COOKIE_QUEUE")
        
        if [ -z "$current_cookie" ]; then
            echo "‚ÑπÔ∏è  Cookie habis. Berhenti."
            break
        fi

        # Jalankan Injeksi
        inject_single_step "$pkg" "$current_cookie"
        
        # Cek apakah ini antrian terakhir
        # (Kita hitung sisa baris di file)
        remaining=$(wc -l < "$COOKIE_QUEUE")
        if [ $line_num -lt $i ]; then
            echo "‚è≥ Menunggu 30 detik sebelum lanjut..."
            # Countdown sederhana
            sleep 30
        else
            echo "‚ú® Semua proses selesai!"
        fi
        
        line_num=$((line_num + 1))
    done

    rm -f "$COOKIE_QUEUE"
}

check_root
do_delayed_process
