#!/system/bin/sh

# ==========================================================
# ROBLOX CUSTOM COOKIE RESTORER (v3.0 - SMART PATH)
# ==========================================================

# Fungsi Mencari Lokasi sqlite3 secara otomatis
find_sqlite() {
    # Cek lokasi umum di Android
    paths="/system/bin/sqlite3 /system/xbin/sqlite3 /data/adb/magisk/sqlite3 /data/data/com.termux/files/usr/bin/sqlite3"
    
    for p in $paths; do
        if [ -f "$p" ]; then
            SQLITE_BIN="$p"
            return 0
        fi
    done

    # Jika tidak ketemu di folder umum, coba perintah 'which'
    SQLITE_BIN=$(which sqlite3)
    
    if [ -z "$SQLITE_BIN" ]; then
        echo "‚ùå sqlite3 tetap tidak ditemukan secara otomatis."
        echo -n "üëâ Masukkan path manual (misal: /sdcard/sqlite3): "
        read manual_path
        if [ -f "$manual_path" ]; then
            SQLITE_BIN="$manual_path"
        else
            echo "‚ùå File tidak valid. Keluar."
            exit 1
        fi
    fi
}

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå Script ini MEMBUTUHKAN akses Root!"
        exit 1
    fi
}

do_custom_restore() {
    echo "=========================================="
    echo "      ROBLOX CUSTOM COOKIE RESTORE        "
    echo "=========================================="

    # Cari sqlite3 dulu
    find_sqlite
    echo "‚úÖ Menggunakan sqlite3 dari: $SQLITE_BIN"

    # 1. Deteksi Aplikasi
    pkgs=($(pm list packages | grep "com.roblox.clien" | cut -f 2 -d ":"))
    if [ ${#pkgs[@]} -eq 0 ]; then
        echo "‚ùå Tidak ada aplikasi Roblox Clone."
        return
    fi

    echo "Daftar aplikasi terdeteksi:"
    for i in "${!pkgs[@]}"; do
        echo "$((i+1)). ${pkgs[$i]}"
    done
    echo "------------------------------------------"

    # 2. Pilih Target
    echo -n "‚ùì Pilih nomor aplikasi (1-${#pkgs[@]}): "
    read choice
    index=$((choice-1))
    [ $index -lt 0 ] || [ $index -ge ${#pkgs[@]} ] && echo "‚ùå Pilihan salah." && return

    SELECTED_PKG="${pkgs[$index]}"
    folder="/data/data/$SELECTED_PKG"
    echo "‚úÖ Target: $SELECTED_PKG"

    # 3. Deteksi Cookie Path (Gunakan logika yang Anda berikan)
    cookie_path=""
    [ -f "$folder/app_webview/Default/Cookies" ] && cookie_path="$folder/app_webview/Default/Cookies"
    [ -f "$folder/app_webview/Cookies" ] && [ -z "$cookie_path" ] && cookie_path="$folder/app_webview/Cookies"

    # Fallback jika folder baru dibuat
    if [ -z "$cookie_path" ]; then
        mkdir -p "$folder/app_webview/Default"
        cookie_path="$folder/app_webview/Default/Cookies"
    fi

    # 4. Input Cookie
    echo "------------------------------------------"
    echo "üìù Masukkan/Tempel Cookie ROBLOSECURITY:"
    read -r CUSTOM_COOKIE
    [ -z "$CUSTOM_COOKIE" ] && echo "‚ùå Kosong." && return

    # 5. Injeksi Cookie
    echo "‚è≥ Menyuntikkan cookie..."
    
    # Inisialisasi tabel jika file baru
    "$SQLITE_BIN" "$cookie_path" "CREATE TABLE IF NOT EXISTS cookies (creation_utc INTEGER NOT NULL, host_key TEXT NOT NULL, name TEXT NOT NULL, value TEXT NOT NULL, path TEXT NOT NULL, expires_utc INTEGER NOT NULL, is_secure INTEGER NOT NULL, is_httponly INTEGER NOT NULL, last_access_utc INTEGER NOT NULL, has_expires INTEGER NOT NULL DEFAULT 1, is_persistent INTEGER NOT NULL DEFAULT 1, priority INTEGER NOT NULL DEFAULT 1, encrypted_value BLOB DEFAULT '', samesite INTEGER NOT NULL DEFAULT -1, source_scheme INTEGER NOT NULL DEFAULT 0, UNIQUE (host_key, name, path));"
    
    # Hapus lama & Masukkan baru
    "$SQLITE_BIN" "$cookie_path" "DELETE FROM cookies WHERE name='.ROBLOSECURITY';"
    "$SQLITE_BIN" "$cookie_path" "INSERT INTO cookies (host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc) VALUES ('.roblox.com', '.ROBLOSECURITY', '$CUSTOM_COOKIE', '/', 253402300799000000, 1, 1, $(date +%s));"

    # 6. Fix Permissions
    app_uid=$(stat -c "%u:%g" "$folder")
    chown -R "$app_uid" "$folder/app_webview"
    chmod 660 "$cookie_path"

    echo "------------------------------------------"
    echo "‚ú® BERHASIL dipasang ke $SELECTED_PKG"
}

check_root
do_custom_restore
